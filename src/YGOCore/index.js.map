{"version":3,"file":"index.js","sources":["../src/commands/BaseCommand.ts","../src/types/duel-events.ts","../src/types/types.ts","../src/game/YGOGameUtils.ts","../src/commands/ActivateCardCommand.ts","../src/game/YGOUtils.ts","../src/commands/XYZMoveMaterials.ts","../src/commands/MoveCardCommand.ts","../src/commands/BanishCommand.ts","../src/commands/ChangeCardAtkDefCommand.ts","../src/commands/ChangeCardPositionCommand.ts","../src/commands/DestroyCard.ts","../src/commands/DrawFromDeckCommand.ts","../src/commands/RevealCommand.ts","../src/commands/SendCardToGY.ts","../src/commands/FieldSpellCommand.ts","../src/commands/FlipCommand.ts","../src/commands/FusionSummonCommand.ts","../src/commands/LinkSummonCommand.ts","../src/commands/MillFromDeckCommand.ts","../src/commands/NormalSummonCommand.ts","../src/commands/SetCardCommand.ts","../src/commands/SetMonsterCommand.ts","../src/commands/ShuffleDeck.ts","../src/commands/SpecialSummonCommand.ts","../src/commands/StartHandCommand.ts","../src/commands/SynchroSummonCommand.ts","../src/commands/TargetCommand.ts","../src/commands/ToDeckCommand.ts","../src/commands/ToExtraDeckCommand.ts","../src/commands/ToHandCommand.ts","../src/commands/ToSTCommand.ts","../src/commands/TributeSummonCommand.ts","../src/commands/XYZAttachMaterialCommand.ts","../src/commands/XYZDetachMaterialCommand.ts","../src/commands/XYZOverlaySummonCommand.ts","../src/commands/XYZSummonCommand.ts","../src/commands/index.ts","../src/commands/JSONCommand.ts","../src/utils/event-bus.ts","../src/game/YGODuelLog.ts","../src/game/YGOGameState.ts","../src/game/YGOReplayUtils.ts","../src/game/YGOCore.ts","../src/index.ts"],"sourcesContent":["import { YGOCore } from \"../game/YGOCore\";\nimport { CommandType, Command } from \"../types/commands\";\n\nexport abstract class BaseCommand implements Command {\n\n    protected YGO!: YGOCore;\n    public commandId: number = -1;\n    public type!: CommandType;\n    public baseType!: string;\n    public timestamp!: number;\n    public parent: Command | null = null;\n\n    constructor() { }\n\n    init(ygo: YGOCore) {\n        this.YGO = ygo;\n        this.commandId = this.YGO.getNextCommandId();\n        this.timestamp = this.YGO.getCurrentTime();\n    }\n\n    getCommandId() {\n        return this.parent?.commandId || this.commandId;\n    }\n\n    execChildCommand(command: Command): Command | undefined {\n        command.parent = this.parent ? this.parent : this;\n        command.init(this.YGO);\n        command.exec();\n        return command;\n    }\n\n    undoChildCommand(command: Command | undefined): Command | undefined {\n        command?.undo();\n        return command;\n    }\n\n    undoMultipleChildCommand(commands: Command[]): void {\n        for (let i = commands.length - 1; i >= 0; --i) {\n            commands[i]?.undo();\n        }\n    }\n\n    execMultipleChildCommand(commands: Command[]): void {\n        for (const command of commands) {\n            this.execChildCommand(command);\n        }\n    }\n\n    isValid(): boolean {\n        return true;\n    }\n\n    exec(): void {\n\n    }\n\n    undo(): void {\n\n    }\n\n    toJSON<T extends any = any>(): { type: string, data: T } {\n        const self = this as any;\n        const data = self.data || {};\n\n        return {\n            type: this.baseType,\n            data,\n        };\n    }\n    \n    toCommandData<T extends any = any>(): {commandId: number, timestamp:number, type: string, data: T } {\n        const self = this as any;\n        const data = self.data || {};\n\n        return {\n            commandId: this.commandId,\n            timestamp: this.timestamp,\n            type: this.baseType,\n            data,\n        };\n    }\n}","import { CardPosition, FieldZone } from \"./types\";\n\nexport namespace YGODuelEvents {\n    export enum LogType {\n        NormalSummon = \"Normal Summon\",\n        SetMonster = \"Set Monster\",\n        SendToGY = \"Send To GY\",\n        Banish = \"Banish\",\n        BanishFD = \"Banish FD\",\n        StartHand = \"Start Hand\",\n        DrawCardFromDeck = \"Draw From Deck\",\n        MillCardFromDeck = \"Mill From Deck\",\n        TributeSummon = \"Tribute Summon\",\n        TributeSet = \"Tribute Set\",\n        ToHand = \"To Hand\",\n        ToExtraDeck = \"To Extra Deck\",\n        ToTopDeck = \"To Top Deck\",\n        ToBottomDeck = \"To Bottom Deck\",\n        Destroy = \"Destroy\",\n        SpecialSummon = \"Special Summon\",\n        SynchroSummon = \"Synchro Summon\",\n        LinkSummon = \"Link Summon\",\n        FusionSummon = \"Fusion Summon\",\n        XYZSummon = \"XYZ Summon\",\n        XYZOverlaySummon = \"XYZ Overlay Summon\",\n        XYZAttachMaterial = \"XYZ Attach Material\",\n        XYZDetachMaterial = \"XYZ Detach Material\",\n        XYZOverlay = \"XYZOverlay\",\n        SetST = \"Set ST\",\n        Activate = \"Activate\",\n        MoveCard = \"Move Card\",\n        Shuffle = \"Shuffle\",\n        ToST = \"To ST\",\n        Reveal = \"Reveal\",\n        Target = \"Target\",\n        FieldSpell = \"Field Spell\",\n        ChangeCardPosition = \"Change Card Position\",\n        ChangeCardAtkDef = \"Change Card Atk Def\",\n        Flip = \"Flip\"\n    }\n\n    export interface DuelLog {\n        type: LogType;\n        player: number;\n        commandId: number;\n    }\n\n    export interface NormalSummon extends DuelLog {\n        id: number;\n        originZone: FieldZone;\n        zone: FieldZone;\n        position: CardPosition;\n    }\n\n    export interface TributeSummon extends DuelLog {\n        id: number;\n        originZone: FieldZone;\n        zone: FieldZone;\n        position: CardPosition;\n        tributes: {\n            id: number,\n            zone: FieldZone,\n            owner: number\n        }[]\n    }\n\n    export interface TributeSummonSet extends TributeSummon {\n    }\n\n    export interface MoveCard extends DuelLog {\n        id: number;\n        originZone: FieldZone;\n        zone: FieldZone;\n        position: CardPosition;\n    }\n\n    export interface ToHand extends MoveCard { }\n\n    export interface SetMonster extends DuelLog {\n        id: number;\n        originZone: FieldZone;\n        zone?: FieldZone;\n    }\n\n    export interface SetST extends DuelLog {\n        id: number;\n        originZone: FieldZone;\n        zone?: FieldZone;\n    }\n\n    export interface SendToGY extends DuelLog {\n        id: number\n        originZone: FieldZone\n        zone: FieldZone,\n        reason?: \"Fusion Summon\" | \"Synchro Summon\" | \"Link Summon\" | \"XYZ Material\" | undefined\n    }\n\n    export interface DrawFromDeck extends DuelLog {\n        id: number\n        originZone: FieldZone\n        zone: FieldZone\n    }\n\n    export interface StartHand extends DuelLog {\n        cards: { id: number, zone: FieldZone }[],\n        core: boolean\n    }\n\n    export interface FusionSummon extends DuelLog {\n        id: number\n        originZone: FieldZone\n        zone: FieldZone\n        position: CardPosition\n        materials: Array<{\n            id: number\n            zone: FieldZone\n            owner: number\n        }>\n    }\n\n    export interface SynchroSummon extends DuelLog {\n        id: number\n        originZone: FieldZone\n        zone: FieldZone\n        position: CardPosition\n        materials: Array<{\n            id: number\n            zone: FieldZone\n        }>\n    }\n\n    export interface LinkSummon extends DuelLog {\n        id: number\n        originZone: FieldZone\n        zone: FieldZone\n        materials: Array<{\n            id: number\n            zone: FieldZone\n            owner: number\n        }>\n    }\n\n    export interface XYZSummon extends DuelLog {\n        id: number\n        originZone: FieldZone\n        zone: FieldZone\n        position: CardPosition\n        materials: Array<{\n            id: number\n            zone: FieldZone\n        }>\n    }\n\n    export interface XYZOverlaySummon extends DuelLog {\n        id: number\n        originZone: FieldZone\n        zone: FieldZone\n        position: CardPosition\n        materials: Array<{\n            id: number\n            zone: FieldZone\n        }>\n    }\n\n    export interface XYZAttach extends DuelLog {\n        id: number\n        materialId: number\n        originZone: FieldZone\n        overlayZone: FieldZone\n    }\n\n    export interface XYZOverlay extends DuelLog {\n        id: number\n        originZone: FieldZone\n        overlayZone: FieldZone\n    }\n\n    export interface XYZDetach extends DuelLog {\n        id: number\n        overlayZone: FieldZone\n        owner: number\n        materialId: number\n        materialIndex: number\n    }\n\n    export interface Activate extends DuelLog {\n        id: number\n        originZone?: FieldZone\n        zone: FieldZone\n        previousPosition: CardPosition\n        position: CardPosition\n    }\n\n    export interface Target extends DuelLog {\n        id: number\n        originZone: FieldZone\n    }\n\n    export interface Banish extends DuelLog {\n        id: number;\n        originZone: FieldZone;\n        zone: FieldZone;\n        position: CardPosition;\n    }\n\n    export interface Shuffle extends DuelLog { }\n\n    export interface Reveal extends DuelLog {\n        id: number;\n        originZone: FieldZone;\n    }\n\n    export interface ChangeCardPosition extends DuelLog {\n        id: number\n        originZone: FieldZone\n        previousPosition: CardPosition\n        position: CardPosition\n    }\n\n    export interface Flip extends DuelLog {\n        id: number\n        originZone: FieldZone\n        previousPosition: CardPosition\n        position: CardPosition\n    }\n\n    export interface ToExtraDeck extends DuelLog {\n        id: number,\n        originZone: FieldZone\n    }\n\n    export interface MillCardFromDeck extends DuelLog {\n        // TODO\n    }\n\n    export interface Destroy extends MoveCard {\n\n    }\n\n    export interface ChangeCardAtkDef extends DuelLog {\n        player: number\n        id: number\n        originZone: FieldZone\n        oldAtk: number\n        oldDef: number\n        atk: number\n        def: number\n    }\n}\n\n","import { BaseCommand } from \"../commands/BaseCommand\";\nimport { Command } from \"./commands\";\nimport { YGODuelEvents } from \"./duel-events\";\n\nexport const NUM_ZONES: number = 5; // Number of primary zones (Monster, Spell/Trap, etc.)\nexport type PlayerSide = 0 | 1 | number; // 0 represents Player 1, 1 represents Player 2\n\nexport type CardPosition = \"faceup-attack\" | \"faceup-defense\" | \"faceup\" | \"facedown\";\n\nexport type FieldZone = `M-${1 | 2 | 3 | 4 | 5}`\n    | `M2-${1 | 2 | 3 | 4 | 5}`\n    | `S-${1 | 2 | 3 | 4 | 5}`\n    | `S2-${1 | 2 | 3 | 4 | 5}`\n    | `EMZ`\n    | `EMZ2`\n    | `EMZ-${1 | 2}`\n    | `EMZ2-${1 | 2}`\n    | `ORU-${1 | 2 | 3 | 4 | 5}` // Overlay Units ORU Xyz Materials\n    | `ORU2-${1 | 2 | 3 | 4 | 5}`\n    | `ORUEMZ-${1 | 2}` // Xyz Materials in extra monster zone :)\n    | `ORUEMZ2-${1 | 2}`\n    | \"H\"\n    | \"H2\"\n    | `H-${number}`\n    | `H2-${number}`\n    | \"F\"\n    | \"F2\"\n    | \"GY\"\n    | \"GY2\"\n    | `GY-${number}`\n    | `GY2-${number}`\n    | \"B\"\n    | \"B2\"\n    | `B-${number}`\n    | `B2-${number}`\n    | \"D\"\n    | \"D2\"\n    | `D-${number}`\n    | `D2-${number}`\n    | \"ED\"\n    | \"ED2\"\n    | `ED-${number}`\n    | `ED2-${number}`;\n\nexport type FieldZoneId = \"M\" | \"S\" | \"EMZ\" | \"GY\" | \"D\" | \"ED\" | \"B\" | \"F\" | \"ORU\" | \"ORUEMZ\" | \"H\";\n\nexport type FieldZoneData = { zone: FieldZoneId, player: number, zoneIndex: number }\n\nexport enum CardBaseType {\n    NormalMonster,\n    EffectMonster,\n    RitualMonster,\n    Spell,\n    Trap,\n    FusionMonster,\n    SynchroMonster,\n    XYZMonster,\n    LinkMonster,\n}\n\nexport interface YGOPropsOptions {\n    lp?: number // default `8000`\n    draw?: number // default `5`\n    shuffleDecks?: boolean // default value is `true`,\n    fieldState?: FieldStateEntry[] // default,\n    startCommand?: number\n    execCommands?: boolean\n    currentGameTime?: number\n}\n\nexport interface YGOPropsPlayer {\n    name: string,\n    mainDeck: CardData[], // Card Data is the same as https://ygoprodeck.com/api-guide\n    extraDeck: CardData[] // Card Data is the same as https://ygoprodeck.com/api-guide\n}\n\nexport interface YGOProps {\n    players: YGOPropsPlayer[],\n    commands?: { type: string, data: any }[]\n    options?: YGOPropsOptions\n}\n\nexport interface FieldStateEntry {\n    id: number,\n    zone: FieldZone\n    atk?: number\n    def?: number\n    owner?: number\n    position?: CardPosition\n    materials?: Array<{ id: number, owner?: number }>\n}\n\nexport interface CardData {\n    id: number\n    name: string\n    typeline: string[]\n    type: string\n    frameType: string\n    desc: string,\n    race: string,\n    atk: number\n    def: number\n    level: number\n    attribute: string\n    card_images: any\n}\n\nexport interface Card {\n    id: number\n    name: string\n    typeline: string[]\n    type: string\n    frameType: string\n    desc: string,\n    race: string,\n    atk: number\n    def: number\n    level: number\n    linkval: number\n    attribute: string\n    card_images: any\n    // game_data\n    index: number // internal unique ID\n    owner: number\n    isMainDeckCard: boolean\n    originalOwner: number\n    position: CardPosition\n    currentAtk: number\n    currentDef: number\n    materials: Card[]\n}\n\nexport interface PlayerInfo {\n    name: string;\n}\n\nexport interface PlayerField {\n    lp: number,\n    player: PlayerInfo\n    mainDeck: Card[]\n    extraDeck: Card[]\n    hand: Card[]\n    data: {\n        mainDeckOrdered: number[];\n        extraDeckOrdered: number[];\n    }\n    graveyard: Card[]\n    banishedZone: Card[]\n    // Zones on the field where cards are actively played\n    monsterZone: Array<Card | null>\n    spellTrapZone: Array<Card | null>\n    fieldZone: Card | null;\n    extraMonsterZone: Array<Card | null>;\n}\n\nexport interface GameState {\n    players: PlayerInfo[];\n    fields: PlayerField[];\n}\n\nexport interface YGOReplayData {\n    players: {\n        name: string\n        mainDeck: number[]\n        extraDeck: number[]\n    }[]\n    initialField: FieldStateEntry[]\n    endField: FieldStateEntry[]\n    commands: any[]\n}\n\nexport type YGOCoreEvents = {\n    \"command-created\": (args: { command: Command }) => void\n    \"command-executed\": (args: { command: Command }) => void\n    \"command-redo\": (args: { command: Command }) => void\n    \"command-undo\": (args: { command: Command }) => void\n    'new-log': (log: YGODuelEvents.DuelLog) => void\n    'update-logs': (logs: YGODuelEvents.DuelLog[]) => void\n    'set-player': (args: { player: number }) => void\n    'set-duel-phase': (args: { phase: YGOPhase }) => void\n}\n\nexport enum YGOPhase {\n    DrawPhase = \"Draw Phase\",\n    StandbyPhase = \"Standby Phase\",\n    MainPhase1 = \"Main Phase 1\",\n    BattlePhase = \"Battle Phase\",\n    MainPhase2 = \"Main Phase 2\",\n    EndPhase = \"End Phase\",\n}","import { Card, CardBaseType, FieldZone, FieldZoneId, FieldZoneData, PlayerField } from \"../types/types\";\nimport { YGOCore } from \"./YGOCore\";\n\n// Only functions for game utils\nexport class YGOGameUtils {\n\n    static isLinkMonster(card: Card): boolean {\n        return card.typeline?.includes(\"Link\");\n    }\n\n    static isMonster(card: Card): boolean {\n        return card.type?.includes(\"Monster\");\n    }\n\n    static isXYZMonster(card: Card) {\n        return card.typeline?.includes(\"Xyz\");\n    }\n\n    static isSynchroMonster(card: Card) {\n        return card.typeline?.includes(\"Synchro\");\n    }\n\n    static isFusionMonster(card: Card) {\n        return card.typeline?.includes(\"Fusion\");\n    }\n\n    static isPendulumCard(card: Card) {\n        return card.frameType?.includes(\"pendulum\");\n    }\n\n    static isFaceUp(card: Card): boolean {\n        return card.position.includes(\"faceup\");\n    }\n\n    static isFaceDown(card: Card): boolean {\n        return !this.isFaceUp(card);\n    }\n\n    static isSpellTrap(card: Card) {\n        return this.isSpell(card) || this.isTrap(card);\n    }\n\n    static isSpell(card: Card) {\n        return card.frameType.startsWith(\"spell\");\n    }\n\n    static isTrap(card: Card) {\n        return card.frameType.startsWith(\"trap\");\n    }\n\n    static isFieldSpell(card: Card) {\n        return card.race === \"Field\";\n    }\n\n    static isDefense(card: Card) {\n        return card.position === \"facedown\" || card.position === \"faceup-defense\";\n    }\n\n    static isAttack(card: Card) {\n        return card.position === \"faceup-attack\" || card.position === \"faceup\";\n    }\n\n    static hasLinkMonstersInField(field: PlayerField) {\n\n        if (field.monsterZone.some(card => card ? YGOGameUtils.isLinkMonster(card) : false)) {\n            return true;\n        }\n\n        return field.extraMonsterZone.some(card => card ? YGOGameUtils.isLinkMonster(card) : false);\n    }\n\n    static hasXyzMonstersInField(field: PlayerField) {\n\n        if (field.monsterZone.some(card => card ? YGOGameUtils.isXYZMonster(card) : false)) {\n            return true;\n        }\n\n        return field.extraMonsterZone.some(card => card ? YGOGameUtils.isXYZMonster(card) : false);\n    }\n\n    static XyzMonstersInFieldCounter(field: PlayerField) {\n        let counter = 0;\n\n        field.monsterZone.forEach(card => {\n            if (card && YGOGameUtils.isXYZMonster(card)) {\n                counter++;\n            }\n        });\n\n        field.extraMonsterZone.forEach(card => {\n            if (card && YGOGameUtils.isXYZMonster(card)) {\n                counter++;\n            }\n        });\n\n        return counter;\n    }\n\n    static XyzMonstersInFieldsCounter(duel: YGOCore) {\n        let counter = 0;\n\n        duel.state.fields.forEach(field => {\n            field.monsterZone.forEach(card => {\n                if (card && YGOGameUtils.isXYZMonster(card)) {\n                    counter++;\n                }\n            });\n\n            field.extraMonsterZone.forEach(card => {\n                if (card && YGOGameUtils.isXYZMonster(card)) {\n                    counter++;\n                }\n            });\n        })\n\n        return counter;\n    }\n\n    static getPlayerIndexFromZone(zone: string): number {\n        const isPlayer2 = zone.includes(\"2-\");\n\n        if (isPlayer2) return 1;\n\n        switch (zone) {\n            case \"M2\":\n            case \"H2\":\n            case \"F2\":\n            case \"GY2\":\n            case \"EMZ2-1\":\n            case \"EMZ2-2\":\n                return 1;\n            default:\n                return 0;\n        }\n    }\n\n    static createZone(zone: FieldZoneId, player: number, position?: number): FieldZone {\n\n        if (position === undefined || position === -1) {\n            return `${zone}${player === 0 ? '' : '2'}` as FieldZone;\n        }\n\n        return `${zone}${player === 0 ? '' : '2'}-${position}` as FieldZone;\n    }\n\n    static createOverlayZone(zone: string, player: number, zoneIndex: number): FieldZone {\n\n        if (zone === \"EMZ\") {\n            return `ORU${player === 0 ? '' : '2'}-${zoneIndex}` as FieldZone;\n        }\n\n        return `ORUEMZ${player === 0 ? '' : '2'}-${zoneIndex}` as FieldZone;\n    }\n\n    static getZoneData(zone: FieldZone): FieldZoneData {\n        const args = zone.split(\"-\");\n        let playerIndex = 0;\n        let zoneId = args[0];\n        const zoneIndex = args.length > 1 ? Number(args[1]) : -1;\n\n        if (args[0].endsWith(\"2\")) {\n            playerIndex = 1;\n            zoneId = zoneId.substring(0, zoneId.length - 1);\n        }\n\n        return {\n            zone: zoneId as FieldZoneId,\n            player: playerIndex,\n            zoneIndex: zoneIndex,\n        }\n    }\n\n    static getCardBaseType(card: Card): CardBaseType {\n        if (card.frameType.startsWith(\"effect\")) return CardBaseType.EffectMonster;\n        if (card.frameType.startsWith(\"spell\")) return CardBaseType.Spell;\n        if (card.frameType.startsWith(\"ritual\")) return CardBaseType.RitualMonster;\n        if (card.frameType.startsWith(\"trap\")) return CardBaseType.Trap;\n        if (card.frameType.includes(\"fusion\")) return CardBaseType.FusionMonster;\n        if (card.frameType.includes(\"synchro\")) return CardBaseType.SynchroMonster;\n        if (card.frameType.includes(\"xyz\")) return CardBaseType.XYZMonster;\n        if (card.frameType.includes(\"link\")) return CardBaseType.LinkMonster;\n        return CardBaseType.NormalMonster;\n    }\n\n    static getCardsBaseType(cards: Card[]): CardBaseType[] {\n        const result = cards.map(c => YGOGameUtils.getCardBaseType(c));\n        return result;\n    }\n\n    static toSortedCards(cards: Card[]) {\n        return this.sortCards([...cards]);\n    }\n\n    static sortCards(cardsToSort: Card[]) {\n        const cards = cardsToSort;\n        const cardsWeights = YGOGameUtils.getCardsBaseType(cards);\n\n        for (let i = 0; i < cards.length - 1; ++i) {\n            for (let j = 0; j < cards.length - i - 1; ++j) {\n                if (cardsWeights[j] > cardsWeights[j + 1] || (cardsWeights[j] === cardsWeights[j + 1] && cards[j].name > cards[j + 1].name)) {\n                    [cards[j], cards[j + 1]] = [cards[j + 1], cards[j]];\n                    [cardsWeights[j], cardsWeights[j + 1]] = [cardsWeights[j + 1], cardsWeights[j]];\n                }\n            }\n        }\n\n        return cards;\n    }\n\n    static shuffleCards(cards: Card[]): Array<number> {\n        const positions = Array<number>(cards.length);\n        for (let i = 0; i < cards.length; ++i) {\n            const index = Math.floor(Math.random() * cards.length);\n\n            positions[i] = index;\n\n            const temp = cards[i];\n            cards[i] = cards[index];\n            cards[index] = temp;\n        }\n        return positions;\n    }\n\n    static invertPlayerInZone(zone: FieldZone): FieldZone {\n        const zoneData = this.getZoneData(zone);\n        return this.createZone(zoneData.zone, 1 - zoneData.player, zoneData.zoneIndex);\n    }\n\n    static transformZoneToPlayerZone(zone: FieldZone, playerIndex: number): FieldZone {\n        const zoneData = this.getZoneData(zone);\n        return this.createZone(zoneData.zone, playerIndex, zoneData.zoneIndex);\n    }\n}","import { BaseCommand } from './BaseCommand';\nimport { ActivateCardCommandData } from '../types/commands';\nimport { Card, CardPosition } from '../types/types';\nimport { YGODuelEvents } from '../types/duel-events';\nimport { YGOGameUtils } from '../game/YGOGameUtils';\n\nexport class ActivateCardCommand extends BaseCommand {\n    public baseType: string = \"ActivateCardCommand\";\n    private data: ActivateCardCommandData;\n    private prevPosition: CardPosition | undefined;\n\n    constructor(data: ActivateCardCommandData) {\n        super();\n        this.type = \"Activate\";\n        this.data = data;\n    }\n\n    override exec(): void {\n        const card = this.YGO.state.getCardById(this.data.id, this.data.originZone || this.data.zone)!;\n\n        if (this.data.originZone) {\n            this.YGO.state.removeCard(this.data.originZone);\n            this.YGO.state.setCard(card, this.data.zone);\n\n            console.log(`Exec: Activate ${this.data.id} from ${this.data.originZone} in ${this.data.zone}`);\n        } else {\n            console.log(`Exec: Activate ${this.data.id} in ${this.data.zone}`);\n        }\n\n        this.prevPosition = card.position;\n\n        if (YGOGameUtils.isFaceDown(card)) {\n            if (YGOGameUtils.isSpellTrap(card)) {\n                card.position = 'faceup';\n            } else {\n                card.position = 'faceup-attack';\n            }\n        }\n\n        this.YGO.duelLog.dispatch<YGODuelEvents.Activate>({\n            player: this.data.player,\n            commandId: this.getCommandId(),\n            type: YGODuelEvents.LogType.Activate,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            zone: this.data.zone,\n            previousPosition: this.prevPosition,\n            position: card.position\n        });\n    }\n\n    override undo(): void {\n        const card = this.YGO.state.getCardById(this.data.id, this.data.zone);\n\n        if (this.data.originZone) {\n            this.YGO.state.removeCard(this.data.zone);\n            this.YGO.state.setCard(card, this.data.originZone);\n\n            console.log(`Undo: Activate ${this.data.id} from ${this.data.originZone} in ${this.data.zone}`);\n        } else {\n            console.log(`Undo: Activate ${this.data.id} in ${this.data.zone}`);\n        }\n\n        if (this.prevPosition) {\n            card.position = this.prevPosition;\n        }\n    }\n}","import { Card, FieldZone, FieldStateEntry, PlayerField, YGOProps, YGOPropsPlayer } from \"../types/types\";\nimport { YGOCore } from \"./YGOCore\";\nimport { YGOGameUtils } from \"./YGOGameUtils\";\n\n// Only internal functions for game utils\nexport class YGOUtils {\n    static getPlayerIndexFromZone(zone: string): number {\n        return YGOGameUtils.getPlayerIndexFromZone(zone);\n    }\n\n    static parseMainDeck({ mainDeck, player }: { mainDeck: Card[], player: number }): Card[] {\n        return mainDeck.map(card => YGOUtils.parseCard({ card, player, isMainDeckCard: true }));\n    }\n\n    static parseExtraDeck({ extraDeck, player }: { extraDeck: Card[], player: number }): Card[] {\n        const extra = extraDeck.map(card => YGOUtils.parseCard({ card, player, isMainDeckCard: false }));\n        YGOGameUtils.sortCards(extra);\n        return extra;\n    }\n\n    static parseCard({ card, player, isMainDeckCard }: { card: Card, player: number, isMainDeckCard: boolean }): Card {\n        if (!card) throw new Error(\"card is required to be parsed\");\n        card.owner = player;\n        card.originalOwner = player;\n        card.currentAtk = card.atk;\n        card.currentDef = card.def;\n        card.materials = [];\n        card.isMainDeckCard = isMainDeckCard;\n        card.position = \"facedown\";\n        return card;\n    }\n\n    static getCardsInGame(fields: PlayerField[]): Map<number, Card> {\n        const cards = new Map<number, Card>()\n\n        for (const field of fields) {\n\n            for (const card of field.mainDeck) {\n                if (!cards.has(card.id)) {\n                    cards.set(card.id, card);\n                }\n            }\n\n            for (const card of field.extraDeck) {\n                if (!cards.has(card.id)) {\n                    cards.set(card.id, card);\n                }\n            }\n\n            for (const card of field.monsterZone) {\n                if (card && !cards.has(card.id)) {\n                    cards.set(card.id, card);\n                }\n            }\n\n            for (const card of field.spellTrapZone) {\n                if (card && !cards.has(card.id)) {\n                    cards.set(card.id, card);\n                }\n            }\n\n            for (const card of field.extraMonsterZone) {\n                if (card && !cards.has(card.id)) {\n                    cards.set(card.id, card);\n                }\n            }\n\n            for (const card of field.graveyard) {\n                if (card && !cards.has(card.id)) {\n                    cards.set(card.id, card);\n                }\n            }\n\n            for (const card of field.banishedZone) {\n                if (card && !cards.has(card.id)) {\n                    cards.set(card.id, card);\n                }\n            }\n        }\n\n        return cards;\n    }\n\n    static getOverlayZone(zone: FieldZone): FieldZone {\n        const playerIndex = YGOUtils.getPlayerIndexFromZone(zone);\n        const zoneIndex = zone.split(\"-\")[1];\n\n        if (zone.startsWith(\"EMZ\")) {\n            return `ORUEMZ${playerIndex === 0 ? '' : '2'}-${zoneIndex}` as FieldZone;\n        }\n\n        return `ORU${playerIndex === 0 ? '' : '2'}-${zoneIndex}` as FieldZone;\n    }\n\n    static initializePlayersFields(props: YGOProps): [PlayerField, PlayerField] {\n        const { shuffleDecks = true } = props.options || {};\n        let cardIndex = 0;\n\n        const field1: PlayerField = {\n            lp: 8000,\n            player: { name: \"test\" },\n            mainDeck: [],\n            extraDeck: [],\n            hand: [],\n            data: {\n                mainDeckOrdered: [],\n                extraDeckOrdered: []\n            },\n            monsterZone: [null, null, null, null, null],\n            spellTrapZone: [null, null, null, null, null],\n            fieldZone: null,\n            extraMonsterZone: [null, null],\n            graveyard: [],\n            banishedZone: [],\n        };\n\n        const field2: PlayerField = {\n            lp: 8000,\n            player: { name: \"test2\" },\n            mainDeck: [],\n            extraDeck: [],\n            hand: [],\n            data: {\n                mainDeckOrdered: [],\n                extraDeckOrdered: []\n            },\n            monsterZone: [null, null, null, null, null],\n            spellTrapZone: [null, null, null, null, null],\n            fieldZone: null,\n            extraMonsterZone: [null, null],\n            graveyard: [],\n            banishedZone: [],\n        }\n\n        const fields: [PlayerField, PlayerField] = [field1, field2];\n\n        for (let playerIndex = 0; playerIndex < props.players.length; ++playerIndex) {\n            const player = props.players[playerIndex];\n            const field = fields[playerIndex];\n            field.mainDeck = YGOUtils.parseMainDeck({ mainDeck: player.mainDeck as Card[], player: playerIndex });\n            field.extraDeck = YGOUtils.parseExtraDeck({ extraDeck: player.extraDeck as Card[], player: playerIndex });\n            field.mainDeck.forEach(card => card.index = ++cardIndex);\n            field.extraDeck.forEach(card => card.index = ++cardIndex);\n        }\n\n        if (shuffleDecks) {\n            fields.forEach((field, playerIndex) => {\n                if (props.players[playerIndex]) {\n                    YGOGameUtils.shuffleCards(field.mainDeck);\n                }\n            });\n        }\n\n        fields.forEach((field) => {\n            field.data.mainDeckOrdered = field.mainDeck.map(card => card.id);\n            field.data.extraDeckOrdered = field.extraDeck.map(card => card.id);\n        });\n\n        this.recoverFields(fields, props.options?.fieldState);\n\n        return fields;\n    }\n\n    private static recoverFields(fields: PlayerField[], fieldState: FieldStateEntry[] | undefined) {\n        if (Array.isArray(fieldState)) {\n            const cardsToRemoveFromDeck = [new Set(), new Set()];\n            const cardsToRemoveFromExtraDeck = [new Set(), new Set()];\n\n            const getCard = (player: number, id: number): Card => {\n\n                const card = fields[player].mainDeck.find(c => c.id === id && !cardsToRemoveFromDeck[player].has(c));\n\n                if (card) {\n                    cardsToRemoveFromDeck[player].add(card);\n                    return card;\n                }\n\n                const edCard = fields[player].extraDeck.find(c => c.id === id && !cardsToRemoveFromExtraDeck[player].has(c));\n\n                if (edCard) {\n                    cardsToRemoveFromExtraDeck[player].add(edCard);\n                    return edCard;\n                }\n\n                throw new Error(`Card \"${id}\" not found in player \"${player}\" deck`);\n            }\n\n            for (let i = 0; i < 2; ++i) {\n                const hand: Array<{ card: Card, index: number }> = [];\n                const graveyard: Array<{ card: Card, index: number }> = [];\n                const banished: Array<{ card: Card, index: number }> = [];\n\n                for (const cardInitialState of fieldState) {\n                    const zoneData = YGOGameUtils.getZoneData(cardInitialState.zone);\n\n                    if (zoneData.player !== i) continue;\n\n                    if (zoneData.zone === \"H\") {\n                        const card = getCard(zoneData.player, cardInitialState.id); // TODO PLAYER OWNER CHECK\n                        hand.push({ card, index: zoneData.zoneIndex || 0 });\n                    } else if (zoneData.zone === \"M\") {\n                        const { position = \"faceup-attack\" } = cardInitialState;\n                        const card = getCard(zoneData.player, cardInitialState.id); // TODO PLAYER OWNER CHECK\n                        fields[zoneData.player].monsterZone[zoneData.zoneIndex - 1] = card;\n\n                        if (YGOUtils.isNumeric(cardInitialState.atk)) card.currentAtk = Number(cardInitialState.atk);\n                        if (YGOUtils.isNumeric(cardInitialState.def)) card.currentDef = Number(cardInitialState.def);\n                        if (position) card.position = position;\n                        if (cardInitialState.materials) card.materials = cardInitialState.materials.map(({ id }) => getCard(zoneData.player, id)); // todo check owner\n                    } else if (zoneData.zone === \"EMZ\") {\n                        const card = getCard(zoneData.player, cardInitialState.id); // TODO PLAYER OWNER CHECK\n                        fields[zoneData.player].extraMonsterZone[zoneData.zoneIndex - 1] = card;\n\n                        if (YGOUtils.isNumeric(cardInitialState.atk)) card.currentAtk = Number(cardInitialState.atk);\n                        if (YGOUtils.isNumeric(cardInitialState.def)) card.currentDef = Number(cardInitialState.def);\n                        if (cardInitialState.position) card.position = cardInitialState.position;\n                        if (cardInitialState.materials) card.materials = cardInitialState.materials.map(({ id }) => getCard(zoneData.player, id)); // todo check owner\n                    }\n                    else if (zoneData.zone === \"S\") {\n                        const card = getCard(zoneData.player, cardInitialState.id); // TODO PLAYER OWNER CHECK\n                        fields[zoneData.player].spellTrapZone[zoneData.zoneIndex - 1] = card;\n\n                        if (cardInitialState.position) card.position = cardInitialState.position;\n                    } else if (zoneData.zone === \"F\") {\n                        const card = getCard(zoneData.player, cardInitialState.id); // TODO PLAYER OWNER CHECK\n                        fields[zoneData.player].fieldZone = card;\n\n                        if (cardInitialState.position) card.position = cardInitialState.position;\n                    } else if (zoneData.zone === \"GY\") {\n                        const card = getCard(zoneData.player, cardInitialState.id); // TODO PLAYER OWNER CHECK\n                        graveyard.push({ card, index: zoneData.zoneIndex || 0 });\n                    } else if (zoneData.zone === \"B\") {\n                        const card = getCard(zoneData.player, cardInitialState.id); // TODO PLAYER OWNER CHECK\n                        banished.push({ card, index: zoneData.zoneIndex || 0 });\n                    } else if (zoneData.zone === \"ED\") { // pendulumns\n                        // TODO\n                    }\n                };\n\n                if (hand.length > 0) {\n                    fields[i].hand = [...hand].sort((card1, card2) => card1.index - card2.index).map(cardInHand => cardInHand.card);\n                }\n\n                if (graveyard.length > 0) {\n                    fields[i].graveyard = [...graveyard].sort((card1, card2) => card1.index - card2.index).map(cardInHand => cardInHand.card);\n                }\n\n                if (banished.length > 0) {\n                    fields[i].hand = [...banished].sort((card1, card2) => card1.index - card2.index).map(cardInHand => cardInHand.card);\n                }\n            }\n\n            for (let i = 0; i < fields.length; ++i) {\n                fields[i].mainDeck = fields[i].mainDeck.filter(c => !cardsToRemoveFromDeck[i].has(c))\n                fields[i].extraDeck = fields[i].extraDeck.filter(c => !cardsToRemoveFromDeck[i].has(c))\n            }\n        }\n    }\n\n    static isNumeric(val: any): boolean {\n        return !isNaN(Number(val));\n    }\n\n    static getFieldsAsString(ygo: YGOCore) {\n        const log: string[] = [];\n\n        log.push(\"---- FIELD STATE ----\");\n\n        const field1 = ygo.getField(0);\n        const field2 = ygo.getField(1);\n\n        log.push(\"Player2: \" + field1.player.name);\n        log.push(\"Hand: \" + field2.hand.map(c => c.name).join(\" | \"));\n        log.push(\"Spell/Trap Zone: \" + field2.spellTrapZone.map(c => c?.name || \"_\").join(\" | \"));\n        log.push(\"Monster Zone: \" + field2.monsterZone.map(c => c?.name || \"_\").join(\" | \"));\n        log.push(\"-------\");\n        log.push(\"Extra Monster Zone: \" + ((field1.extraMonsterZone[0] || field2.extraMonsterZone[0])?.name || \"_\") + \" | \" + ((field1.extraMonsterZone[1] || field2.extraMonsterZone[1])?.name || \"_\"));\n        log.push(\"-------\");\n        log.push(\"Monster Zone: \" + field1.monsterZone.map(c => c?.name || \"_\").join(\" | \"));\n        log.push(\"Spell/Trap Zone: \" + field1.spellTrapZone.map(c => c?.name || \"_\").join(\" | \"));\n        log.push(\"Hand: \" + field1.hand.map(c => c.name).join(\" | \"));\n        log.push(\"Player1: \" + field1.player.name);\n\n        return log.join(\"\\n\");\n    }\n\n    static getYGOCoreStateProps(ygo: YGOCore): YGOProps {\n\n        const players: YGOPropsPlayer[] = ygo.state.fields.map((field) => {\n            return {\n                name: field.player.name,\n                mainDeck: field.data.mainDeckOrdered.map(id => ygo.state.getCardData(id) as any),\n                extraDeck: field.data.extraDeckOrdered.map(id => ygo.state.getCardData(id) as any),\n            }\n        });\n\n        return {\n            players,\n            commands: ygo.commands.map(cmd => cmd.toJSON()),\n            options: {\n                startCommand: ygo.commandIndex,\n                ...ygo.props.options || {},\n                shuffleDecks: false,\n                execCommands: true\n            }\n        }\n    }\n\n}","import { BaseCommand } from './BaseCommand';\nimport { Command, XYZMoveMaterialsCommandData } from '../types/commands';\nimport { MoveCardCommand } from './MoveCardCommand';\nimport { Card, FieldZone, FieldZoneId } from '../types/types';\nimport { YGOUtils } from '../game/YGOUtils';\nimport { YGODuelEvents } from '../types/duel-events';\nimport { YGOCore } from '../game/YGOCore';\nimport { YGOGameUtils } from '../game/YGOGameUtils';\n\nexport class XYZMoveMaterialsCommand extends BaseCommand {\n    public baseType: string = \"XYZMoveMaterialsCommand\";\n    private data: XYZMoveMaterialsCommandData;\n    private commands: Command[];\n    private materialsToMove: { card: Card, zone: FieldZone }[];\n\n    constructor(data: XYZMoveMaterialsCommandData) {\n        super();\n        this.type = \"XYZ Move Material\";\n        this.data = data;\n        this.commands = [];\n        this.materialsToMove = [];\n        console.log(\"EXEC MATERIALS\");\n    }\n\n    init(ygo: YGOCore): void {\n        super.init(ygo);\n        const card = this.YGO.state.getCardById(this.data.id, this.data.originZone);\n\n        // XYZ send materials to GY if send card to Gy or banish\n        if (this.shouldMoveMaterials(card, this.data.originZone)) {\n            const overlayZone = YGOUtils.getOverlayZone(this.data.originZone);\n            this.materialsToMove = [];\n            card.materials.forEach(material => {\n                const zone = YGOGameUtils.createZone(this.data.zone!, material.originalOwner);\n                this.YGO.state.setCard(material, zone);\n                this.materialsToMove.push({ card: material, zone });\n                console.log(\" ...................... \");\n                console.log(\"MOVE\", material.name, material.originalOwner, \" >> ZONE:\", zone);\n                if (this.data.zone === \"GY\") {\n                    this.YGO.duelLog.dispatch<YGODuelEvents.SendToGY>({\n                        player: this.data.player,\n                        commandId: this.getCommandId(),\n                        type: YGODuelEvents.LogType.SendToGY,\n                        id: material.id,\n                        originZone: overlayZone,\n                        zone,\n                        reason: \"XYZ Material\"\n                    });\n                }\n            });\n            console.log(\"MATERIALST OT MOVE\", this.materialsToMove)\n            card.materials = [];\n        }\n    }\n\n    override exec(): void {\n        this.execMultipleChildCommand(this.commands);\n    }\n\n    override undo(): void {\n        this.undoMultipleChildCommand(this.commands);\n\n        const card = this.YGO.state.getCardById(this.data.id, this.data.originZone);\n\n        if (this.materialsToMove.length > 0) {\n            this.materialsToMove.forEach(({ zone }) => {\n                this.YGO.state.setCard(null, zone);\n            });\n        }\n\n        card.materials = this.materialsToMove.map(({ card }) => card);\n    }\n\n    private shouldMoveMaterials(card: Card, zone: FieldZone): boolean {\n        if (!card.materials || card.materials.length === 0) return false;\n        return true;\n    }\n}\n\ninterface XYZMaterialsMoveData {\n    player: number,\n    id: number\n    overlayZone: FieldZone\n    zone: FieldZone\n}\n\nclass XYZMaterialsMove extends BaseCommand {\n    private data: XYZMaterialsMoveData;\n    private card!: Card;\n\n    constructor(data: XYZMaterialsMoveData) {\n        super();\n        this.data = data;\n    }\n\n    exec(): void {\n        this.card = this.YGO.state.getCardById(this.data.id, this.data.zone);\n        this.YGO.state.setCard(null, this.data.zone);\n\n        this.YGO.duelLog.dispatch<YGODuelEvents.XYZOverlay>({\n            player: this.data.player,\n            commandId: this.getCommandId(),\n            type: YGODuelEvents.LogType.XYZOverlay,\n            id: this.data.id,\n            originZone: this.data.zone,\n            overlayZone: this.data.overlayZone\n        });\n    }\n\n    undo(): void {\n        this.YGO.state.setCard(this.card, this.data.zone);\n    }\n}\n","import { BaseCommand } from './BaseCommand';\nimport { Command, MoveCardCommandData } from '../types/commands';\nimport { Card, CardPosition, FieldZoneData } from '../types/types';\nimport { YGOGameUtils } from '../game/YGOGameUtils';\nimport { XYZMoveMaterialsCommand } from './XYZMoveMaterials';\n\nexport class MoveCardCommand extends BaseCommand {\n    public baseType: string = \"MoveCardCommand\";\n    public data: MoveCardCommandData;\n    private prevPosition!: CardPosition;\n    private prevOwner!: number;\n    private prevAtk: number;\n    private prevDef: number;\n    private commands: Command[];\n\n    constructor(data: MoveCardCommandData) {\n        super();\n        const type = data.type || \"Move Card\";\n        this.type = type;\n        this.data = data;\n        this.prevAtk = 0;\n        this.prevDef = 0;\n        this.commands = [];\n        this.data.type = type;\n    }\n\n    override exec(): void {\n        console.log(`Exec: ${this.data.type} ${this.data.id} from: ${this.data.originZone} to: ${this.data.zone}`);\n        const { log = true } = this.data;\n        const card = this.YGO.state.getCardById(this.data.id, this.data.originZone);\n        const originZoneData = YGOGameUtils.getZoneData(this.data.originZone);\n        const zoneData = YGOGameUtils.getZoneData(this.data.zone);\n        const field = this.YGO.getField(zoneData.player);\n\n        this.commands = [];\n\n        this.prevOwner = card.owner;\n        card.owner = zoneData.player;\n\n        this.prevAtk = card.currentAtk;\n        this.prevDef = card.currentDef;\n\n        if (originZoneData.zone !== \"M\" && zoneData.zone === \"M\") {\n            card.currentAtk = card.atk;\n            card.currentDef = card.def;\n        }\n\n        if (this.data.zone === \"ED\" || this.data.zone === \"ED2\") {\n            this.prevPosition = card.position;\n            this.data.position = YGOGameUtils.isPendulumCard(card) ? \"faceup\" : \"facedown\";\n        }\n\n        if (this.data.position) {\n            this.prevPosition = card.position;\n            card.position = this.data.position;\n        }\n\n        if (this.shouldMoveMaterials(card, zoneData)) {\n            this.commands.push(new XYZMoveMaterialsCommand({\n                player: this.data.player,\n                id: this.data.id,\n                originZone: this.data.originZone,\n                zone: \"GY\"\n            }));\n        }\n\n        if (this.commands.length > 0) {\n            this.execMultipleChildCommand(this.commands);\n        }\n\n        // TODO IF PENDULUMN send cards to Extra Deck\n        this.YGO.state.moveCard(card, this.data.originZone, this.data.zone);\n\n        if (zoneData.zone === \"ED\") { // if sent to ED say the cardIndex\n            const extraDeckIndex = field.extraDeck.findIndex(c => c === card);\n            if (extraDeckIndex !== -1) {\n                this.data.zone = YGOGameUtils.createZone(zoneData.zone, zoneData.player, extraDeckIndex + 1);\n            }\n        }\n\n        if (log) {\n            this.YGO.duelLog.dispatch<any>({\n                player: this.data.player,\n                commandId: this.getCommandId(),\n                type: this.type as any,\n                id: this.data.id,\n                originZone: this.data.originZone,\n                zone: this.data.zone,\n                reason: this.data.reason,\n                position: card.position\n            });\n        }\n    }\n\n    override undo(): void {\n        console.log(`Undo: ${this.data.type} ${this.data.id} from: ${this.data.originZone} to: ${this.data.zone}`);\n\n        const card = this.YGO.state.getCardById(this.data.id, this.data.zone);\n\n        card.owner = this.prevOwner;\n        card.currentAtk = this.prevAtk;\n        card.currentDef = this.prevDef;\n\n        if (this.prevPosition) {\n            card.position = this.prevPosition;\n        }\n\n        this.YGO.state.moveCard(card, this.data.zone, this.data.originZone);\n\n        if (this.commands.length > 0) {\n            this.undoMultipleChildCommand(this.commands);\n            this.commands = [];\n        }\n    }\n\n    private shouldMoveMaterials(card: Card, zoneData: FieldZoneData): boolean {\n        if (!card.materials || card.materials.length === 0) return false;\n        if (zoneData.zone === \"GY\") return true;\n        if (zoneData.zone === \"B\") return true;\n        return false;\n    }\n}","import { BaseCommand } from './BaseCommand';\nimport { BanishCommandData, Command } from '../types/commands';\nimport { FieldZone } from '../types/types';\nimport { MoveCardCommand } from './MoveCardCommand';\nimport { YGOGameUtils } from '../game/YGOGameUtils';\nimport { YGOCore } from '../game/YGOCore';\n\nexport class BanishCommand extends BaseCommand {\n    public baseType: string = \"BanishCommand\";\n    private data: BanishCommandData;\n    private zone!: FieldZone;\n    private banishCommand!: Command;\n\n    constructor(data: BanishCommandData) {\n        super();\n        this.data = data;\n        this.data.position = this.data.position || \"faceup\"\n        this.type = this.data.position === \"faceup\" ? \"Banish\" : \"Banish FD\";\n    }\n\n    init(ygo: YGOCore): void {\n        super.init(ygo);\n\n        const card = this.YGO.state.getCardById(this.data.id, this.data.originZone);\n        this.zone = YGOGameUtils.createZone(\"B\", card.originalOwner, 1);\n\n        this.banishCommand = new MoveCardCommand({\n            player: this.data.player,\n            type: this.type,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            position: this.data.position,\n            zone: this.zone\n        });\n    }\n\n    exec(): void {\n        this.execChildCommand(this.banishCommand);\n    }\n\n    undo(): void {\n        this.undoChildCommand(this.banishCommand);\n    }\n}","import { BaseCommand } from './BaseCommand';\nimport { ChangeCardAtkDefCommandData } from '../types/commands';\nimport { YGODuelEvents } from '../types/duel-events';\nimport { YGOUtils } from '../game/YGOUtils';\n\nexport class ChangeCardAtkDefCommand extends BaseCommand {\n    public baseType: string = \"ChangeCardAtkDefCommand\";\n    private data: ChangeCardAtkDefCommandData;\n    private oldAtk: number;\n    private oldDef: number;\n\n    constructor(data: ChangeCardAtkDefCommandData) {\n        super();\n        this.type = \"Change Card Atk Def\";\n        this.data = data;\n        this.oldAtk = 0;\n        this.oldDef = 0;\n    }\n\n    override exec(): void {\n        const card = this.YGO.state.getCardById(this.data.id, this.data.originZone)!;\n\n        this.oldAtk = card.currentAtk;\n        this.oldDef = card.currentDef;\n\n        if (YGOUtils.isNumeric(this.data.atk)) {\n            card.currentAtk = Number(this.data.atk);\n        }\n\n        if (YGOUtils.isNumeric(this.data.def)) {\n            card.currentDef = Number(this.data.def);\n        }\n\n        this.YGO.duelLog.dispatch<YGODuelEvents.ChangeCardAtkDef>({\n            player: this.data.player,\n            commandId: this.getCommandId(),\n            type: YGODuelEvents.LogType.ChangeCardAtkDef,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            atk: card.currentAtk,\n            def: card.currentDef,\n            oldAtk: this.oldAtk,\n            oldDef: this.oldDef,\n        });\n    }\n\n    override undo(): void {\n        const card = this.YGO.state.getCardById(this.data.id, this.data.originZone);\n        card.currentAtk = this.oldAtk;\n        card.currentDef = this.oldDef;\n    }\n}","import { BaseCommand } from './BaseCommand';\nimport { ChangeCardPositionCommandData } from '../types/commands';\nimport { CardPosition } from '../types/types';\nimport { YGODuelEvents } from '../types/duel-events';\n\nexport class ChangeCardPositionCommand extends BaseCommand {\n    public baseType: string = \"ChangeCardPositionCommand\";\n    private data: ChangeCardPositionCommandData;\n    private prevPosition: CardPosition | undefined;\n\n    constructor(data: ChangeCardPositionCommandData) {\n        super();\n        this.type = \"Change Card Position\";\n        this.data = data;\n    }\n\n    override exec(): void {\n        const card = this.YGO.state.getCardById(this.data.id, this.data.originZone)!;\n\n        this.prevPosition = card.position;\n\n        card.position = this.data.position;\n\n        this.YGO.duelLog.dispatch<YGODuelEvents.ChangeCardPosition>({\n            player: this.data.player,\n            commandId: this.getCommandId(),\n            type: YGODuelEvents.LogType.ChangeCardPosition,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            previousPosition: this.prevPosition,\n            position: this.data.position,\n        });\n    }\n\n    override undo(): void {\n        const card = this.YGO.state.getCardById(this.data.id, this.data.originZone);\n\n        if (this.prevPosition) {\n            card.position = this.prevPosition;\n        }\n    }\n}","import { BaseCommand } from './BaseCommand';\nimport { Command, DestroyCardCommandData } from '../types/commands';\nimport { FieldZone } from '../types/types';\nimport { MoveCardCommand } from './MoveCardCommand';\nimport { YGOGameUtils } from '../game/YGOGameUtils';\n\nexport class DestroyCardCommand extends BaseCommand {\n    public baseType: string = \"DestroyCardCommand\";\n    private data: DestroyCardCommandData;\n    private zone: FieldZone;\n    private moveCardCommand: Command;\n\n    constructor(data: DestroyCardCommandData) {\n        super();\n\n        this.type = \"Destroy\";\n        this.data = data;\n        this.zone = data.zone || YGOGameUtils.createZone(\"GY\", this.data.player, 1);\n\n        this.moveCardCommand = new MoveCardCommand({\n            player: this.data.player,\n            type: this.type,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            zone: this.zone\n        });\n    }\n\n    exec(): void {\n        this.execChildCommand(this.moveCardCommand);\n    }\n\n    undo(): void {\n        this.undoChildCommand(this.moveCardCommand);\n    }\n}","import { BaseCommand } from './BaseCommand';\nimport { DrawFromDeckCommandData } from '../types/commands';\nimport { Card } from '../types/types';\nimport { YGODuelEvents } from '../types/duel-events';\nimport { YGOGameUtils } from '../game/YGOGameUtils';\n\nexport class DrawFromDeckCommand extends BaseCommand {\n    public baseType: string = \"DrawFromDeckCommand\";\n    private data: DrawFromDeckCommandData;\n    private cards: Card[];\n\n    constructor(data: DrawFromDeckCommandData) {\n        super();\n\n        this.type = \"Draw From Deck\";\n        this.data = data;\n        this.data.numberOfCards = this.data.numberOfCards || 1;\n        this.cards = [];\n    }\n\n    exec(): void {\n        console.log(`Exec: Draw ${this.data.numberOfCards} from Deck`);\n\n        this.cards = [];\n\n        const field = this.YGO.state.fields[this.data.player];\n\n        for (let i = 0; i < this.data.numberOfCards!; ++i) {\n            const card = field.mainDeck.pop()!;\n            console.log(\"DRAW\", card.name);\n\n            field.hand.push(card);\n            this.cards.push(card);\n\n            const originZone = YGOGameUtils.createZone(\"D\", this.data.player, field.mainDeck.length - 1);\n            const zone = YGOGameUtils.createZone(\"H\", this.data.player, field.hand.length);\n\n            this.YGO.duelLog.dispatch<YGODuelEvents.DrawFromDeck>({\n                commandId: this.getCommandId(),\n                player: this.data.player,\n                type: YGODuelEvents.LogType.DrawCardFromDeck,\n                id: card.id,\n                originZone,\n                zone,\n            });\n        }\n    }\n\n    undo(): void {\n        console.log(`Undo: Draw ${this.data.numberOfCards} from Deck`);\n\n        const newCards = [...this.cards].reverse();\n        const field = this.YGO.state.fields[this.data.player];\n\n        console.log(\"CARD DRAW UNDO\");\n        console.log(newCards.map(c => c.name));\n        console.log(\"DECK 1>>\", field.mainDeck.length);\n        for (const card of newCards) {\n            const cardInHandIndex = field.hand.findIndex(c => c === card);\n            if (cardInHandIndex !== -1) {\n                field.hand.splice(cardInHandIndex, 1);\n            }\n        }\n        field.mainDeck.push(...newCards);\n\n        console.log(field.hand.map(c => c.name));\n        console.log(\"DECK 2>>\", field.mainDeck.length);\n    }\n}\n","import { BaseCommand } from './BaseCommand';\nimport { RevealCommandData } from '../types/commands';\nimport { YGODuelEvents } from '../types/duel-events';\n\nexport class RevealCommand extends BaseCommand {\n    public baseType: string = \"RevealCommand\";\n    private data: RevealCommandData;\n\n    constructor(data: RevealCommandData) {\n        super();\n        this.type = \"Reveal\";\n        this.data = data;\n    }\n\n    override exec(): void {\n        this.YGO.duelLog.dispatch<YGODuelEvents.Reveal>({\n            type: YGODuelEvents.LogType.Reveal,\n            player: this.data.player,\n            commandId: this.getCommandId(),\n            id: this.data.id,\n            originZone: this.data.originZone\n        })\n    }\n}","import { BaseCommand } from './BaseCommand';\nimport { Command, SendCardToGYCommandData } from '../types/commands';\nimport { FieldZone } from '../types/types';\nimport { MoveCardCommand } from './MoveCardCommand';\nimport { YGOGameUtils } from '../game/YGOGameUtils';\nimport { YGOCore } from '../game/YGOCore';\n\nexport class SendCardToGYCommand extends BaseCommand {\n    public baseType: string = \"SendCardToGYCommand\";\n    private data: SendCardToGYCommandData;\n    private zone!: FieldZone;\n    private moveCardCommand!: Command;\n\n    constructor(data: SendCardToGYCommandData) {\n        super();\n\n        this.type = \"Send To GY\";\n        this.data = data;\n    }\n    init(ygo: YGOCore): void {\n        super.init(ygo);\n\n        const card = this.YGO.state.getCardById(this.data.id, this.data.originZone);\n        this.zone = this.data.zone || YGOGameUtils.createZone(\"GY\", card.originalOwner, 1);\n\n        this.moveCardCommand = new MoveCardCommand({\n            player: this.data.player,\n            type: this.type,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            reason: this.data.reason,\n            position: \"faceup\",\n            zone: this.zone\n        });\n    }\n\n    exec(): void {\n        this.execChildCommand(this.moveCardCommand);\n    }\n\n    undo(): void {\n        this.undoChildCommand(this.moveCardCommand);\n    }\n}","import { BaseCommand } from './BaseCommand';\nimport { Command, FieldSpellCommandData } from '../types/commands';\nimport { MoveCardCommand } from './MoveCardCommand';\nimport { RevealCommand } from './RevealCommand';\nimport { SendCardToGYCommand } from './SendCardToGY';\nimport { YGOGameUtils } from '../game/YGOGameUtils';\nimport { YGOCore } from '../game/YGOCore';\n\nexport class FieldSpellCommand extends BaseCommand {\n    public baseType: string = \"FieldSpellCommand\";\n    private data: FieldSpellCommandData;\n    private commands: Command[];\n\n    constructor(data: FieldSpellCommandData) {\n        super();\n\n        this.type = \"Field Spell\";\n        this.data = data;\n        this.data.position = data.position === \"facedown\" ? \"facedown\" : \"faceup\";\n        this.commands = [];\n    }\n\n    init(ygo: YGOCore): void {\n        super.init(ygo);\n\n        const fieldCard = this.YGO.getField(this.data.player).fieldZone;\n\n        if (fieldCard) {\n            this.commands.splice(0, 1, new SendCardToGYCommand({\n                player: this.data.player,\n                id: fieldCard.id,\n                originZone: YGOGameUtils.createZone(\"F\", this.data.player)\n            }));\n        }\n\n        this.commands.push(new MoveCardCommand({\n            player: this.data.player,\n            type: this.type,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            zone: this.data.zone,\n            position: this.data.position\n        }));\n\n        if (this.data.reveal) {\n            this.commands.push(new RevealCommand({\n                id: this.data.id,\n                originZone: this.data.zone,\n                player: this.data.player\n            }));\n        }\n    }\n\n    override exec(): void {\n        this.execMultipleChildCommand(this.commands);\n    }\n\n    override undo(): void {\n        this.undoMultipleChildCommand(this.commands);\n    }\n}","import { BaseCommand } from './BaseCommand';\nimport { FlipCommandData } from '../types/commands';\nimport { CardPosition } from '../types/types';\nimport { YGOGameUtils } from '../game/YGOGameUtils';\nimport { YGODuelEvents } from '../types/duel-events';\n\nexport class FlipCommand extends BaseCommand {\n    public baseType: string = \"FlipCommand\";\n    private data: FlipCommandData;\n    private prevPosition: CardPosition | undefined;\n\n    constructor(data: FlipCommandData) {\n        super();\n        this.type = \"Flip\";\n        this.data = data;\n    }\n\n    override exec(): void {\n        const card = this.YGO.state.getCardById(this.data.id, this.data.originZone)!;\n\n        this.prevPosition = card.position;\n\n        if (YGOGameUtils.isFaceDown(card)) {\n            card.position = \"faceup-attack\";\n        } else {\n            card.position = \"faceup-defense\";\n        }\n\n        this.YGO.duelLog.dispatch<YGODuelEvents.Flip>({\n            type: YGODuelEvents.LogType.Flip,\n            commandId: this.getCommandId(),\n            player: this.data.player,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            previousPosition: this.prevPosition,\n            position: card.position,\n        })\n    }\n\n    override undo(): void {\n        const card = this.YGO.state.getCardById(this.data.id, this.data.originZone);\n\n        if (this.prevPosition) {\n            card.position = this.prevPosition;\n        }\n    }\n}","import { BaseCommand } from './BaseCommand';\nimport { Command, FusionSummonCommandData } from '../types/commands';\nimport { MoveCardCommand } from './MoveCardCommand';\nimport { SendCardToGYCommand } from './SendCardToGY';\nimport { YGODuelEvents } from '../types/duel-events';\nimport { YGOCore } from '../game/YGOCore';\nimport { FieldZone } from '../types/types';\nimport { YGOGameUtils } from '../game/YGOGameUtils';\n\nexport class FusionSummonCommand extends BaseCommand {\n    public baseType: string = \"FusionSummonCommand\";\n    private data: FusionSummonCommandData;\n    private materialsCommands: Command[];\n    private commands: Command[];\n    private materials: { id: number, zone: FieldZone, owner: number }[] = [];\n\n    constructor(data: FusionSummonCommandData) {\n        super();\n        this.type = \"Fusion Summon\";\n        this.data = data;\n        this.data.position = this.data.position || \"faceup-attack\";\n        this.commands = [];\n        this.materialsCommands = [];\n    }\n\n    init(ygo: YGOCore): void {\n        super.init(ygo);\n\n        const materialsWithZoneData = this.data.materials.map(material => {\n            return {\n                material,\n                zoneData: YGOGameUtils.getZoneData(material.zone)\n            }\n        })\n\n        materialsWithZoneData.sort((m1, m2) => m2.zoneData.zoneIndex - m1.zoneData.zoneIndex);\n\n        this.materials = materialsWithZoneData.map(({ material }) => {\n            const materialCard = this.YGO.state.getCardById(material.id, material.zone);\n\n            this.materialsCommands.push(new SendCardToGYCommand({\n                player: this.data.player,\n                id: material.id,\n                originZone: material.zone,\n                reason: \"Fusion Summon\"\n            }));\n\n            return {\n                id: material.id,\n                zone: material.zone,\n                owner: materialCard.originalOwner,\n            }\n        });\n\n        this.commands.push(new MoveCardCommand({\n            player: this.data.player,\n            type: this.type,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            zone: this.data.zone,\n            position: this.data.position,\n            log: false\n        }));\n    }\n\n    override exec(): void {\n        this.execMultipleChildCommand(this.materialsCommands);\n        this.execMultipleChildCommand(this.commands);\n\n        this.YGO.duelLog.dispatch<YGODuelEvents.FusionSummon>({\n            player: this.data.player,\n            commandId: this.getCommandId(),\n            type: YGODuelEvents.LogType.FusionSummon,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            position: this.data.position!,\n            zone: this.data.zone,\n            materials: this.materials\n        });\n    }\n\n    override undo(): void {\n\n        for (let i = this.materialsCommands.length - 1; i >= 0; --i) {\n            this.undoChildCommand(this.materialsCommands[i]);\n        }\n\n        this.undoMultipleChildCommand(this.commands);\n    }\n}","import { BaseCommand } from './BaseCommand';\nimport { Command, LinkSummonCommandData } from '../types/commands';\nimport { MoveCardCommand } from './MoveCardCommand';\nimport { SendCardToGYCommand } from './SendCardToGY';\nimport { YGODuelEvents } from '../types/duel-events';\nimport { CardPosition, FieldZone } from '../types/types';\nimport { YGOCore } from '../game/YGOCore';\nimport { YGOGameUtils } from '../game/YGOGameUtils';\n\nexport class LinkSummonCommand extends BaseCommand {\n    public baseType: string = \"LinkSummonCommand\";\n    private data: LinkSummonCommandData;\n    private commands: Command[];\n    private position: CardPosition;\n    private materials: { id: number, zone: FieldZone, owner: number }[] = [];\n\n    constructor(data: LinkSummonCommandData) {\n        super();\n        this.type = \"Link Summon\";\n        this.data = data;\n        this.position = \"faceup-attack\";\n        this.commands = [];\n    }\n    init(ygo: YGOCore): void {\n        super.init(ygo);\n\n        this.materials = this.data.materials.map(material => {\n            const materialCard = this.YGO.state.getCardById(material.id, material.zone);\n\n            this.commands.push(new SendCardToGYCommand({\n                player: this.data.player,\n                id: material.id,\n                originZone: material.zone,\n                reason: \"Link Summon\"\n            }));\n\n            return {\n                id: material.id,\n                zone: material.zone,\n                owner: materialCard.originalOwner,\n            }\n        });\n\n        const card = this.YGO.state.getCardById(this.data.id, this.data.originZone);\n        const zoneData = YGOGameUtils.getZoneData(this.data.zone);\n\n        if (zoneData.zone === \"EMZ\") {\n            this.data.zone = YGOGameUtils.createZone(zoneData.zone, card.originalOwner, zoneData.zoneIndex);\n        }\n\n        this.commands.push(new MoveCardCommand({\n            player: this.data.player,\n            type: this.type,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            zone: this.data.zone,\n            position: this.position,\n            log: false\n        }));\n    }\n\n    override exec(): void {\n        this.execMultipleChildCommand(this.commands);\n\n        this.YGO.duelLog.dispatch<YGODuelEvents.LinkSummon>({\n            player: this.data.player,\n            commandId: this.getCommandId(),\n            type: YGODuelEvents.LogType.LinkSummon,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            zone: this.data.zone,\n            materials: this.materials\n        });\n    }\n\n    override undo(): void {\n        this.undoMultipleChildCommand(this.commands);\n    }\n}","import { BaseCommand } from './BaseCommand';\nimport { Command, MillFromDeckCommandData } from '../types/commands';\nimport { SendCardToGYCommand } from './SendCardToGY';\nimport { YGOCore } from '../game/YGOCore';\nimport { YGOGameUtils } from '../game/YGOGameUtils';\n\nexport class MillFromDeckCommand extends BaseCommand {\n    public baseType: string = \"MillFromDeckCommand\";\n    private data: MillFromDeckCommandData;\n    private commands: Command[];\n\n    constructor(data: MillFromDeckCommandData) {\n        super();\n\n        this.type = \"Mill From Deck\";\n        const { numberOfCards = 1 } = data;\n        this.data = data;\n        this.data.numberOfCards = Math.max(1, numberOfCards);\n        this.commands = [];\n    }\n\n    override init(ygo: YGOCore): void {\n        super.init(ygo);\n\n        const field = this.YGO.getField(this.data.player);\n        const numberOfCards = Math.min(this.data.numberOfCards!, field.mainDeck.length);\n\n        for (let i = 0; i < numberOfCards!; ++i) {\n            const cardIndex = field.mainDeck.length - 1 - i;\n            const card = field.mainDeck[cardIndex];\n\n            // TODO LOG THIS SHIT :)\n\n            this.commands.push(new SendCardToGYCommand({\n                id: card.id,\n                originZone: YGOGameUtils.createZone(\"D\", this.data.player, cardIndex + 1),\n                player: this.data.player\n            }))\n        }\n    }\n\n    exec(): void {\n        this.execMultipleChildCommand(this.commands);\n    }\n\n    undo(): void {\n        this.undoMultipleChildCommand(this.commands);\n    }\n}\n","import { BaseCommand } from './BaseCommand';\nimport { Command, NormalSummonCommandData } from '../types/commands';\nimport { MoveCardCommand } from './MoveCardCommand';\n\nexport class NormalSummonCommand extends BaseCommand {\n    public baseType: string = \"NormalSummonCommand\";\n    private data: NormalSummonCommandData;\n    private moveCardCommand: Command;\n\n    constructor(data: NormalSummonCommandData) {\n        super();\n        this.type = \"Normal Summon\";\n        this.data = data;\n        this.data.position = \"faceup-attack\";\n\n        this.moveCardCommand = new MoveCardCommand({\n            player: this.data.player,\n            type: this.type,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            zone: this.data.zone,\n            position: this.data.position\n        });\n    }\n\n    override exec(): void {\n        this.execChildCommand(this.moveCardCommand);\n    }\n\n    override undo(): void {\n        this.undoChildCommand(this.moveCardCommand);\n    }\n}","import { BaseCommand } from './BaseCommand';\nimport { Command, SetCardCommandData } from '../types/commands';\nimport { MoveCardCommand } from './MoveCardCommand';\nimport { CardPosition } from '../types/types';\nimport { RevealCommand } from './RevealCommand';\nimport { YGOCore } from '../game/YGOCore';\nimport { YGOGameUtils } from '../game/YGOGameUtils';\nimport { YGODuelEvents } from '../types/duel-events';\n\nexport class SetCardCommand extends BaseCommand {\n    public baseType: string = \"SetCardCommand\";\n    private data: SetCardCommandData;\n    private prevPosition: CardPosition | undefined;\n    private isMonster: boolean;\n    private commands: Command[];\n\n    constructor(data: SetCardCommandData) {\n        super();\n        this.type = \"Set ST\";\n        this.isMonster = false;\n        this.data = data;\n        this.commands = [];\n    }\n\n    init(ygo: YGOCore) {\n        super.init(ygo);\n\n        const card = this.YGO.state.getCardById(this.data.id, this.data.originZone);\n        this.isMonster = YGOGameUtils.isMonster(card);\n        this.type = this.isMonster ? \"Set Monster\" : \"Set ST\";\n\n        this.commands = [];\n\n        if (this.data.zone) {\n            this.commands.push(new MoveCardCommand({\n                player: this.data.player,\n                type: this.type,\n                id: this.data.id,\n                originZone: this.data.originZone,\n                zone: this.data.zone,\n                position: \"facedown\"\n            }));\n\n            if (this.data.reveal) {\n                this.commands.push(new RevealCommand({\n                    player: this.data.player,\n                    id: this.data.id,\n                    originZone: this.data.zone,\n                }));\n            }\n        }\n    }\n\n    exec(): void {\n        if (this.commands.length > 0) {\n            this.execMultipleChildCommand(this.commands);\n        } else {\n            const card = this.YGO.state.getCardById(this.data.id, this.data.originZone);\n            this.prevPosition = card.position;\n            card.position = \"facedown\";\n\n            if (this.type === \"Set Monster\") {\n                this.YGO.duelLog.dispatch<YGODuelEvents.SetMonster>({\n                    type: YGODuelEvents.LogType.SetMonster,\n                    commandId: this.getCommandId(),\n                    player: this.data.player,\n                    id: this.data.id,\n                    originZone: this.data.originZone,\n                })\n            } else {\n                this.YGO.duelLog.dispatch<YGODuelEvents.SetMonster>({\n                    type: YGODuelEvents.LogType.SetST,\n                    commandId: this.getCommandId(),\n                    player: this.data.player,\n                    id: this.data.id,\n                    originZone: this.data.originZone,\n                })\n            }\n        }\n    }\n\n    undo(): void {\n        if (this.commands.length > 0) {\n            this.undoMultipleChildCommand(this.commands);\n        }\n\n        if (this.prevPosition) {\n            const card = this.YGO.state.getCardById(this.data.id, this.data.originZone);\n            card.position = this.prevPosition;\n        }\n    }\n}","import { BaseCommand } from './BaseCommand';\nimport { Command, SetMonsterCommandData } from '../types/commands';\nimport { MoveCardCommand } from './MoveCardCommand';\n\nexport class SetMonsterCommand extends BaseCommand {\n    public baseType: string = \"SetMonsterCommand\";\n    private data: SetMonsterCommandData;\n    private moveCardCommand: Command;\n\n    constructor(data: SetMonsterCommandData) {\n        super();\n        this.type = \"Set Monster\";\n        this.data = data;\n        this.moveCardCommand = new MoveCardCommand({\n            player: this.data.player,\n            type: this.type,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            zone: this.data.zone,\n            position: \"facedown\"\n        });\n    }\n\n    exec(): void {\n        this.execChildCommand(this.moveCardCommand);\n    }\n\n    undo(): void {\n        this.undoChildCommand(this.moveCardCommand);\n    }\n}","import { BaseCommand } from './BaseCommand';\nimport { ShuffleDeckCommandData } from '../types/commands';\nimport { YGODuelEvents } from '../types/duel-events';\nimport { YGOGameUtils } from '../game/YGOGameUtils';\n\nexport class ShuffleDeckCommand extends BaseCommand {\n    public baseType: string = \"ShuffleDeckCommand\";\n    private data: ShuffleDeckCommandData;\n    private cardPositions!: Array<number>;\n\n    constructor(data: ShuffleDeckCommandData) {\n        super();\n        this.data = data;\n        this.type = \"Shuffle Deck\";\n    }\n\n    exec(): void {\n        console.log(\"--------------------\\n\\nSHUFFLE DECK \\n\\n------------------------\");\n        const mainDeck = this.YGO.state.fields[this.data.player].mainDeck;\n\n        if (this.cardPositions) {\n            for (let i = 0; i < this.cardPositions.length; ++i) {\n                const index = this.cardPositions[i];\n                const temp = mainDeck[index];\n                mainDeck[index] = mainDeck[i];\n                mainDeck[i] = temp;\n            }\n        } else {\n            this.cardPositions = YGOGameUtils.shuffleCards(mainDeck);\n        }\n\n        if (this.data.log !== false) {\n            this.YGO.duelLog.dispatch<YGODuelEvents.Shuffle>({\n                player: this.data.player,\n                commandId: this.getCommandId(),\n                type: YGODuelEvents.LogType.Shuffle\n            });\n        }\n    }\n\n    undo(): void {\n        const mainDeck = this.YGO.state.fields[this.data.player].mainDeck;\n        for (let i = 0; i < this.cardPositions.length; ++i) {\n            const index = this.cardPositions[i];\n            const temp = mainDeck[index];\n            mainDeck[index] = mainDeck[i];\n            mainDeck[i] = temp;\n        }\n    }\n}\n","import { BaseCommand } from './BaseCommand';\nimport { Command, SpecialSummonCommandData } from '../types/commands';\nimport { MoveCardCommand } from './MoveCardCommand';\n\nexport class SpecialSummonCommand extends BaseCommand {\n    public baseType: string = \"SpecialSummonCommand\";\n    private data: SpecialSummonCommandData;\n    private moveCardCommand: Command;\n\n    constructor(data: SpecialSummonCommandData) {\n        super();\n        this.type = \"Special Summon\";\n        this.data = data;\n        this.data.position = this.data.position || 'faceup-attack';\n\n        if (this.data.position !== 'faceup-attack'\n            && this.data.position !== 'faceup-defense') {\n            this.data.position = 'faceup-attack';\n        }\n\n        this.moveCardCommand = new MoveCardCommand({\n            player: this.data.player,\n            type: \"Special Summon\",\n            id: this.data.id,\n            originZone: this.data.originZone,\n            zone: this.data.zone,\n            position: this.data.position\n        });\n    }\n\n    exec(): void {\n        this.execChildCommand(this.moveCardCommand);\n    }\n\n    undo(): void {\n        this.undoChildCommand(this.moveCardCommand);\n    }\n}","import { BaseCommand } from './BaseCommand';\nimport { StartHandCommandData } from '../types/commands';\nimport { Card, FieldZone } from '../types/types';\nimport { YGODuelEvents } from '../types/duel-events';\nimport { YGOGameUtils } from '../game/YGOGameUtils';\n\nexport class StartHandCommand extends BaseCommand {\n    public baseType: string = \"StartHandCommand\";\n    private data: StartHandCommandData;\n    private cards: Card[];\n\n    constructor(data: StartHandCommandData) {\n        super();\n        this.type = \"Start Hand\";\n        this.data = data;\n        this.cards = [];\n        (this as any).core = true;\n    }\n\n    exec(): void {\n        const field = this.YGO.getField(this.data.player);\n\n        if (this.cards.length > 0) {\n            for (let i = 0; i < this.cards.length; ++i) {\n                const card = field.mainDeck.shift();\n                if (card) {\n                    field.hand.push(card);\n                }\n            }\n        } else if (field.hand.length > 0) {\n            this.cards = [...field.hand];\n        } else {\n            this.cards = [];\n            const numCardsToDraw = Math.min(this.data.numberOfCards, field.mainDeck.length);\n\n            for (let i = 0; i < numCardsToDraw; ++i) {\n                const card = field.mainDeck.shift();\n                if (card) {\n                    field.hand.push(card);\n                    this.cards.push(card);\n                }\n            }\n        }\n\n        const cards: { id: number, zone: FieldZone }[] = this.cards.map((card, handIndex) => {\n            return {\n                id: card.id,\n                zone: YGOGameUtils.createZone(\"H\", this.data.player, handIndex + 1)\n            };\n        });\n\n        this.YGO.duelLog.dispatch<YGODuelEvents.StartHand>({\n            commandId: this.getCommandId(),\n            player: this.data.player,\n            type: YGODuelEvents.LogType.StartHand,\n            cards,\n            core: true,\n        });\n    }\n\n    undo(): void {\n        const field = this.YGO.state.fields[this.data.player];\n        field.hand = [];\n        field.mainDeck.unshift(...this.cards);\n    }\n}\n","import { BaseCommand } from './BaseCommand';\nimport { Command, SynchroSummonCommandData } from '../types/commands';\nimport { MoveCardCommand } from './MoveCardCommand';\nimport { SendCardToGYCommand } from './SendCardToGY';\nimport { YGODuelEvents } from '../types/duel-events';\n\nexport class SynchroSummonCommand extends BaseCommand {\n    public baseType: string = \"SynchroSummonCommand\";\n    private data: SynchroSummonCommandData;\n    private commands: Command[];\n\n    constructor(data: SynchroSummonCommandData) {\n        super();\n        this.type = \"Synchro Summon\";\n        this.data = data;\n        this.data.position = this.data.position || \"faceup-attack\";\n        this.commands = [];\n\n        this.data.materials.forEach(material => {\n            this.commands.push(new SendCardToGYCommand({\n                player: this.data.player,\n                id: material.id,\n                originZone: material.zone,\n                reason: \"Synchro Summon\"\n            }));\n        });\n\n        this.commands.push(new MoveCardCommand({\n            player: this.data.player,\n            type: this.type,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            zone: this.data.zone,\n            position: this.data.position,\n            log: false\n        }));\n    }\n\n    override exec(): void {\n        this.execMultipleChildCommand(this.commands);\n\n        this.YGO.duelLog.dispatch<YGODuelEvents.SynchroSummon>({\n            player: this.data.player,\n            commandId: this.getCommandId(),\n            type: YGODuelEvents.LogType.SynchroSummon,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            position: this.data.position!,\n            zone: this.data.zone,\n            materials: this.data.materials\n        });\n    }\n\n    override undo(): void {\n        this.undoMultipleChildCommand(this.commands);\n    }\n}","import { BaseCommand } from './BaseCommand';\nimport { TargetCommandData } from '../types/commands';\nimport { YGODuelEvents } from '../types/duel-events';\n\nexport class TargetCommand extends BaseCommand {\n    public baseType: string = \"TargetCommand\";\n    private data: TargetCommandData;\n\n    constructor(data: TargetCommandData) {\n        super();\n        this.type = \"Target\";\n        this.data = data;\n    }\n\n    override exec(): void {\n        this.YGO.duelLog.dispatch<YGODuelEvents.Target>({\n            type: YGODuelEvents.LogType.Target,\n            player: this.data.player,\n            commandId: this.getCommandId(),\n            id: this.data.id,\n            originZone: this.data.originZone\n        });\n    }\n}","import { BaseCommand } from './BaseCommand';\nimport { Command, ToDeckCommandData } from '../types/commands';\nimport { FieldZone } from '../types/types';\nimport { MoveCardCommand } from './MoveCardCommand';\nimport { ShuffleDeckCommand } from './ShuffleDeck';\nimport { YGOCore } from '../game/YGOCore';\nimport { YGOGameUtils } from '../game/YGOGameUtils';\n\nexport class ToDeckCommand extends BaseCommand {\n    public baseType: string = \"ToDeckCommand\";\n    private data: ToDeckCommandData;\n    private zone!: FieldZone;\n    private commands!: Command[];\n\n    constructor(data: ToDeckCommandData) {\n        super();\n        this.data = data;\n        this.type = this.getCommandType();\n    }\n\n    private isTopCard() {\n        return this.data.position === \"top\";\n    }\n\n    private getCommandType() {\n        return this.isTopCard() ? \"To Top Deck\" : \"To Bottom Deck\";\n    }\n\n    private getDeckIndex(): number {\n        const mainDeck = this.YGO.state.fields[this.data.player].mainDeck;\n\n        if (this.isTopCard()) {\n            return mainDeck.length + 1;\n        }\n\n        return 1;\n    }\n\n    override init(ygo: YGOCore): void {\n        super.init(ygo);\n\n        if (!this.commands) {\n            const { player, shuffle = false } = this.data;\n\n            const deckIndex = this.getDeckIndex();\n            this.zone = YGOGameUtils.createZone(\"D\", player, deckIndex);\n            this.commands = [];\n            this.commands.push(new MoveCardCommand({\n                player: this.data.player,\n                type: this.type,\n                id: this.data.id,\n                originZone: this.data.originZone,\n                zone: this.zone,\n            }));\n\n            if (shuffle) {\n                this.commands.push(new ShuffleDeckCommand({ player: this.data.player }));\n            }\n        }\n    }\n\n    exec(): void {\n        this.execMultipleChildCommand(this.commands);\n    }\n\n    undo(): void {\n        this.undoMultipleChildCommand(this.commands);\n    }\n}","import { BaseCommand } from './BaseCommand';\nimport { Command, ToExtraDeckCommandData } from '../types/commands';\nimport { MoveCardCommand } from './MoveCardCommand';\nimport { YGOGameUtils } from '../game/YGOGameUtils';\nimport { YGOCore } from '../game/YGOCore';\n\nexport class ToExtraDeckCommand extends BaseCommand {\n    public baseType: string = \"ToExtraDeckCommand\";\n    private data: ToExtraDeckCommandData;\n    private moveCardCommand!: Command;\n\n    constructor(data: ToExtraDeckCommandData) {\n        super();\n        this.type = \"To Extra Deck\";\n        this.data = data;\n    }\n\n    init(ygo: YGOCore): void {\n        super.init(ygo)\n        const card = ygo.state.getCardById(this.data.id, this.data.originZone);\n\n        this.moveCardCommand = new MoveCardCommand({\n            player: this.data.player,\n            type: this.type,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            zone: YGOGameUtils.createZone(\"ED\", card.originalOwner)\n        });\n    }\n\n    override exec(): void {\n        this.execChildCommand(this.moveCardCommand);\n    }\n\n    override undo(): void {\n        this.undoChildCommand(this.moveCardCommand);\n    }\n}","import { BaseCommand } from './BaseCommand';\nimport { Command, ToHandCommandData } from '../types/commands';\nimport { MoveCardCommand } from './MoveCardCommand';\nimport { YGOCore } from '../game/YGOCore';\nimport { YGOGameUtils } from '../game/YGOGameUtils';\n\nexport class ToHandCommand extends BaseCommand {\n    public baseType: string = \"ToHandCommand\";\n    private data: ToHandCommandData;\n    private command!: Command;\n\n    constructor(data: ToHandCommandData) {\n        super();\n        this.type = \"To Hand\";\n        this.data = data;\n    }\n\n    override init(ygo: YGOCore): void {\n        super.init(ygo);\n\n        const handIndex = this.YGO.getField(this.data.player).hand.length + 1;\n\n        this.command = new MoveCardCommand({\n            player: this.data.player,\n            type: this.type,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            zone: YGOGameUtils.createZone(\"H\", this.data.player, handIndex),\n            position: \"facedown\"\n        });\n    }\n\n    override exec(): void {\n        this.execChildCommand(this.command);\n    }\n\n    override undo(): void {\n        this.undoChildCommand(this.command);\n    }\n}","import { BaseCommand } from './BaseCommand';\nimport { Command, ToSTCommandData } from '../types/commands';\nimport { MoveCardCommand } from './MoveCardCommand';\n\nexport class ToSTCommand extends BaseCommand {\n    public baseType: string = \"ToSTCommand\";\n    private data: ToSTCommandData;\n    private moveCardCommand: Command;\n\n    constructor(data: ToSTCommandData) {\n        super();\n        this.type = \"To ST\";\n        this.data = data;\n\n        this.moveCardCommand = new MoveCardCommand({\n            player: this.data.player,\n            type: this.type,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            zone: this.data.zone,\n            position: \"faceup\"\n        });\n    }\n\n    exec(): void {\n        this.execChildCommand(this.moveCardCommand);\n    }\n\n    undo(): void {\n        this.undoChildCommand(this.moveCardCommand);\n    }\n}","import { BaseCommand } from './BaseCommand';\nimport { Command, TributeSummonCommandData } from '../types/commands';\nimport { MoveCardCommand } from './MoveCardCommand';\nimport { SendCardToGYCommand } from './SendCardToGY';\nimport { YGODuelEvents } from '../types/duel-events';\nimport { YGOCore } from '../game/YGOCore';\nimport { FieldZone } from '../types/types';\n\nexport class TributeSummonCommand extends BaseCommand {\n    public baseType: string = \"TributeSummonCommand\";\n    private data: TributeSummonCommandData;\n    private tributes: { id: number, zone: FieldZone, owner: number }[] = [];\n    private commands: Command[];\n\n    constructor(data: TributeSummonCommandData) {\n        super();\n        this.data = data;\n        this.data.position = this.data.position || \"faceup-attack\";\n        this.type = this.data.position === 'faceup-attack' ? \"Tribute Summon\" : \"Tribute Set\";\n        this.commands = [];\n\n\n    }\n\n    init(ygo: YGOCore): void {\n        super.init(ygo);\n\n        this.tributes = this.data.tributes.map(tribute => {\n            const card = this.YGO.state.getCardById(tribute.id, tribute.zone);\n\n            this.commands.push(new SendCardToGYCommand({\n                id: tribute.id,\n                originZone: tribute.zone,\n                player: this.data.player,\n                reason: \"Tribute Summon\"\n            }))\n\n            return {\n                id: card.id,\n                zone: tribute.zone!,\n                owner: card.originalOwner\n            }\n        });\n\n        this.commands.push(new MoveCardCommand({\n            player: this.data.player,\n            type: this.type,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            zone: this.data.zone,\n            position: this.data.position,\n            log: false\n        }));\n\n    }\n\n    exec(): void {\n        this.execMultipleChildCommand(this.commands);\n\n        this.YGO.duelLog.dispatch<YGODuelEvents.TributeSummon>({\n            player: this.data.player,\n            commandId: this.getCommandId(),\n            type: this.type === \"Tribute Summon\" ? YGODuelEvents.LogType.TributeSummon : YGODuelEvents.LogType.TributeSet,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            zone: this.data.zone,\n            tributes: this.tributes,\n            position: this.data.position!\n        });\n    }\n\n    undo(): void {\n        this.undoMultipleChildCommand(this.commands);\n    }\n}\n","import { BaseCommand } from './BaseCommand';\nimport { Command, XYZAttachCommandData as XYZAttachMaterialCommandData } from '../types/commands';\nimport { YGOUtils } from '../game/YGOUtils';\nimport { Card } from '../types/types';\nimport { YGODuelEvents } from '../types/duel-events';\nimport { XYZMoveMaterialsCommand } from './XYZMoveMaterials';\n\nexport class XYZAttachMaterialCommand extends BaseCommand {\n    public baseType: string = \"XYZAttachMaterialCommand\";\n    private data: XYZAttachMaterialCommandData;\n    private materialCardReference!: Card;\n    private moveXYZMaterialsCommand: Command | undefined;\n\n    constructor(data: XYZAttachMaterialCommandData) {\n        super();\n        this.type = \"XYZ Attach Material\";\n        this.data = data;\n    }\n\n    override exec(): void {\n        const card = this.YGO.state.getCardFromZone(this.data.zone)!;\n        this.materialCardReference = this.YGO.state.getCardById(this.data.id, this.data.originZone);\n\n        if (this.materialCardReference.materials.length > 0) {\n            this.moveXYZMaterialsCommand = this.execChildCommand(new XYZMoveMaterialsCommand({\n                id: this.materialCardReference.id,\n                originZone: this.data.originZone,\n                player: this.data.player,\n                zone: \"GY\"\n            }))\n        }\n\n        this.YGO.state.setCard(null, this.data.originZone);\n        card.materials.push(this.materialCardReference);\n\n        console.log(\"TCL:: EXEC ATTACH:: \", this.materialCardReference.name, this.data.originZone);\n\n        const overlayZone = YGOUtils.getOverlayZone(this.data.zone);\n\n        this.YGO.duelLog.dispatch<YGODuelEvents.XYZAttach>({\n            player: this.data.player,\n            commandId: this.getCommandId(),\n            type: YGODuelEvents.LogType.XYZAttachMaterial,\n            id: this.data.id,\n            materialId: this.materialCardReference.id,\n            originZone: this.data.originZone,\n            overlayZone: overlayZone\n        });\n    }\n\n    override undo(): void {\n        const card = this.YGO.state.getCardFromZone(this.data.zone)!;\n        this.YGO.state.setCard(this.materialCardReference, this.data.originZone);\n\n        const materialIndex = card.materials.indexOf(this.materialCardReference);\n        if (materialIndex !== -1) {\n            card.materials.splice(materialIndex, 1);\n        }\n\n        if (this.moveXYZMaterialsCommand) this.undoChildCommand(this.moveXYZMaterialsCommand);\n    }\n}","import { BaseCommand } from './BaseCommand';\nimport { XYZDetachCommandData } from '../types/commands';\nimport { YGOUtils } from '../game/YGOUtils';\nimport { Card } from '../types/types';\nimport { YGODuelEvents } from '../types/duel-events';\nimport { YGOGameUtils } from '../game/YGOGameUtils';\n\nexport class XYZDetachMaterialCommand extends BaseCommand {\n    public baseType: string = \"XYZDetachMaterialCommand\";\n    private data: XYZDetachCommandData;\n    private materialCardReference!: Card;\n\n    constructor(data: XYZDetachCommandData) {\n        super();\n        this.type = \"XYZ Detach Material\";\n        this.data = data;\n    }\n\n    override exec(): void {\n        const card = this.YGO.state.getCardById(this.data.id, this.data.originZone)!;\n        this.materialCardReference = card.materials[this.data.materialIndex];\n        card.materials.splice(this.data.materialIndex, 1);\n\n        this.YGO.state.setCard(this.materialCardReference, YGOGameUtils.createZone(\"GY\", this.materialCardReference.originalOwner));\n\n        const overlayZone = YGOUtils.getOverlayZone(this.data.originZone);\n\n        console.log(\" DETACH \", overlayZone, \">>>\", YGOGameUtils.createZone(\"GY\", this.materialCardReference.originalOwner));\n\n        this.YGO.duelLog.dispatch<YGODuelEvents.XYZDetach>({\n            player: this.data.player,\n            commandId: this.getCommandId(),\n            type: YGODuelEvents.LogType.XYZDetachMaterial,\n            id: card.id,\n            materialIndex: this.data.materialIndex,\n            materialId: this.materialCardReference.id,\n            owner: this.materialCardReference.originalOwner,\n            overlayZone: overlayZone\n        });\n    }\n\n    override undo(): void {\n        const card = this.YGO.state.getCardFromZone(this.data.originZone)!;\n        card.materials.splice(this.data.materialIndex, 0, this.materialCardReference);\n        console.log(\" DETACH UNDO;;\", YGOGameUtils.createZone(\"GY\", this.materialCardReference.originalOwner));\n        this.YGO.state.setCard(null, YGOGameUtils.createZone(\"GY\", this.materialCardReference.originalOwner));\n    }\n\n}","import { BaseCommand } from './BaseCommand';\nimport { Command, XYZSummonCommandData } from '../types/commands';\nimport { MoveCardCommand } from './MoveCardCommand';\nimport { Card, FieldZone } from '../types/types';\nimport { YGOUtils } from '../game/YGOUtils';\nimport { YGODuelEvents } from '../types/duel-events';\nimport { YGOCore } from '../game/YGOCore';\n\nexport class XYZOverlaySummonCommand extends BaseCommand {\n    public baseType: string = \"XYZOverlaySummonCommand\";\n    private data: XYZSummonCommandData;\n    private commands: Command[];\n    private overlayZone: FieldZone;\n    private previousMaterialsData: { card: Card, materials: Card[] }[] = [];\n    private cardMaterials: Card[] = [];\n\n    constructor(data: XYZSummonCommandData) {\n        super();\n        this.type = \"XYZ Overlay Summon\";\n        this.data = data;\n        this.data.position = this.data.position || \"faceup-attack\";\n        this.commands = [];\n        this.overlayZone = YGOUtils.getOverlayZone(this.data.zone);\n        console.log(\"EXEC MATERIALS\");\n    }\n\n    init(ygo: YGOCore): void {\n        super.init(ygo);\n\n        this.cardMaterials = [];\n        this.previousMaterialsData = [];\n\n        this.data.materials.forEach(material => {\n            const card = this.YGO.state.getCardById(material.id, material.zone);\n            const cardMaterials = [...card.materials];\n\n            card.materials = [];\n            this.cardMaterials.push(card);\n            cardMaterials.forEach(material2 => this.cardMaterials.push(material2));\n            this.previousMaterialsData.push({ card, materials: cardMaterials });\n\n            this.commands.push(new XYZMaterialsMove({\n                player: this.data.player,\n                overlayZone: this.overlayZone,\n                id: material.id,\n                zone: material.zone\n            }));\n        });\n\n        this.commands.push(new MoveCardCommand({\n            player: this.data.player,\n            type: this.type,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            zone: this.data.zone,\n            position: this.data.position,\n            log: false\n        }));\n    }\n\n    override exec(): void {\n        const card = this.YGO.state.getCardById(this.data.id, this.data.originZone);\n\n        console.log(\"NEW MATERIALS \", this.cardMaterials);\n        card.materials = this.cardMaterials;\n\n        this.execMultipleChildCommand(this.commands);\n\n        this.YGO.duelLog.dispatch<YGODuelEvents.XYZOverlaySummon>({\n            player: this.data.player,\n            commandId: this.getCommandId(),\n            type: YGODuelEvents.LogType.XYZOverlaySummon,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            zone: this.data.zone,\n            position: this.data.position!,\n            materials: this.data.materials\n        });\n    }\n\n    override undo(): void {\n        const card = this.YGO.state.getCardById(this.data.id, this.data.zone);\n        card.materials = [];\n        this.undoMultipleChildCommand(this.commands);\n\n        this.previousMaterialsData.forEach(data => {\n            data.card.materials = data.materials;\n        });\n    }\n}\n\ninterface XYZMaterialsMoveData {\n    player: number,\n    id: number\n    overlayZone: FieldZone\n    zone: FieldZone\n}\n\nclass XYZMaterialsMove extends BaseCommand {\n    private data: XYZMaterialsMoveData;\n    private card!: Card;\n\n    constructor(data: XYZMaterialsMoveData) {\n        super();\n        this.data = data;\n    }\n\n    exec(): void {\n        this.card = this.YGO.state.getCardById(this.data.id, this.data.zone);\n        this.YGO.state.setCard(null, this.data.zone);\n\n        this.YGO.duelLog.dispatch<YGODuelEvents.XYZOverlay>({\n            player: this.data.player,\n            commandId: this.getCommandId(),\n            type: YGODuelEvents.LogType.XYZOverlay,\n            id: this.data.id,\n            originZone: this.data.zone,\n            overlayZone: this.data.overlayZone\n        });\n    }\n\n    undo(): void {\n        this.YGO.state.setCard(this.card, this.data.zone);\n    }\n}\n","import { BaseCommand } from './BaseCommand';\nimport { Command, XYZSummonCommandData } from '../types/commands';\nimport { MoveCardCommand } from './MoveCardCommand';\nimport { Card, FieldZone } from '../types/types';\nimport { YGOUtils } from '../game/YGOUtils';\nimport { YGODuelEvents } from '../types/duel-events';\nimport { YGOCore } from '../game/YGOCore';\nimport { XYZMoveMaterialsCommand } from './XYZMoveMaterials';\n\nexport class XYZSummonCommand extends BaseCommand {\n    public baseType: string = \"XYZSummonCommand\";\n    private data: XYZSummonCommandData;\n    private commands: Command[];\n    private overlayZone: FieldZone;\n\n    constructor(data: XYZSummonCommandData) {\n        super();\n        this.type = \"XYZ Summon\";\n        this.data = data;\n        this.data.position = this.data.position || \"faceup-attack\";\n        this.commands = [];\n        this.overlayZone = YGOUtils.getOverlayZone(this.data.zone);\n        console.log(\"EXEC MATERIALS\");\n    }\n\n    init(ygo: YGOCore): void {\n        super.init(ygo);\n\n        this.data.materials.forEach(material => {\n            this.commands.push(new XYZMoveMaterialsCommand({\n                player: this.data.player,\n                id: material.id,\n                originZone: material.zone,\n                zone: \"GY\"\n            }));\n        });\n\n        this.data.materials.forEach(material => {\n            this.commands.push(new XYZMaterialsMove({\n                player: this.data.player,\n                overlayZone: this.overlayZone,\n                id: material.id,\n                zone: material.zone\n            }));\n        });\n\n        this.commands.push(new MoveCardCommand({\n            player: this.data.player,\n            type: this.type,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            zone: this.data.zone,\n            position: this.data.position,\n            log: false\n        }));\n    }\n\n    override exec(): void {\n        const card = this.YGO.state.getCardById(this.data.id, this.data.originZone);\n\n        card.materials = this.data.materials.map(material => {\n            const materialCard = this.YGO.state.getCardById(material.id, material.zone);\n            return materialCard;\n        });\n\n        this.execMultipleChildCommand(this.commands);\n\n        this.YGO.duelLog.dispatch<YGODuelEvents.XYZSummon>({\n            player: this.data.player,\n            commandId: this.getCommandId(),\n            type: YGODuelEvents.LogType.XYZSummon,\n            id: this.data.id,\n            originZone: this.data.originZone,\n            zone: this.data.zone,\n            position: this.data.position!,\n            materials: this.data.materials\n        });\n    }\n\n    override undo(): void {\n        const card = this.YGO.state.getCardById(this.data.id, this.data.zone);\n        card.materials = [];\n        this.undoMultipleChildCommand(this.commands);\n    }\n}\n\ninterface XYZMaterialsMoveData {\n    player: number,\n    id: number\n    overlayZone: FieldZone\n    zone: FieldZone\n}\n\nclass XYZMaterialsMove extends BaseCommand {\n    private data: XYZMaterialsMoveData;\n    private card!: Card;\n\n    constructor(data: XYZMaterialsMoveData) {\n        super();\n        this.data = data;\n    }\n\n    exec(): void {\n        this.card = this.YGO.state.getCardById(this.data.id, this.data.zone);\n        this.YGO.state.setCard(null, this.data.zone);\n\n        this.YGO.duelLog.dispatch<YGODuelEvents.XYZOverlay>({\n            player: this.data.player,\n            commandId: this.getCommandId(),\n            type: YGODuelEvents.LogType.XYZOverlay,\n            id: this.data.id,\n            originZone: this.data.zone,\n            overlayZone: this.data.overlayZone\n        });\n    }\n\n    undo(): void {\n        this.YGO.state.setCard(this.card, this.data.zone);\n    }\n}\n","import { Command } from \"../types/commands\";\nimport { ActivateCardCommand } from \"./ActivateCardCommand\";\nimport { BanishCommand } from \"./BanishCommand\";\nimport { ChangeCardAtkDefCommand } from \"./ChangeCardAtkDefCommand\";\nimport { ChangeCardPositionCommand } from \"./ChangeCardPositionCommand\";\nimport { DestroyCardCommand } from \"./DestroyCard\";\nimport { DrawFromDeckCommand } from \"./DrawFromDeckCommand\";\nimport { FieldSpellCommand } from \"./FieldSpellCommand\";\nimport { FlipCommand } from \"./FlipCommand\";\nimport { FusionSummonCommand } from \"./FusionSummonCommand\";\nimport { LinkSummonCommand } from \"./LinkSummonCommand\";\nimport { MillFromDeckCommand } from \"./MillFromDeckCommand\";\nimport { MoveCardCommand } from \"./MoveCardCommand\";\nimport { NormalSummonCommand } from \"./NormalSummonCommand\";\nimport { RevealCommand } from \"./RevealCommand\";\nimport { SendCardToGYCommand } from \"./SendCardToGY\";\nimport { SetCardCommand } from \"./SetCardCommand\";\nimport { SetMonsterCommand } from \"./SetMonsterCommand\";\nimport { ShuffleDeckCommand } from \"./ShuffleDeck\";\nimport { SpecialSummonCommand } from \"./SpecialSummonCommand\";\nimport { StartHandCommand } from \"./StartHandCommand\";\nimport { SynchroSummonCommand } from \"./SynchroSummonCommand\";\nimport { TargetCommand } from \"./TargetCommand\";\nimport { ToDeckCommand } from \"./ToDeckCommand\";\nimport { ToExtraDeckCommand } from \"./ToExtraDeckCommand\";\nimport { ToHandCommand } from \"./ToHandCommand\";\nimport { ToSTCommand } from \"./ToSTCommand\";\nimport { TributeSummonCommand } from \"./TributeSummonCommand\";\nimport { XYZAttachMaterialCommand } from \"./XYZAttachMaterialCommand\";\nimport { XYZDetachMaterialCommand } from \"./XYZDetachMaterialCommand\";\nimport { XYZOverlaySummonCommand } from \"./XYZOverlaySummonCommand\";\nimport { XYZSummonCommand } from \"./XYZSummonCommand\";\n\nexport interface YGOCommandsList {\n    NormalSummonCommand: typeof NormalSummonCommand,\n    SetMonsterCommand: typeof SetMonsterCommand,\n    SetCardCommand: typeof SetCardCommand,\n    SendCardToGYCommand: typeof SendCardToGYCommand,\n    BanishCommand: typeof BanishCommand,\n    DrawFromDeckCommand: typeof DrawFromDeckCommand,\n    MillFromDeckCommand: typeof MillFromDeckCommand,\n    ActivateCardCommand: typeof ActivateCardCommand,\n    SpecialSummonCommand: typeof SpecialSummonCommand,\n    TributeSummonCommand: typeof TributeSummonCommand,\n    LinkSummonCommand: typeof LinkSummonCommand,\n    FusionSummonCommand: typeof FusionSummonCommand,\n    SynchroSummonCommand: typeof SynchroSummonCommand,\n    XYZSummonCommand: typeof XYZSummonCommand,\n    XYZOverlaySummonCommand: typeof XYZOverlaySummonCommand;\n    XYZAttachMaterialCommand: typeof XYZAttachMaterialCommand,\n    XYZDetachMaterialCommand: typeof XYZDetachMaterialCommand,\n    ToDeckCommand: typeof ToDeckCommand,\n    ShuffleDeckCommand: typeof ShuffleDeckCommand,\n    DestroyCardCommand: typeof DestroyCardCommand,\n    RevealCommand: typeof RevealCommand,\n    ToExtraDeckCommand: typeof ToExtraDeckCommand,\n    ToHandCommand: typeof ToHandCommand,\n    FieldSpellCommand: typeof FieldSpellCommand,\n    ChangeCardPositionCommand: typeof ChangeCardPositionCommand,\n    ChangeCardAtkDefCommand: typeof ChangeCardAtkDefCommand,\n    FlipCommand: typeof FlipCommand,\n    ToSTCommand: typeof ToSTCommand,\n    MoveCardCommand: typeof MoveCardCommand,\n    TargetCommand: typeof TargetCommand;\n}\n\nexport const Commands: YGOCommandsList = {\n    NormalSummonCommand,\n    SetMonsterCommand,\n    SetCardCommand,\n    SendCardToGYCommand,\n    BanishCommand,\n    DrawFromDeckCommand,\n    MillFromDeckCommand,\n    ActivateCardCommand,\n    SpecialSummonCommand,\n    TributeSummonCommand,\n    LinkSummonCommand,\n    FusionSummonCommand,\n    SynchroSummonCommand,\n    XYZSummonCommand,\n    XYZOverlaySummonCommand,\n    XYZAttachMaterialCommand,\n    XYZDetachMaterialCommand,\n    ToDeckCommand,\n    ShuffleDeckCommand,\n    DestroyCardCommand,\n    RevealCommand,\n    ToExtraDeckCommand,\n    ToHandCommand,\n    FieldSpellCommand,\n    ChangeCardPositionCommand,\n    ChangeCardAtkDefCommand,\n    FlipCommand,\n    ToSTCommand,\n    MoveCardCommand,\n    TargetCommand,\n}\n\nexport const COMMANDS_BY_NAME: any = {\n    \"NormalSummonCommand\": NormalSummonCommand,\n    \"SetMonsterCommand\": SetMonsterCommand,\n    \"SetCardCommand\": SetCardCommand,\n    \"SendCardToGYCommand\": SendCardToGYCommand,\n    \"BanishCommand\": BanishCommand,\n    \"DrawFromDeckCommand\": DrawFromDeckCommand,\n    \"MillFromDeckCommand\": MillFromDeckCommand,\n    \"ActivateCardCommand\": ActivateCardCommand,\n    \"SpecialSummonCommand\": SpecialSummonCommand,\n    \"TributeSummonCommand\": TributeSummonCommand,\n    \"LinkSummonCommand\": LinkSummonCommand,\n    \"FusionSummonCommand\": FusionSummonCommand,\n    \"SynchroSummonCommand\": SynchroSummonCommand,\n    \"XYZSummonCommand\": XYZSummonCommand,\n    \"XYZOverlaySummonCommand\": XYZOverlaySummonCommand,\n    \"XYZAttachMaterialCommand\": XYZAttachMaterialCommand,\n    \"XYZDetachMaterialCommand\": XYZDetachMaterialCommand,\n    \"ToDeckCommand\": ToDeckCommand,\n    \"ShuffleDeckCommand\": ShuffleDeckCommand,\n    \"DestroyCardCommand\": DestroyCardCommand,\n    \"RevealCommand\": RevealCommand,\n    \"ToExtraDeckCommand\": ToExtraDeckCommand,\n    \"ToHandCommand\": ToHandCommand,\n    \"FieldSpellCommand\": FieldSpellCommand,\n    \"ChangeCardPositionCommand\": ChangeCardPositionCommand,\n    \"ChangeCardAtkDefCommand\": ChangeCardAtkDefCommand,\n    \"FlipCommand\": FlipCommand,\n    \"ToSTCommand\": ToSTCommand,\n    \"MoveCardCommand\": MoveCardCommand,\n    \"StartHandCommand\": StartHandCommand,\n    \"TargetCardCommand\": TargetCommand,\n}\n\nexport function GetCommandByClassName<T = Command>(commandClassName: string): T | null {\n    return COMMANDS_BY_NAME[commandClassName];\n}","import { GetCommandByClassName } from \".\";\nimport { BaseCommand } from \"./BaseCommand\";\n\nexport class JSONCommand extends BaseCommand {\n    constructor(cmd: { type: string, data: any }) {\n        super();\n\n        const CommandClass = GetCommandByClassName(cmd.type);\n\n        if (!CommandClass) throw new Error(`Command \"${cmd.type}\" dont exists!`);\n\n        const command = new (CommandClass as any)(cmd.data)\n\n        return command;\n    }\n}","export class EventBus<T extends Record<keyof (T), (...args: any[]) => void>> {\n    private events: Map<keyof T, Function[]>;\n\n    constructor() {\n        this.events = new Map();\n    }\n\n    on<K extends keyof T>(event: K, listener: T[K]): void {\n        if (!this.events.has(event)) {\n            this.events.set(event, []);\n        }\n        this.events.get(event)!.push(listener);\n    }\n\n    dispatch<K extends keyof T>(event: K, ...args: Parameters<T[K]>): void {\n        const listeners = this.events.get(event);\n        if (listeners) {\n            listeners.forEach(listener => {\n                listener(...args)\n            });\n        }\n    }\n\n    off<K extends keyof T>(event: K, listener: T[K]): void {\n        const listeners = this.events.get(event);\n        if (listeners) {\n            this.events.set(\n                event,\n                listeners.filter(l => l !== listener)\n            );\n        }\n    }\n\n    clear<K extends keyof T>(event: K): void {\n        if (this.events.has(event)) {\n            this.events.delete(event);\n        }\n    }\n\n    clearAll(): void {\n        this.events.clear();\n    }\n}","import { Command } from \"../types/commands\";\nimport { EventBus } from \"../utils/event-bus\";\nimport { YGODuelEvents } from '../types/duel-events';\n\ntype YGODuelLogEventMap = {\n    'new-log': (log: YGODuelEvents.DuelLog) => void;\n    'update-logs': (logs: YGODuelEvents.DuelLog[]) => void;\n};\n\nexport class YGODuelLog {\n    public logs: YGODuelEvents.DuelLog[];\n    public events: EventBus<YGODuelLogEventMap>;\n    public enabled: boolean = true;\n\n    constructor() {\n        this.logs = [];\n        this.events = new EventBus();\n    }\n\n    dispatch<T extends YGODuelEvents.DuelLog>(log: T) {\n        this.logs.push(log);\n        \n        if(!this.enabled) return;\n        \n        this.events.dispatch(\"new-log\", log);\n        this.onLogsUpdated();\n    }\n\n    peek(): YGODuelEvents.DuelLog | null {\n        if (this.logs.length == 0) return null;\n        return this.logs[this.logs.length - 1];\n    }\n\n    peekCommand(): number {\n        if (this.logs.length == 0) return -1;\n        return this.logs[this.logs.length - 1].commandId;\n    }\n\n    pop(): YGODuelEvents.DuelLog | null {\n        if (this.logs.length === 0) return null;\n        return this.logs.pop() as YGODuelEvents.DuelLog;\n    }\n\n    removeCommand(command: Command, args?: { log: boolean }) {\n        const commandIndex = this.logs.findIndex(cmd => cmd.commandId === command.commandId);\n\n        if (commandIndex !== -1) {\n            this.logs.splice(commandIndex, this.logs.length - commandIndex);\n        }\n\n        if (args?.log !== false) {\n            this.events.dispatch(\"update-logs\", this.logs);\n        }\n    }\n\n    onLogsUpdated() {\n        this.events.dispatch(\"update-logs\", this.logs);\n    }\n}","import { Card, FieldZone, PlayerField, YGOProps } from \"../types/types\";\nimport { YGOGameUtils } from \"./YGOGameUtils\";\nimport { YGOUtils } from \"./YGOUtils\";\n\nexport class YGOGameState {\n    public fields: PlayerField[];\n    private cardsInGame: Map<number, Card>;\n\n    constructor(props: YGOProps) {\n        this.fields = YGOUtils.initializePlayersFields(props);\n        this.cardsInGame = YGOUtils.getCardsInGame(this.fields);\n    }\n\n    getCardById(id: number, zone: FieldZone): Card {\n        const playerIndex = zone.includes(\"2-\") ? 1 : 0;\n\n        if (zone === \"GY\" || zone === \"GY2\") {\n            const card = this.fields[playerIndex].graveyard.find(c => c.id === id);\n\n            if (!card) {\n                throw new Error(`card \"${id}\" not found in \"${zone}\"`);\n            }\n\n            return card;\n        }\n\n        const card = this.getCardFromZone(zone);\n\n        if (card && card.id === id) return card;\n\n        throw new Error(`card \"${id}\" not found in \"${zone}\"`);\n    }\n\n    getCardFromZone(zone: FieldZone): Card | null {\n        const zoneData = YGOGameUtils.getZoneData(zone);\n        const playerIndex = zoneData.player;\n\n        if (zone.startsWith(\"H-\") || zone.startsWith(\"H2-\")) {\n            const zoneIndex = Number(zone.split(\"-\").pop()) - 1;\n            const card = this.fields[playerIndex].hand[zoneIndex];\n            return card;\n        } else if (zone.startsWith(\"M-\") || zone.startsWith(\"M2-\")) {\n            const zoneIndex = Number(zone.split(\"-\").pop()) - 1;\n            const card = this.fields[playerIndex].monsterZone[zoneIndex];\n            return card;\n        } else if (zone.startsWith(\"S-\") || zone.startsWith(\"S2-\")) {\n            const zoneIndex = Number(zone.split(\"-\").pop()) - 1;\n            const card = this.fields[playerIndex].spellTrapZone[zoneIndex];\n            return card;\n        } else if (zone.startsWith(\"GY-\") || zone.startsWith(\"GY2-\")) {\n            const zoneIndex = Number(zone.split(\"-\").pop()) - 1;\n            const card = this.fields[playerIndex].graveyard[zoneIndex];\n            return card;\n        } else if (zone.startsWith(\"B-\") || zone.startsWith(\"B2-\")) {\n            const zoneIndex = Number(zone.split(\"-\").pop()) - 1;\n            const card = this.fields[playerIndex].banishedZone[zoneIndex];\n            return card;\n        } else if (zone.startsWith(\"D-\") || zone.startsWith(\"D2-\")) {\n            const zoneIndex = Number(zone.split(\"-\").pop()) - 1;\n            const card = this.fields[playerIndex].mainDeck[zoneIndex];\n            return card;\n        } else if (zone.startsWith(\"ED-\") || zone.startsWith(\"ED2-\")) {\n            const zoneIndex = Number(zone.split(\"-\").pop()) - 1;\n            const card = this.fields[playerIndex].extraDeck[zoneIndex];\n            return card;\n        } else if (zone.startsWith(\"EMZ-\") || zone.startsWith(\"EMZ2-\")) {\n            const zoneIndex = Number(zone.split(\"-\").pop()) - 1;\n            const card = this.fields[playerIndex].extraMonsterZone[zoneIndex];\n            return card;\n        } else if (zone.startsWith(\"F\") || zone.startsWith(\"F2\")) {\n            const card = this.fields[playerIndex].fieldZone;\n            return card;\n        }\n\n        return null;\n    }\n\n    moveCardById(cardId: number, originZone: FieldZone, zone: FieldZone) {\n        const card = this.getCardById(cardId, originZone);\n        this.moveCard(card, originZone, zone);\n    }\n\n    moveCard(card: Card, originZone: FieldZone, zone: FieldZone) {\n        this.removeCard(originZone);\n        this.setCard(card, zone);\n    }\n\n    setCard(card: Card | null, zone: FieldZone): void {\n        const zoneData = YGOGameUtils.getZoneData(zone);\n        const playerIndex = zoneData.player;\n\n        if (zone.startsWith(\"H-\") || zone.startsWith(\"H2-\") || zone === \"H\" || zone === \"H2\") {\n            const handIndex = zone.includes(\"-\") ? Number(zone.split(\"-\").pop()) - 1 : -1;\n            const hand = this.fields[playerIndex].hand;\n\n            if (handIndex == -1 && card) {\n                hand.push(card);\n            } else if (card) {\n                if (handIndex >= hand.length) {\n                    hand.push(card);\n                } else {\n                    hand.splice(handIndex, 0, card);\n                }\n            } else {\n                hand.splice(handIndex, 1);\n            }\n        } else if (zone.startsWith(\"M-\") || zone.startsWith(\"M2-\")) {\n            const zoneIndex = Number(zone.split(\"-\").pop()) - 1;\n            this.fields[playerIndex].monsterZone[zoneIndex] = card;\n            // todo check if monster etc \n        } else if (zone.startsWith(\"S-\") || zone.startsWith(\"S2-\")) {\n            const zoneIndex = Number(zone.split(\"-\").pop()) - 1;\n            this.fields[playerIndex].spellTrapZone[zoneIndex] = card;\n        } else if (zone.startsWith(\"EMZ-\") || zone.startsWith(\"EMZ2-\")) {\n            const zoneIndex = Number(zone.split(\"-\").pop()) - 1;\n            this.fields[playerIndex].extraMonsterZone[zoneIndex] = card;\n        }\n        else if (zone.startsWith(\"ED\") || zone.startsWith(\"ED2\")) { // append to extra\n            if (zone.indexOf(\"-\") !== -1) {\n                const zoneIndex = Number(zone.split(\"-\").pop()) - 1;\n                if (!card) {\n                    this.fields[playerIndex].extraDeck.splice(zoneIndex, 1);\n                } else {\n                    this.fields[playerIndex].extraDeck.splice(zoneIndex, 0, card);\n                }\n            } else if (card) {\n                const isPendulum = card.isMainDeckCard && YGOGameUtils.isPendulumCard(card);\n                const extraDeck = this.fields[playerIndex].extraDeck;\n\n                if (isPendulum) {\n                    extraDeck.unshift(card); // add card to top of extraDeck\n                } else {\n                    extraDeck.push(card);\n                    YGOGameUtils.sortCards(extraDeck);\n                }\n            } else {\n                throw new Error(\"No card to add to Extra Deck\");\n            }\n        } else if (zone.startsWith(\"D-\") || zone.startsWith(\"D2-\")) {\n            const zoneIndex = Number(zone.split(\"-\").pop()) - 1;\n\n            console.log(\"MOVE CARD TO DECK \", zone);\n\n            if (!card) {\n                this.fields[playerIndex].mainDeck.splice(zoneIndex, 1);\n            } else {\n                this.fields[playerIndex].mainDeck.splice(zoneIndex, 0, card);\n            }\n        } else if (zone === \"GY\" || zone === \"GY2\" || zone.startsWith(\"GY-\") || zone.startsWith(\"GY2-\")) {\n            const gyIndex = zone.includes(\"-\") ? Number(zone.split(\"-\").pop()) - 1 : -1;\n            const gy = this.fields[playerIndex].graveyard;\n            if (card) {\n                if (gyIndex === -1) {\n                    gy.unshift(card);\n                } else {\n                    gy.splice(gyIndex, 0, card);\n                }\n            } else {\n                if (gyIndex == -1) {\n                    if (gy.length > 0) {\n                        gy.splice(0, 1);\n                    }\n                } else {\n                    gy.splice(gyIndex, 1);\n                }\n            }\n        } else if (zone === \"B\" || zone === \"B2\" || zone.startsWith(\"B-\") || zone.startsWith(\"B2-\")) {\n            const gyIndex = zone.includes(\"-\") ? Number(zone.split(\"-\").pop()) - 1 : -1;\n            const banishZone = this.fields[playerIndex].banishedZone;\n\n            if (card) {\n                if (gyIndex === -1) {\n                    banishZone.unshift(card);\n                } else {\n                    banishZone.splice(gyIndex, 0, card);\n                }\n            } else {\n                if (gyIndex == -1) {\n                    banishZone.pop();\n                } else {\n                    banishZone.splice(gyIndex, 1);\n                }\n            }\n        } else if (zone.startsWith(\"F\") || zone.startsWith(\"F2\")) {\n            this.fields[playerIndex].fieldZone = card;\n        }\n    }\n\n    removeCard(zone: FieldZone): Card | null {\n        const card = this.getCardFromZone(zone);\n        this.setCard(null, zone);\n        // TODO Reset card\n        return card;\n    }\n\n    getCardData(cardId: number): Card | null {\n        return this.cardsInGame.get(cardId) || null;\n    }\n\n    shuffleDeck(player: number) {\n        const deck = this.fields[player].mainDeck;\n        if (deck.length === 0) return; // If the deck is empty, do nothing\n\n        for (let i = deck.length - 1; i > 0; i--) {\n            const cardIndex = Math.floor(Math.random() * (i + 1));\n            [deck[i], deck[cardIndex]] = [deck[cardIndex], deck[i]];\n        }\n    }\n\n    getPlayerIndexFromZone(zone: string): number {\n        return YGOUtils.getPlayerIndexFromZone(zone);\n    }\n\n    getAvailableZones(fieldZones: (\"M\" | \"M2\" | \"S\" | \"S2\" | \"F\" | \"F2\" | \"EMZ\")[]): FieldZone[] {\n        const result: FieldZone[] = [];\n\n        // TODO @RMS  make this player aware\n\n        for (const fieldZone of fieldZones) {\n            const player = this.getPlayerIndexFromZone(fieldZone);\n            const field = this.fields[player];\n            if (fieldZone === \"M\") {\n                field.monsterZone.forEach((data, index) => {\n                    const zone = `M${player === 0 ? \"\" : \"2\"}-${index + 1}`;\n                    if (!data) result.push(zone as FieldZone);\n                });\n            } else if (fieldZone === \"S\") {\n                field.spellTrapZone.forEach((data, index) => {\n                    const zone = `S${player === 0 ? \"\" : \"2\"}-${index + 1}`;\n                    if (!data) result.push(zone as FieldZone);\n                });\n            } else if (fieldZone === \"EMZ\") {\n                for (let i = 0; i < 2; ++i) {\n                    const data = field.extraDeck[i] || field.extraDeck[i];\n                    const zone = `EMZ-${i + 1}`;\n                    if (!data) result.push(zone as FieldZone);\n                }\n            } else if (fieldZone === \"F\") {\n                if (field.fieldZone) result.push(\"F\");\n            }\n        }\n\n        return result;\n    }\n}","import { Card, FieldZone, FieldStateEntry as YGOCardFieldState, YGOReplayData } from \"../types/types\";\nimport { YGOCore } from \"./YGOCore\";\nimport { YGOGameUtils } from \"./YGOGameUtils\";\n\nexport class YGOReplayUtils {\n    static createReplayData(ygo: YGOCore): YGOReplayData {\n        const players = ygo.props.players.map((playerData, playerIndex) => {\n            const field = ygo.getField(playerIndex);\n            return {\n                name: playerData.name,\n                mainDeck: field.data.mainDeckOrdered,\n                extraDeck: field.data.extraDeckOrdered,\n            }\n        });\n\n        const commands = ygo.commands.map(cmd => cmd.toJSON());\n        const endField: YGOCardFieldState[] = [];\n        const initialField: YGOCardFieldState[] = [];\n\n        if (ygo.props.options?.fieldState) {\n            ygo.props.options.fieldState.forEach(s => initialField.push(s));\n        }\n\n        for (let playerIndex = 0; playerIndex < ygo.state.fields.length; ++playerIndex) {\n            const field = ygo.getField(playerIndex);\n\n            console.log(\"FIELD:: \", field);\n\n            for (let i = 0; i < field.hand.length; ++i) {\n                const card = field.hand[i]!;\n                const zone = YGOGameUtils.createZone(\"H\", playerIndex, i + 1);\n                endField.push(this.getMonsterCardInfo(card, zone));\n            }\n\n            for (let i = 0; i < field.monsterZone.length; ++i) {\n                if (field.monsterZone[i]) {\n                    const card = field.monsterZone[i]!;\n                    const zone = YGOGameUtils.createZone(\"M\", playerIndex, i + 1);\n                    endField.push(this.getMonsterCardInfo(card, zone));\n                }\n            }\n\n            for (let i = 0; i < field.spellTrapZone.length; ++i) {\n                if (field.spellTrapZone[i]) {\n                    const card = field.spellTrapZone[i]!;\n                    const zone = YGOGameUtils.createZone(\"S\", playerIndex, i + 1);\n                    endField.push({ id: card.id, zone });\n                }\n            }\n\n            for (let i = 0; i < field.extraMonsterZone.length; ++i) {\n                if (field.extraMonsterZone[i] && field.extraMonsterZone[i]?.owner === playerIndex) {\n                    const card = field.extraMonsterZone[i]!;\n                    const zone = YGOGameUtils.createZone(\"EMZ\", playerIndex, i + 1);\n                    endField.push(this.getMonsterCardInfo(card, zone));\n                }\n            }\n\n            for (let i = 0; i < field.graveyard.length; ++i) {\n                const card = field.graveyard[i];\n                const zone = YGOGameUtils.createZone(\"GY\", playerIndex);\n                endField.push({ id: card.id, zone });\n            }\n\n            for (let i = 0; i < field.banishedZone.length; ++i) {\n                const card = field.banishedZone[i];\n                const zone = YGOGameUtils.createZone(\"B\", playerIndex);\n                const result: any = { id: card.id, zone };\n\n                if (YGOGameUtils.isFaceDown(card)) {\n                    result.position = \"facedown\"\n                }\n\n                endField.push(result);\n            }\n        }\n\n        // todo get end field etc..\n        return {\n            players,\n            commands,\n            initialField,\n            endField\n        }\n    }\n\n    private static getMonsterCardInfo(card: Card, zone: FieldZone): any {\n        const result: any = {\n            id: card.id,\n            zone\n        }\n\n        if (card.atk !== card.currentAtk) {\n            result.atk = card.currentAtk;\n        }\n\n        if (card.def !== card.currentDef) {\n            result.def = card.currentDef;\n        }\n\n        if (card.position !== \"faceup-attack\") {\n            result.position = card.position;\n        }\n\n        if (card.materials.length > 0) {\n            result.materials = card.materials.map(materialCard => ({ id: materialCard.id })); // TODO OWner of the card\n        }\n\n        return result;\n    }\n}","import { JSONCommand } from \"../commands/JSONCommand\";\nimport { StartHandCommand } from \"../commands/StartHandCommand\";\nimport { Command } from \"../types/commands\";\nimport { PlayerField, YGOCoreEvents, YGOPhase, YGOProps } from \"../types/types\";\nimport { EventBus } from \"../utils/event-bus\";\nimport { YGODuelLog } from \"./YGODuelLog\";\nimport { YGOGameState } from \"./YGOGameState\";\nimport { YGOReplayUtils } from \"./YGOReplayUtils\";\nimport { YGOUtils } from \"./YGOUtils\";\n\nexport class YGOCore {\n    // public\n    public currentPlayer: number;\n    public phase: YGOPhase;\n    public props: YGOProps;\n    public state: YGOGameState;\n    public commands: Command[];\n    public commandIndex: number;\n    public duelLog: YGODuelLog;\n    public events: EventBus<YGOCoreEvents>;\n    //private\n    private startDuelTime: number; // start game time\n    private duelTimeOffset: number; // host game time ex: join room at time 100 my time is 0 + 100\n\n    constructor(props: YGOProps) {\n        this.props = props;\n        this.state = new YGOGameState(props);\n        this.duelLog = new YGODuelLog();\n        this.events = new EventBus<YGOCoreEvents>();\n        this.commandIndex = -1;\n        this.commands = this.createYGOCommands(props.commands);\n        this.startDuelTime = Date.now();\n        this.duelTimeOffset = props.options?.currentGameTime || 0;\n        /// game\n        this.currentPlayer = 0;\n        this.phase = YGOPhase.DrawPhase;\n        // events\n        this.duelLog.events.on(\"new-log\", data => this.events.dispatch(\"new-log\", data));\n        this.duelLog.events.on(\"update-logs\", data => this.events.dispatch(\"update-logs\", data));\n    }\n\n    start() {\n        const { draw: cardsToDrawInStart = 5 } = this.props.options || {};\n\n        if (this.commands.length === 0) {\n            this.props.players.forEach((_, player) => {\n                this.exec(new StartHandCommand({\n                    player,\n                    numberOfCards: cardsToDrawInStart\n                }));\n            });\n        }\n    }\n\n    setCurrentPlayer(player: number) {\n        if (player < 0 || player > 1) throw new Error(`invalid player ${player}`);\n\n        this.currentPlayer = player;\n        this.events.dispatch(\"set-player\", { player });\n    }\n\n    exec(command: Command): Command {\n        if (this.hasNextCommand()) {\n            this.commands.splice(this.commandIndex + 1, this.commands.length - this.commandIndex);\n        }\n        this.commandIndex = this.commands.length;\n        this.commands.push(command);\n        command.init(this);\n        this.events.dispatch(\"command-created\", { command });\n        command.exec();\n        this.events.dispatch(\"command-executed\", { command });\n        return command;\n    }\n\n    peek(): Command | null {\n        return this.commands.length > 0 ? this.commands[this.commands.length - 1] : null;\n    }\n\n    redo(): Command | null {\n        if (!this.hasNextCommand()) return null;\n        this.commandIndex++;\n        const cmdToRedo = this.commands[this.commandIndex];\n        cmdToRedo.exec();\n        this.duelLog.onLogsUpdated();\n        this.events.dispatch(\"command-redo\", { command: cmdToRedo });\n\n        return cmdToRedo;\n    }\n\n    undo(): Command | null {\n        if (!this.hasPrevCommand()) return null;\n\n        const cmdToUndo = this.commands[this.commandIndex];\n        this.duelLog.removeCommand(cmdToUndo);\n        cmdToUndo.undo();\n        this.commandIndex--;\n        this.duelLog.onLogsUpdated();\n        this.events.dispatch(\"command-undo\", { command: cmdToUndo });\n\n        return cmdToUndo;\n    }\n\n    goToCommand(command: Command): boolean {\n\n        const commandIndex = this.commands.findIndex(c => c === command);\n\n        if (commandIndex === -1) return false;\n\n        if (commandIndex === this.commandIndex) return true;\n\n        if (commandIndex > this.commandIndex) {\n            while (this.commandIndex !== commandIndex && this.hasNextCommand()) {\n                this.redo();\n            }\n            return true;\n        } else {\n            while (this.commandIndex !== commandIndex && this.hasPrevCommand()) {\n                this.undo();\n            }\n            return true;\n        }\n    }\n\n    hasNextCommand() {\n        return this.commands.length - 1 > this.commandIndex;\n    }\n\n    hasPrevCommand() {\n        return this.commandIndex >= 0;\n    }\n\n    getNextCommandId() {\n        return this.commandIndex >= 0 ? this.commandIndex : 0;\n    }\n\n    getCurrentTime() {\n        return Date.now() - this.startDuelTime + this.duelTimeOffset;\n    }\n\n    getReplayData() {\n\n        while (this.hasNextCommand()) {\n            this.redo();\n        }\n\n        return YGOReplayUtils.createReplayData(this);\n    }\n\n    getField(player: number): PlayerField {\n        return this.state.fields[player];\n    }\n\n    private createYGOCommands(commands?: any[]) {\n        this.duelLog.enabled = false;\n\n        if (Array.isArray(commands)) {\n            const loadedCommands = commands.map(cmd => {\n                const command = new JSONCommand(cmd);\n                command.init(this);\n                command.commandId = ++this.commandIndex;\n                command.exec();\n                return command;\n            });\n\n            // if true will not undo all the commands passed on constructor\n            // Can be undefined so validate if !== true\n            if (this.props.options?.execCommands !== true) {\n                for (let i = loadedCommands.length - 1; i >= 0; --i) {\n                    loadedCommands[i].undo();\n                }\n            }\n            this.commandIndex = loadedCommands.length;\n            this.commands = loadedCommands;\n            this.duelLog.enabled = true;\n            return loadedCommands;\n        }\n\n        this.duelLog.enabled = true;\n\n        return [];\n    }\n\n    getCurrentStateProps() {\n        return YGOUtils.getYGOCoreStateProps(this);\n    }\n}","import { Commands } from './commands';\n\nexport * from './game/YGOCore';\nexport * from './game/YGODuelLog';\nexport * from './game/YGOGameUtils';\nexport * from './types/duel-events';\nexport * from './commands/JSONCommand';\n\nexport const YGOCommands = Commands;\n\nexport const debug_version = \"1.0.3\";"],"names":["BaseCommand","constructor","this","commandId","parent","init","ygo","YGO","getNextCommandId","timestamp","getCurrentTime","getCommandId","_a","undefined","execChildCommand","command","exec","undoChildCommand","undo","undoMultipleChildCommand","commands","i","length","execMultipleChildCommand","isValid","toJSON","data","type","baseType","toCommandData","YGODuelEvents","CardBaseType","YGOPhase","LogType","YGOGameUtils","isLinkMonster","card","typeline","includes","isMonster","isXYZMonster","isSynchroMonster","isFusionMonster","isPendulumCard","frameType","isFaceUp","position","isFaceDown","isSpellTrap","isSpell","isTrap","startsWith","isFieldSpell","race","isDefense","isAttack","hasLinkMonstersInField","field","monsterZone","some","extraMonsterZone","hasXyzMonstersInField","XyzMonstersInFieldCounter","counter","forEach","XyzMonstersInFieldsCounter","duel","state","fields","getPlayerIndexFromZone","zone","createZone","player","createOverlayZone","zoneIndex","getZoneData","args","split","playerIndex","zoneId","Number","endsWith","substring","getCardBaseType","EffectMonster","Spell","RitualMonster","Trap","FusionMonster","SynchroMonster","XYZMonster","LinkMonster","NormalMonster","getCardsBaseType","cards","map","c","toSortedCards","sortCards","cardsToSort","cardsWeights","j","name","shuffleCards","positions","Array","index","Math","floor","random","temp","invertPlayerInZone","zoneData","transformZoneToPlayerZone","ActivateCardCommand","super","getCardById","id","originZone","removeCard","setCard","console","log","prevPosition","duelLog","dispatch","Activate","previousPosition","YGOUtils","parseMainDeck","mainDeck","parseCard","isMainDeckCard","parseExtraDeck","extraDeck","extra","Error","owner","originalOwner","currentAtk","atk","currentDef","def","materials","getCardsInGame","Map","has","set","spellTrapZone","graveyard","banishedZone","getOverlayZone","initializePlayersFields","props","shuffleDecks","options","cardIndex","lp","hand","mainDeckOrdered","extraDeckOrdered","fieldZone","players","recoverFields","fieldState","isArray","cardsToRemoveFromDeck","Set","cardsToRemoveFromExtraDeck","getCard","find","add","edCard","banished","cardInitialState","push","isNumeric","sort","card1","card2","cardInHand","filter","val","isNaN","getFieldsAsString","field1","getField","field2","join","_b","getYGOCoreStateProps","getCardData","cmd","Object","assign","startCommand","commandIndex","execCommands","XYZMoveMaterialsCommand","materialsToMove","shouldMoveMaterials","overlayZone","material","SendToGY","reason","MoveCardCommand","prevAtk","prevDef","originZoneData","prevOwner","moveCard","extraDeckIndex","findIndex","BanishCommand","banishCommand","ChangeCardAtkDefCommand","oldAtk","oldDef","ChangeCardAtkDef","ChangeCardPositionCommand","ChangeCardPosition","DestroyCardCommand","moveCardCommand","DrawFromDeckCommand","numberOfCards","pop","DrawCardFromDeck","newCards","reverse","cardInHandIndex","splice","RevealCommand","Reveal","SendCardToGYCommand","FieldSpellCommand","fieldCard","reveal","FlipCommand","Flip","FusionSummonCommand","materialsCommands","materialsWithZoneData","m1","m2","materialCard","FusionSummon","LinkSummonCommand","LinkSummon","MillFromDeckCommand","max","min","NormalSummonCommand","SetCardCommand","SetMonster","SetST","SetMonsterCommand","ShuffleDeckCommand","cardPositions","Shuffle","SpecialSummonCommand","StartHandCommand","core","shift","numCardsToDraw","handIndex","StartHand","unshift","SynchroSummonCommand","SynchroSummon","TargetCommand","Target","ToDeckCommand","getCommandType","isTopCard","getDeckIndex","shuffle","deckIndex","ToExtraDeckCommand","ToHandCommand","ToSTCommand","TributeSummonCommand","tributes","tribute","TributeSummon","TributeSet","XYZAttachMaterialCommand","getCardFromZone","materialCardReference","moveXYZMaterialsCommand","XYZAttachMaterial","materialId","materialIndex","indexOf","XYZDetachMaterialCommand","XYZDetachMaterial","XYZOverlaySummonCommand","previousMaterialsData","cardMaterials","material2","XYZMaterialsMove","XYZOverlaySummon","XYZOverlay","XYZSummonCommand","XYZSummon","Commands","COMMANDS_BY_NAME","TargetCardCommand","JSONCommand","CommandClass","commandClassName","EventBus","events","on","event","listener","get","listeners","off","l","clear","delete","clearAll","YGODuelLog","enabled","logs","onLogsUpdated","peek","peekCommand","removeCommand","YGOGameState","cardsInGame","moveCardById","cardId","isPendulum","gyIndex","gy","banishZone","shuffleDeck","deck","getAvailableZones","fieldZones","result","YGOReplayUtils","createReplayData","playerData","endField","initialField","s","getMonsterCardInfo","YGOCore","createYGOCommands","startDuelTime","Date","now","duelTimeOffset","currentGameTime","currentPlayer","phase","DrawPhase","start","draw","cardsToDrawInStart","_","setCurrentPlayer","hasNextCommand","redo","cmdToRedo","hasPrevCommand","cmdToUndo","goToCommand","getReplayData","loadedCommands","getCurrentStateProps","YGOCommands","debug_version"],"mappings":"MAGsBA,EASlB,WAAAC,GANOC,KAASC,WAAa,EAItBD,KAAME,OAAmB,KAIhC,IAAAC,CAAKC,GACDJ,KAAKK,IAAMD,EACXJ,KAAKC,UAAYD,KAAKK,IAAIC,mBAC1BN,KAAKO,UAAYP,KAAKK,IAAIG,iBAG9B,YAAAC,SACI,OAAoB,QAAbC,EAAAV,KAAKE,cAAQS,IAAAD,OAAAC,EAAAD,EAAAT,YAAaD,KAAKC,UAG1C,gBAAAW,CAAiBC,GAIb,OAHAA,EAAQX,OAASF,KAAKE,OAASF,KAAKE,OAASF,KAC7Ca,EAAQV,KAAKH,KAAKK,KAClBQ,EAAQC,OACDD,EAGX,gBAAAE,CAAiBF,GAEb,OADAA,SAAAA,EAASG,OACFH,EAGX,wBAAAI,CAAyBC,SACrB,IAAK,IAAIC,EAAID,EAASE,OAAS,EAAGD,GAAK,IAAKA,EAC3B,QAAbT,EAAAQ,EAASC,UAAIR,IAAAD,GAAAA,EAAAM,OAIrB,wBAAAK,CAAyBH,GACrB,IAAK,MAAML,KAAWK,EAClBlB,KAAKY,iBAAiBC,GAI9B,OAAAS,GACI,OAAO,EAGX,IAAAR,IAIA,IAAAE,IAIA,MAAAO,GACI,MACMC,EADOxB,KACKwB,MAAQ,CAAE,EAE5B,MAAO,CACHC,KAAMzB,KAAK0B,SACXF,QAIR,aAAAG,GACI,MACMH,EADOxB,KACKwB,MAAQ,CAAE,EAE5B,MAAO,CACHvB,UAAWD,KAAKC,UAChBM,UAAWP,KAAKO,UAChBkB,KAAMzB,KAAK0B,SACXF,SC5EN,IAAWI,EC8CLC,EAsIAC,GDpLZ,SAAiBF,GACb,IAAYG,KAAAH,EAAOG,UAAPH,UAoCX,CAAA,IAnCG,aAAA,gBACAG,EAAA,WAAA,cACAA,EAAA,SAAA,aACAA,EAAA,OAAA,SACAA,EAAA,SAAA,YACAA,EAAA,UAAA,aACAA,EAAA,iBAAA,iBACAA,EAAA,iBAAA,iBACAA,EAAA,cAAA,iBACAA,EAAA,WAAA,cACAA,EAAA,OAAA,UACAA,EAAA,YAAA,gBACAA,EAAA,UAAA,cACAA,EAAA,aAAA,iBACAA,EAAA,QAAA,UACAA,EAAA,cAAA,iBACAA,EAAA,cAAA,iBACAA,EAAA,WAAA,cACAA,EAAA,aAAA,gBACAA,EAAA,UAAA,aACAA,EAAA,iBAAA,qBACAA,EAAA,kBAAA,sBACAA,EAAA,kBAAA,sBACAA,EAAA,WAAA,aACAA,EAAA,MAAA,SACAA,EAAA,SAAA,WACAA,EAAA,SAAA,YACAA,EAAA,QAAA,UACAA,EAAA,KAAA,QACAA,EAAA,OAAA,SACAA,EAAA,OAAA,SACAA,EAAA,WAAA,cACAA,EAAA,mBAAA,uBACAA,EAAA,iBAAA,sBACAA,EAAA,KAAA,MAkNP,CAtPD,CAAiBH,IAAAA,EAsPhB,CAAA,ICxMD,SAAYC,GACRA,EAAAA,EAAA,cAAA,GAAA,gBACAA,EAAAA,EAAA,cAAA,GAAA,gBACAA,EAAAA,EAAA,cAAA,GAAA,gBACAA,EAAAA,EAAA,MAAA,GAAA,QACAA,EAAAA,EAAA,KAAA,GAAA,OACAA,EAAAA,EAAA,cAAA,GAAA,gBACAA,EAAAA,EAAA,eAAA,GAAA,iBACAA,EAAAA,EAAA,WAAA,GAAA,aACAA,EAAAA,EAAA,YAAA,GAAA,aACH,CAVD,CAAYA,IAAAA,EAUX,CAAA,IA4HD,SAAYC,GACRA,EAAA,UAAA,aACAA,EAAA,aAAA,gBACAA,EAAA,WAAA,eACAA,EAAA,YAAA,eACAA,EAAA,WAAA,eACAA,EAAA,SAAA,WACH,CAPD,CAAYA,IAAAA,EAOX,CAAA,UCzLYE,EAET,oBAAOC,CAAcC,SACjB,eAAOxB,EAAAwB,EAAKC,+BAAUC,SAAS,QAGnC,gBAAOC,CAAUH,SACb,eAAOxB,EAAAwB,EAAKT,2BAAMW,SAAS,WAG/B,mBAAOE,CAAaJ,SAChB,eAAOxB,EAAAwB,EAAKC,+BAAUC,SAAS,OAGnC,uBAAOG,CAAiBL,SACpB,eAAOxB,EAAAwB,EAAKC,+BAAUC,SAAS,WAGnC,sBAAOI,CAAgBN,SACnB,eAAOxB,EAAAwB,EAAKC,+BAAUC,SAAS,UAGnC,qBAAOK,CAAeP,SAClB,eAAOxB,EAAAwB,EAAKQ,gCAAWN,SAAS,YAGpC,eAAOO,CAAST,GACZ,OAAOA,EAAKU,SAASR,SAAS,UAGlC,iBAAOS,CAAWX,GACd,OAAQlC,KAAK2C,SAAST,GAG1B,kBAAOY,CAAYZ,GACf,OAAOlC,KAAK+C,QAAQb,IAASlC,KAAKgD,OAAOd,GAG7C,cAAOa,CAAQb,GACX,OAAOA,EAAKQ,UAAUO,WAAW,SAGrC,aAAOD,CAAOd,GACV,OAAOA,EAAKQ,UAAUO,WAAW,QAGrC,mBAAOC,CAAahB,GAChB,MAAqB,UAAdA,EAAKiB,KAGhB,gBAAOC,CAAUlB,GACb,MAAyB,aAAlBA,EAAKU,UAA6C,mBAAlBV,EAAKU,SAGhD,eAAOS,CAASnB,GACZ,MAAyB,kBAAlBA,EAAKU,UAAkD,WAAlBV,EAAKU,SAGrD,6BAAOU,CAAuBC,GAE1B,QAAIA,EAAMC,YAAYC,MAAKvB,KAAQA,GAAOF,EAAaC,cAAcC,MAI9DqB,EAAMG,iBAAiBD,MAAKvB,KAAQA,GAAOF,EAAaC,cAAcC,KAGjF,4BAAOyB,CAAsBJ,GAEzB,QAAIA,EAAMC,YAAYC,MAAKvB,KAAQA,GAAOF,EAAaM,aAAaJ,MAI7DqB,EAAMG,iBAAiBD,MAAKvB,KAAQA,GAAOF,EAAaM,aAAaJ,KAGhF,gCAAO0B,CAA0BL,GAC7B,IAAIM,EAAU,EAcd,OAZAN,EAAMC,YAAYM,SAAQ5B,IAClBA,GAAQF,EAAaM,aAAaJ,IAClC2B,OAIRN,EAAMG,iBAAiBI,SAAQ5B,IACvBA,GAAQF,EAAaM,aAAaJ,IAClC2B,OAIDA,EAGX,iCAAOE,CAA2BC,GAC9B,IAAIH,EAAU,EAgBd,OAdAG,EAAKC,MAAMC,OAAOJ,SAAQP,IACtBA,EAAMC,YAAYM,SAAQ5B,IAClBA,GAAQF,EAAaM,aAAaJ,IAClC2B,OAIRN,EAAMG,iBAAiBI,SAAQ5B,IACvBA,GAAQF,EAAaM,aAAaJ,IAClC2B,MAEN,IAGCA,EAGX,6BAAOM,CAAuBC,GAG1B,GAFkBA,EAAKhC,SAAS,MAEjB,OAAO,EAEtB,OAAQgC,GACJ,IAAK,KACL,IAAK,KACL,IAAK,KACL,IAAK,MACL,IAAK,SACL,IAAK,SACD,OAAO,EACX,QACI,OAAO,GAInB,iBAAOC,CAAWD,EAAmBE,EAAgB1B,GAEjD,YAAiBjC,IAAbiC,QAA0BA,EACnB,GAAGwB,IAAkB,IAAXE,EAAe,GAAK,MAGlC,GAAGF,IAAkB,IAAXE,EAAe,GAAK,OAAO1B,IAGhD,wBAAO2B,CAAkBH,EAAcE,EAAgBE,GAEnD,MAAa,QAATJ,EACO,MAAiB,IAAXE,EAAe,GAAK,OAAOE,IAGrC,SAAoB,IAAXF,EAAe,GAAK,OAAOE,IAG/C,kBAAOC,CAAYL,GACf,MAAMM,EAAON,EAAKO,MAAM,KACxB,IAAIC,EAAc,EACdC,EAASH,EAAK,GAClB,MAAMF,EAAYE,EAAKtD,OAAS,EAAI0D,OAAOJ,EAAK,KAAQ,EAOxD,OALIA,EAAK,GAAGK,SAAS,OACjBH,EAAc,EACdC,EAASA,EAAOG,UAAU,EAAGH,EAAOzD,OAAS,IAG1C,CACHgD,KAAMS,EACNP,OAAQM,EACRJ,UAAWA,GAInB,sBAAOS,CAAgB/C,GACnB,OAAIA,EAAKQ,UAAUO,WAAW,UAAkBpB,EAAaqD,cACzDhD,EAAKQ,UAAUO,WAAW,SAAiBpB,EAAasD,MACxDjD,EAAKQ,UAAUO,WAAW,UAAkBpB,EAAauD,cACzDlD,EAAKQ,UAAUO,WAAW,QAAgBpB,EAAawD,KACvDnD,EAAKQ,UAAUN,SAAS,UAAkBP,EAAayD,cACvDpD,EAAKQ,UAAUN,SAAS,WAAmBP,EAAa0D,eACxDrD,EAAKQ,UAAUN,SAAS,OAAeP,EAAa2D,WACpDtD,EAAKQ,UAAUN,SAAS,QAAgBP,EAAa4D,YAClD5D,EAAa6D,cAGxB,uBAAOC,CAAiBC,GAEpB,OADeA,EAAMC,KAAIC,GAAK9D,EAAaiD,gBAAgBa,KAI/D,oBAAOC,CAAcH,GACjB,OAAO5F,KAAKgG,UAAU,IAAIJ,IAG9B,gBAAOI,CAAUC,GACb,MAAML,EAAQK,EACRC,EAAelE,EAAa2D,iBAAiBC,GAEnD,IAAK,IAAIzE,EAAI,EAAGA,EAAIyE,EAAMxE,OAAS,IAAKD,EACpC,IAAK,IAAIgF,EAAI,EAAGA,EAAIP,EAAMxE,OAASD,EAAI,IAAKgF,GACpCD,EAAaC,GAAKD,EAAaC,EAAI,IAAOD,EAAaC,KAAOD,EAAaC,EAAI,IAAMP,EAAMO,GAAGC,KAAOR,EAAMO,EAAI,GAAGC,SACjHR,EAAMO,GAAIP,EAAMO,EAAI,IAAM,CAACP,EAAMO,EAAI,GAAIP,EAAMO,KAC/CD,EAAaC,GAAID,EAAaC,EAAI,IAAM,CAACD,EAAaC,EAAI,GAAID,EAAaC,KAKxF,OAAOP,EAGX,mBAAOS,CAAaT,GAChB,MAAMU,EAAYC,MAAcX,EAAMxE,QACtC,IAAK,IAAID,EAAI,EAAGA,EAAIyE,EAAMxE,SAAUD,EAAG,CACnC,MAAMqF,EAAQC,KAAKC,MAAMD,KAAKE,SAAWf,EAAMxE,QAE/CkF,EAAUnF,GAAKqF,EAEf,MAAMI,EAAOhB,EAAMzE,GACnByE,EAAMzE,GAAKyE,EAAMY,GACjBZ,EAAMY,GAASI,EAEnB,OAAON,EAGX,yBAAOO,CAAmBzC,GACtB,MAAM0C,EAAW9G,KAAKyE,YAAYL,GAClC,OAAOpE,KAAKqE,WAAWyC,EAAS1C,KAAM,EAAI0C,EAASxC,OAAQwC,EAAStC,WAGxE,gCAAOuC,CAA0B3C,EAAiBQ,GAC9C,MAAMkC,EAAW9G,KAAKyE,YAAYL,GAClC,OAAOpE,KAAKqE,WAAWyC,EAAS1C,KAAMQ,EAAakC,EAAStC,YChO9D,MAAOwC,UAA4BlH,EAKrC,WAAAC,CAAYyB,GACRyF,QALGjH,KAAQ0B,SAAW,sBAMtB1B,KAAKyB,KAAO,WACZzB,KAAKwB,KAAOA,EAGP,IAAAV,GACL,MAAMoB,EAAOlC,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4F,YAAcpH,KAAKwB,KAAK4C,MAEpFpE,KAAKwB,KAAK4F,YACVpH,KAAKK,IAAI4D,MAAMoD,WAAWrH,KAAKwB,KAAK4F,YACpCpH,KAAKK,IAAI4D,MAAMqD,QAAQpF,EAAMlC,KAAKwB,KAAK4C,MAEvCmD,QAAQC,IAAI,kBAAkBxH,KAAKwB,KAAK2F,WAAWnH,KAAKwB,KAAK4F,iBAAiBpH,KAAKwB,KAAK4C,SAExFmD,QAAQC,IAAI,kBAAkBxH,KAAKwB,KAAK2F,SAASnH,KAAKwB,KAAK4C,QAG/DpE,KAAKyH,aAAevF,EAAKU,SAErBZ,EAAaa,WAAWX,KACpBF,EAAac,YAAYZ,GACzBA,EAAKU,SAAW,SAEhBV,EAAKU,SAAW,iBAIxB5C,KAAKK,IAAIqH,QAAQC,SAAiC,CAC9CrD,OAAQtE,KAAKwB,KAAK8C,OAClBrE,UAAWD,KAAKS,eAChBgB,KAAMG,EAAcG,QAAQ6F,SAC5BT,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBhD,KAAMpE,KAAKwB,KAAK4C,KAChByD,iBAAkB7H,KAAKyH,aACvB7E,SAAUV,EAAKU,WAId,IAAA5B,GACL,MAAMkB,EAAOlC,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4C,MAE5DpE,KAAKwB,KAAK4F,YACVpH,KAAKK,IAAI4D,MAAMoD,WAAWrH,KAAKwB,KAAK4C,MACpCpE,KAAKK,IAAI4D,MAAMqD,QAAQpF,EAAMlC,KAAKwB,KAAK4F,YAEvCG,QAAQC,IAAI,kBAAkBxH,KAAKwB,KAAK2F,WAAWnH,KAAKwB,KAAK4F,iBAAiBpH,KAAKwB,KAAK4C,SAExFmD,QAAQC,IAAI,kBAAkBxH,KAAKwB,KAAK2F,SAASnH,KAAKwB,KAAK4C,QAG3DpE,KAAKyH,eACLvF,EAAKU,SAAW5C,KAAKyH,qBC3DpBK,EACT,6BAAO3D,CAAuBC,GAC1B,OAAOpC,EAAamC,uBAAuBC,GAG/C,oBAAO2D,EAAcC,SAAEA,EAAQ1D,OAAEA,IAC7B,OAAO0D,EAASnC,KAAI3D,GAAQ4F,EAASG,UAAU,CAAE/F,OAAMoC,SAAQ4D,gBAAgB,MAGnF,qBAAOC,EAAeC,UAAEA,EAAS9D,OAAEA,IAC/B,MAAM+D,EAAQD,EAAUvC,KAAI3D,GAAQ4F,EAASG,UAAU,CAAE/F,OAAMoC,SAAQ4D,gBAAgB,MAEvF,OADAlG,EAAagE,UAAUqC,GAChBA,EAGX,gBAAOJ,EAAU/F,KAAEA,EAAIoC,OAAEA,EAAM4D,eAAEA,IAC7B,IAAKhG,EAAM,MAAM,IAAIoG,MAAM,iCAQ3B,OAPApG,EAAKqG,MAAQjE,EACbpC,EAAKsG,cAAgBlE,EACrBpC,EAAKuG,WAAavG,EAAKwG,IACvBxG,EAAKyG,WAAazG,EAAK0G,IACvB1G,EAAK2G,UAAY,GACjB3G,EAAKgG,eAAiBA,EACtBhG,EAAKU,SAAW,WACTV,EAGX,qBAAO4G,CAAe5E,GAClB,MAAM0B,EAAQ,IAAImD,IAElB,IAAK,MAAMxF,KAASW,EAAQ,CAExB,IAAK,MAAMhC,KAAQqB,EAAMyE,SAChBpC,EAAMoD,IAAI9G,EAAKiF,KAChBvB,EAAMqD,IAAI/G,EAAKiF,GAAIjF,GAI3B,IAAK,MAAMA,KAAQqB,EAAM6E,UAChBxC,EAAMoD,IAAI9G,EAAKiF,KAChBvB,EAAMqD,IAAI/G,EAAKiF,GAAIjF,GAI3B,IAAK,MAAMA,KAAQqB,EAAMC,YACjBtB,IAAS0D,EAAMoD,IAAI9G,EAAKiF,KACxBvB,EAAMqD,IAAI/G,EAAKiF,GAAIjF,GAI3B,IAAK,MAAMA,KAAQqB,EAAM2F,cACjBhH,IAAS0D,EAAMoD,IAAI9G,EAAKiF,KACxBvB,EAAMqD,IAAI/G,EAAKiF,GAAIjF,GAI3B,IAAK,MAAMA,KAAQqB,EAAMG,iBACjBxB,IAAS0D,EAAMoD,IAAI9G,EAAKiF,KACxBvB,EAAMqD,IAAI/G,EAAKiF,GAAIjF,GAI3B,IAAK,MAAMA,KAAQqB,EAAM4F,UACjBjH,IAAS0D,EAAMoD,IAAI9G,EAAKiF,KACxBvB,EAAMqD,IAAI/G,EAAKiF,GAAIjF,GAI3B,IAAK,MAAMA,KAAQqB,EAAM6F,aACjBlH,IAAS0D,EAAMoD,IAAI9G,EAAKiF,KACxBvB,EAAMqD,IAAI/G,EAAKiF,GAAIjF,GAK/B,OAAO0D,EAGX,qBAAOyD,CAAejF,GAClB,MAAMQ,EAAckD,EAAS3D,uBAAuBC,GAC9CI,EAAYJ,EAAKO,MAAM,KAAK,GAElC,OAAIP,EAAKnB,WAAW,OACT,SAAyB,IAAhB2B,EAAoB,GAAK,OAAOJ,IAG7C,MAAsB,IAAhBI,EAAoB,GAAK,OAAOJ,IAGjD,8BAAO8E,CAAwBC,SAC3B,MAAMC,aAAEA,GAAe,GAASD,EAAME,SAAW,CAAE,EACnD,IAAIC,EAAY,EAEhB,MAoCMxF,EAAqC,CApCf,CACxByF,GAAI,IACJrF,OAAQ,CAAE8B,KAAM,QAChB4B,SAAU,GACVI,UAAW,GACXwB,KAAM,GACNpI,KAAM,CACFqI,gBAAiB,GACjBC,iBAAkB,IAEtBtG,YAAa,CAAC,KAAM,KAAM,KAAM,KAAM,MACtC0F,cAAe,CAAC,KAAM,KAAM,KAAM,KAAM,MACxCa,UAAW,KACXrG,iBAAkB,CAAC,KAAM,MACzByF,UAAW,GACXC,aAAc,IAGU,CACxBO,GAAI,IACJrF,OAAQ,CAAE8B,KAAM,SAChB4B,SAAU,GACVI,UAAW,GACXwB,KAAM,GACNpI,KAAM,CACFqI,gBAAiB,GACjBC,iBAAkB,IAEtBtG,YAAa,CAAC,KAAM,KAAM,KAAM,KAAM,MACtC0F,cAAe,CAAC,KAAM,KAAM,KAAM,KAAM,MACxCa,UAAW,KACXrG,iBAAkB,CAAC,KAAM,MACzByF,UAAW,GACXC,aAAc,KAKlB,IAAK,IAAIxE,EAAc,EAAGA,EAAc2E,EAAMS,QAAQ5I,SAAUwD,EAAa,CACzE,MAAMN,EAASiF,EAAMS,QAAQpF,GACvBrB,EAAQW,EAAOU,GACrBrB,EAAMyE,SAAWF,EAASC,cAAc,CAAEC,SAAU1D,EAAO0D,SAAoB1D,OAAQM,IACvFrB,EAAM6E,UAAYN,EAASK,eAAe,CAAEC,UAAW9D,EAAO8D,UAAqB9D,OAAQM,IAC3FrB,EAAMyE,SAASlE,SAAQ5B,GAAQA,EAAKsE,QAAUkD,IAC9CnG,EAAM6E,UAAUtE,SAAQ5B,GAAQA,EAAKsE,QAAUkD,IAkBnD,OAfIF,GACAtF,EAAOJ,SAAQ,CAACP,EAAOqB,KACf2E,EAAMS,QAAQpF,IACd5C,EAAaqE,aAAa9C,EAAMyE,aAK5C9D,EAAOJ,SAASP,IACZA,EAAM/B,KAAKqI,gBAAkBtG,EAAMyE,SAASnC,KAAI3D,GAAQA,EAAKiF,KAC7D5D,EAAM/B,KAAKsI,iBAAmBvG,EAAM6E,UAAUvC,KAAI3D,GAAQA,EAAKiF,IAAG,IAGtEnH,KAAKiK,cAAc/F,EAAqB,QAAbxD,EAAA6I,EAAME,eAAO9I,IAAAD,OAAAC,EAAAD,EAAEwJ,YAEnChG,EAGH,oBAAO+F,CAAc/F,EAAuBgG,GAChD,GAAI3D,MAAM4D,QAAQD,GAAa,CAC3B,MAAME,EAAwB,CAAC,IAAIC,IAAO,IAAIA,KACxCC,EAA6B,CAAC,IAAID,IAAO,IAAIA,KAE7CE,EAAU,CAACjG,EAAgB6C,KAE7B,MAAMjF,EAAOgC,EAAOI,GAAQ0D,SAASwC,MAAK1E,GAAKA,EAAEqB,KAAOA,IAAOiD,EAAsB9F,GAAQ0E,IAAIlD,KAEjG,GAAI5D,EAEA,OADAkI,EAAsB9F,GAAQmG,IAAIvI,GAC3BA,EAGX,MAAMwI,EAASxG,EAAOI,GAAQ8D,UAAUoC,MAAK1E,GAAKA,EAAEqB,KAAOA,IAAOmD,EAA2BhG,GAAQ0E,IAAIlD,KAEzG,GAAI4E,EAEA,OADAJ,EAA2BhG,GAAQmG,IAAIC,GAChCA,EAGX,MAAM,IAAIpC,MAAM,SAASnB,2BAA4B7C,UAAe,EAGxE,IAAK,IAAInD,EAAI,EAAGA,EAAI,IAAKA,EAAG,CACxB,MAAMyI,EAA6C,GAC7CT,EAAkD,GAClDwB,EAAiD,GAEvD,IAAK,MAAMC,KAAoBV,EAAY,CACvC,MAAMpD,EAAW9E,EAAayC,YAAYmG,EAAiBxG,MAE3D,GAAI0C,EAASxC,SAAWnD,EAExB,GAAsB,MAAlB2F,EAAS1C,KAAc,CACvB,MAAMlC,EAAOqI,EAAQzD,EAASxC,OAAQsG,EAAiBzD,IACvDyC,EAAKiB,KAAK,CAAE3I,OAAMsE,MAAOM,EAAStC,WAAa,SAC5C,GAAsB,MAAlBsC,EAAS1C,KAAc,CAC9B,MAAMxB,SAAEA,EAAW,iBAAoBgI,EACjC1I,EAAOqI,EAAQzD,EAASxC,OAAQsG,EAAiBzD,IACvDjD,EAAO4C,EAASxC,QAAQd,YAAYsD,EAAStC,UAAY,GAAKtC,EAE1D4F,EAASgD,UAAUF,EAAiBlC,OAAMxG,EAAKuG,WAAa3D,OAAO8F,EAAiBlC,MACpFZ,EAASgD,UAAUF,EAAiBhC,OAAM1G,EAAKyG,WAAa7D,OAAO8F,EAAiBhC,MACpFhG,IAAUV,EAAKU,SAAWA,GAC1BgI,EAAiB/B,YAAW3G,EAAK2G,UAAY+B,EAAiB/B,UAAUhD,KAAI,EAAGsB,QAASoD,EAAQzD,EAASxC,OAAQ6C,WAClH,GAAsB,QAAlBL,EAAS1C,KAAgB,CAChC,MAAMlC,EAAOqI,EAAQzD,EAASxC,OAAQsG,EAAiBzD,IACvDjD,EAAO4C,EAASxC,QAAQZ,iBAAiBoD,EAAStC,UAAY,GAAKtC,EAE/D4F,EAASgD,UAAUF,EAAiBlC,OAAMxG,EAAKuG,WAAa3D,OAAO8F,EAAiBlC,MACpFZ,EAASgD,UAAUF,EAAiBhC,OAAM1G,EAAKyG,WAAa7D,OAAO8F,EAAiBhC,MACpFgC,EAAiBhI,WAAUV,EAAKU,SAAWgI,EAAiBhI,UAC5DgI,EAAiB/B,YAAW3G,EAAK2G,UAAY+B,EAAiB/B,UAAUhD,KAAI,EAAGsB,QAASoD,EAAQzD,EAASxC,OAAQ6C,WAEpH,GAAsB,MAAlBL,EAAS1C,KAAc,CAC5B,MAAMlC,EAAOqI,EAAQzD,EAASxC,OAAQsG,EAAiBzD,IACvDjD,EAAO4C,EAASxC,QAAQ4E,cAAcpC,EAAStC,UAAY,GAAKtC,EAE5D0I,EAAiBhI,WAAUV,EAAKU,SAAWgI,EAAiBhI,eAC7D,GAAsB,MAAlBkE,EAAS1C,KAAc,CAC9B,MAAMlC,EAAOqI,EAAQzD,EAASxC,OAAQsG,EAAiBzD,IACvDjD,EAAO4C,EAASxC,QAAQyF,UAAY7H,EAEhC0I,EAAiBhI,WAAUV,EAAKU,SAAWgI,EAAiBhI,eAC7D,GAAsB,OAAlBkE,EAAS1C,KAAe,CAC/B,MAAMlC,EAAOqI,EAAQzD,EAASxC,OAAQsG,EAAiBzD,IACvDgC,EAAU0B,KAAK,CAAE3I,OAAMsE,MAAOM,EAAStC,WAAa,SACjD,GAAsB,MAAlBsC,EAAS1C,KAAc,CAC9B,MAAMlC,EAAOqI,EAAQzD,EAASxC,OAAQsG,EAAiBzD,IACvDwD,EAASE,KAAK,CAAE3I,OAAMsE,MAAOM,EAAStC,WAAa,SAC5CsC,EAAS1C,KAKpBwF,EAAKxI,OAAS,IACd8C,EAAO/C,GAAGyI,KAAO,IAAIA,GAAMmB,MAAK,CAACC,EAAOC,IAAUD,EAAMxE,MAAQyE,EAAMzE,QAAOX,KAAIqF,GAAcA,EAAWhJ,QAG1GiH,EAAU/H,OAAS,IACnB8C,EAAO/C,GAAGgI,UAAY,IAAIA,GAAW4B,MAAK,CAACC,EAAOC,IAAUD,EAAMxE,MAAQyE,EAAMzE,QAAOX,KAAIqF,GAAcA,EAAWhJ,QAGpHyI,EAASvJ,OAAS,IAClB8C,EAAO/C,GAAGyI,KAAO,IAAIe,GAAUI,MAAK,CAACC,EAAOC,IAAUD,EAAMxE,MAAQyE,EAAMzE,QAAOX,KAAIqF,GAAcA,EAAWhJ,QAItH,IAAK,IAAIf,EAAI,EAAGA,EAAI+C,EAAO9C,SAAUD,EACjC+C,EAAO/C,GAAG6G,SAAW9D,EAAO/C,GAAG6G,SAASmD,QAAOrF,IAAMsE,EAAsBjJ,GAAG6H,IAAIlD,KAClF5B,EAAO/C,GAAGiH,UAAYlE,EAAO/C,GAAGiH,UAAU+C,QAAOrF,IAAMsE,EAAsBjJ,GAAG6H,IAAIlD,MAKhG,gBAAOgF,CAAUM,GACb,OAAQC,MAAMvG,OAAOsG,IAGzB,wBAAOE,CAAkBlL,WACrB,MAAMoH,EAAgB,GAEtBA,EAAIqD,KAAK,yBAET,MAAMU,EAASnL,EAAIoL,SAAS,GACtBC,EAASrL,EAAIoL,SAAS,GAc5B,OAZAhE,EAAIqD,KAAK,YAAcU,EAAOjH,OAAO8B,MACrCoB,EAAIqD,KAAK,SAAWY,EAAO7B,KAAK/D,KAAIC,GAAKA,EAAEM,OAAMsF,KAAK,QACtDlE,EAAIqD,KAAK,oBAAsBY,EAAOvC,cAAcrD,KAAIC,IAAKA,aAACnF,EAADmF,EAAGM,OAAQ,MAAKsF,KAAK,QAClFlE,EAAIqD,KAAK,iBAAmBY,EAAOjI,YAAYqC,KAAIC,IAAKA,aAACnF,EAADmF,EAAGM,OAAQ,MAAKsF,KAAK,QAC7ElE,EAAIqD,KAAK,WACTrD,EAAIqD,KAAK,yBAAsF,QAA5DnK,EAAC6K,EAAO7H,iBAAiB,IAAM+H,EAAO/H,iBAAiB,UAAK/C,IAAAD,OAAAC,EAAAD,EAAA0F,OAAQ,KAAO,QAAqE,QAA5DuF,EAACJ,EAAO7H,iBAAiB,IAAM+H,EAAO/H,iBAAiB,UAAK/C,IAAAgL,OAAAhL,EAAAgL,EAAAvF,OAAQ,MAC3LoB,EAAIqD,KAAK,WACTrD,EAAIqD,KAAK,iBAAmBU,EAAO/H,YAAYqC,KAAIC,IAAKA,aAACnF,EAADmF,EAAGM,OAAQ,MAAKsF,KAAK,QAC7ElE,EAAIqD,KAAK,oBAAsBU,EAAOrC,cAAcrD,KAAIC,IAAKA,aAACnF,EAADmF,EAAGM,OAAQ,MAAKsF,KAAK,QAClFlE,EAAIqD,KAAK,SAAWU,EAAO3B,KAAK/D,KAAIC,GAAKA,EAAEM,OAAMsF,KAAK,QACtDlE,EAAIqD,KAAK,YAAcU,EAAOjH,OAAO8B,MAE9BoB,EAAIkE,KAAK,MAGpB,2BAAOE,CAAqBxL,GAUxB,MAAO,CACH4J,QAT8B5J,EAAI6D,MAAMC,OAAO2B,KAAKtC,IAC7C,CACH6C,KAAM7C,EAAMe,OAAO8B,KACnB4B,SAAUzE,EAAM/B,KAAKqI,gBAAgBhE,KAAIsB,GAAM/G,EAAI6D,MAAM4H,YAAY1E,KACrEiB,UAAW7E,EAAM/B,KAAKsI,iBAAiBjE,KAAIsB,GAAM/G,EAAI6D,MAAM4H,YAAY1E,SAM3EjG,SAAUd,EAAIc,SAAS2E,KAAIiG,GAAOA,EAAIvK,WACtCkI,QAAOsC,OAAAC,OAAAD,OAAAC,OAAA,CACHC,aAAc7L,EAAI8L,cACf9L,EAAImJ,MAAME,SAAW,KACxBD,cAAc,EACd2C,cAAc,MCtSxB,MAAOC,UAAgCtM,EAMzC,WAAAC,CAAYyB,GACRyF,QANGjH,KAAQ0B,SAAW,0BAOtB1B,KAAKyB,KAAO,oBACZzB,KAAKwB,KAAOA,EACZxB,KAAKkB,SAAW,GAChBlB,KAAKqM,gBAAkB,GACvB9E,QAAQC,IAAI,kBAGhB,IAAArH,CAAKC,GACD6G,MAAM9G,KAAKC,GACX,MAAM8B,EAAOlC,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4F,YAGhE,GAAIpH,KAAKsM,oBAAoBpK,EAAMlC,KAAKwB,KAAK4F,YAAa,CACtD,MAAMmF,EAAczE,EAASuB,eAAerJ,KAAKwB,KAAK4F,YACtDpH,KAAKqM,gBAAkB,GACvBnK,EAAK2G,UAAU/E,SAAQ0I,IACnB,MAAMpI,EAAOpC,EAAaqC,WAAWrE,KAAKwB,KAAK4C,KAAOoI,EAAShE,eAC/DxI,KAAKK,IAAI4D,MAAMqD,QAAQkF,EAAUpI,GACjCpE,KAAKqM,gBAAgBxB,KAAK,CAAE3I,KAAMsK,EAAUpI,SAC5CmD,QAAQC,IAAI,4BACZD,QAAQC,IAAI,OAAQgF,EAASpG,KAAMoG,EAAShE,cAAe,YAAapE,GACjD,OAAnBpE,KAAKwB,KAAK4C,MACVpE,KAAKK,IAAIqH,QAAQC,SAAiC,CAC9CrD,OAAQtE,KAAKwB,KAAK8C,OAClBrE,UAAWD,KAAKS,eAChBgB,KAAMG,EAAcG,QAAQ0K,SAC5BtF,GAAIqF,EAASrF,GACbC,WAAYmF,EACZnI,OACAsI,OAAQ,oBAIpBnF,QAAQC,IAAI,qBAAsBxH,KAAKqM,iBACvCnK,EAAK2G,UAAY,IAIhB,IAAA/H,GACLd,KAAKqB,yBAAyBrB,KAAKkB,UAG9B,IAAAF,GACLhB,KAAKiB,yBAAyBjB,KAAKkB,UAEnC,MAAMgB,EAAOlC,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4F,YAE5DpH,KAAKqM,gBAAgBjL,OAAS,GAC9BpB,KAAKqM,gBAAgBvI,SAAQ,EAAGM,WAC5BpE,KAAKK,IAAI4D,MAAMqD,QAAQ,KAAMlD,EAAK,IAI1ClC,EAAK2G,UAAY7I,KAAKqM,gBAAgBxG,KAAI,EAAG3D,UAAWA,IAGpD,mBAAAoK,CAAoBpK,EAAYkC,GACpC,SAAKlC,EAAK2G,WAAuC,IAA1B3G,EAAK2G,UAAUzH,SCpExC,MAAOuL,UAAwB7M,EASjC,WAAAC,CAAYyB,GACRyF,QATGjH,KAAQ0B,SAAW,kBAUtB,MAAMD,EAAOD,EAAKC,MAAQ,YAC1BzB,KAAKyB,KAAOA,EACZzB,KAAKwB,KAAOA,EACZxB,KAAK4M,QAAU,EACf5M,KAAK6M,QAAU,EACf7M,KAAKkB,SAAW,GAChBlB,KAAKwB,KAAKC,KAAOA,EAGZ,IAAAX,GACLyG,QAAQC,IAAI,SAASxH,KAAKwB,KAAKC,QAAQzB,KAAKwB,KAAK2F,YAAYnH,KAAKwB,KAAK4F,kBAAkBpH,KAAKwB,KAAK4C,QACnG,MAAMoD,IAAEA,GAAM,GAASxH,KAAKwB,KACtBU,EAAOlC,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4F,YAC1D0F,EAAiB9K,EAAayC,YAAYzE,KAAKwB,KAAK4F,YACpDN,EAAW9E,EAAayC,YAAYzE,KAAKwB,KAAK4C,MAC9Cb,EAAQvD,KAAKK,IAAImL,SAAS1E,EAASxC,QAyCzC,GAvCAtE,KAAKkB,SAAW,GAEhBlB,KAAK+M,UAAY7K,EAAKqG,MACtBrG,EAAKqG,MAAQzB,EAASxC,OAEtBtE,KAAK4M,QAAU1K,EAAKuG,WACpBzI,KAAK6M,QAAU3K,EAAKyG,WAEQ,MAAxBmE,EAAe1I,MAAkC,MAAlB0C,EAAS1C,OACxClC,EAAKuG,WAAavG,EAAKwG,IACvBxG,EAAKyG,WAAazG,EAAK0G,KAGJ,OAAnB5I,KAAKwB,KAAK4C,MAAoC,QAAnBpE,KAAKwB,KAAK4C,OACrCpE,KAAKyH,aAAevF,EAAKU,SACzB5C,KAAKwB,KAAKoB,SAAWZ,EAAaS,eAAeP,GAAQ,SAAW,YAGpElC,KAAKwB,KAAKoB,WACV5C,KAAKyH,aAAevF,EAAKU,SACzBV,EAAKU,SAAW5C,KAAKwB,KAAKoB,UAG1B5C,KAAKsM,oBAAoBpK,EAAM4E,IAC/B9G,KAAKkB,SAAS2J,KAAK,IAAIuB,EAAwB,CAC3C9H,OAAQtE,KAAKwB,KAAK8C,OAClB6C,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBhD,KAAM,QAIVpE,KAAKkB,SAASE,OAAS,GACvBpB,KAAKqB,yBAAyBrB,KAAKkB,UAIvClB,KAAKK,IAAI4D,MAAM+I,SAAS9K,EAAMlC,KAAKwB,KAAK4F,WAAYpH,KAAKwB,KAAK4C,MAExC,OAAlB0C,EAAS1C,KAAe,CACxB,MAAM6I,EAAiB1J,EAAM6E,UAAU8E,WAAUpH,GAAKA,IAAM5D,KACrC,IAAnB+K,IACAjN,KAAKwB,KAAK4C,KAAOpC,EAAaqC,WAAWyC,EAAS1C,KAAM0C,EAASxC,OAAQ2I,EAAiB,IAI9FzF,GACAxH,KAAKK,IAAIqH,QAAQC,SAAc,CAC3BrD,OAAQtE,KAAKwB,KAAK8C,OAClBrE,UAAWD,KAAKS,eAChBgB,KAAMzB,KAAKyB,KACX0F,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBhD,KAAMpE,KAAKwB,KAAK4C,KAChBsI,OAAQ1M,KAAKwB,KAAKkL,OAClB9J,SAAUV,EAAKU,WAKlB,IAAA5B,GACLuG,QAAQC,IAAI,SAASxH,KAAKwB,KAAKC,QAAQzB,KAAKwB,KAAK2F,YAAYnH,KAAKwB,KAAK4F,kBAAkBpH,KAAKwB,KAAK4C,QAEnG,MAAMlC,EAAOlC,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4C,MAEhElC,EAAKqG,MAAQvI,KAAK+M,UAClB7K,EAAKuG,WAAazI,KAAK4M,QACvB1K,EAAKyG,WAAa3I,KAAK6M,QAEnB7M,KAAKyH,eACLvF,EAAKU,SAAW5C,KAAKyH,cAGzBzH,KAAKK,IAAI4D,MAAM+I,SAAS9K,EAAMlC,KAAKwB,KAAK4C,KAAMpE,KAAKwB,KAAK4F,YAEpDpH,KAAKkB,SAASE,OAAS,IACvBpB,KAAKiB,yBAAyBjB,KAAKkB,UACnClB,KAAKkB,SAAW,IAIhB,mBAAAoL,CAAoBpK,EAAY4E,GACpC,SAAK5E,EAAK2G,WAAuC,IAA1B3G,EAAK2G,UAAUzH,UAChB,OAAlB0F,EAAS1C,MACS,MAAlB0C,EAAS1C,OC/Gf,MAAO+I,UAAsBrN,EAM/B,WAAAC,CAAYyB,GACRyF,QANGjH,KAAQ0B,SAAW,gBAOtB1B,KAAKwB,KAAOA,EACZxB,KAAKwB,KAAKoB,SAAW5C,KAAKwB,KAAKoB,UAAY,SAC3C5C,KAAKyB,KAA8B,WAAvBzB,KAAKwB,KAAKoB,SAAwB,SAAW,YAG7D,IAAAzC,CAAKC,GACD6G,MAAM9G,KAAKC,GAEX,MAAM8B,EAAOlC,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4F,YAChEpH,KAAKoE,KAAOpC,EAAaqC,WAAW,IAAKnC,EAAKsG,cAAe,GAE7DxI,KAAKoN,cAAgB,IAAIT,EAAgB,CACrCrI,OAAQtE,KAAKwB,KAAK8C,OAClB7C,KAAMzB,KAAKyB,KACX0F,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBxE,SAAU5C,KAAKwB,KAAKoB,SACpBwB,KAAMpE,KAAKoE,OAInB,IAAAtD,GACId,KAAKY,iBAAiBZ,KAAKoN,eAG/B,IAAApM,GACIhB,KAAKe,iBAAiBf,KAAKoN,gBCpC7B,MAAOC,UAAgCvN,EAMzC,WAAAC,CAAYyB,GACRyF,QANGjH,KAAQ0B,SAAW,0BAOtB1B,KAAKyB,KAAO,sBACZzB,KAAKwB,KAAOA,EACZxB,KAAKsN,OAAS,EACdtN,KAAKuN,OAAS,EAGT,IAAAzM,GACL,MAAMoB,EAAOlC,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4F,YAEhEpH,KAAKsN,OAASpL,EAAKuG,WACnBzI,KAAKuN,OAASrL,EAAKyG,WAEfb,EAASgD,UAAU9K,KAAKwB,KAAKkH,OAC7BxG,EAAKuG,WAAa3D,OAAO9E,KAAKwB,KAAKkH,MAGnCZ,EAASgD,UAAU9K,KAAKwB,KAAKoH,OAC7B1G,EAAKyG,WAAa7D,OAAO9E,KAAKwB,KAAKoH,MAGvC5I,KAAKK,IAAIqH,QAAQC,SAAyC,CACtDrD,OAAQtE,KAAKwB,KAAK8C,OAClBrE,UAAWD,KAAKS,eAChBgB,KAAMG,EAAcG,QAAQyL,iBAC5BrG,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBsB,IAAKxG,EAAKuG,WACVG,IAAK1G,EAAKyG,WACV2E,OAAQtN,KAAKsN,OACbC,OAAQvN,KAAKuN,SAIZ,IAAAvM,GACL,MAAMkB,EAAOlC,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4F,YAChElF,EAAKuG,WAAazI,KAAKsN,OACvBpL,EAAKyG,WAAa3I,KAAKuN,QC5CzB,MAAOE,UAAkC3N,EAK3C,WAAAC,CAAYyB,GACRyF,QALGjH,KAAQ0B,SAAW,4BAMtB1B,KAAKyB,KAAO,uBACZzB,KAAKwB,KAAOA,EAGP,IAAAV,GACL,MAAMoB,EAAOlC,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4F,YAEhEpH,KAAKyH,aAAevF,EAAKU,SAEzBV,EAAKU,SAAW5C,KAAKwB,KAAKoB,SAE1B5C,KAAKK,IAAIqH,QAAQC,SAA2C,CACxDrD,OAAQtE,KAAKwB,KAAK8C,OAClBrE,UAAWD,KAAKS,eAChBgB,KAAMG,EAAcG,QAAQ2L,mBAC5BvG,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBS,iBAAkB7H,KAAKyH,aACvB7E,SAAU5C,KAAKwB,KAAKoB,WAInB,IAAA5B,GACL,MAAMkB,EAAOlC,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4F,YAE5DpH,KAAKyH,eACLvF,EAAKU,SAAW5C,KAAKyH,eChC3B,MAAOkG,UAA2B7N,EAMpC,WAAAC,CAAYyB,GACRyF,QANGjH,KAAQ0B,SAAW,qBAQtB1B,KAAKyB,KAAO,UACZzB,KAAKwB,KAAOA,EACZxB,KAAKoE,KAAO5C,EAAK4C,MAAQpC,EAAaqC,WAAW,KAAMrE,KAAKwB,KAAK8C,OAAQ,GAEzEtE,KAAK4N,gBAAkB,IAAIjB,EAAgB,CACvCrI,OAAQtE,KAAKwB,KAAK8C,OAClB7C,KAAMzB,KAAKyB,KACX0F,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBhD,KAAMpE,KAAKoE,OAInB,IAAAtD,GACId,KAAKY,iBAAiBZ,KAAK4N,iBAG/B,IAAA5M,GACIhB,KAAKe,iBAAiBf,KAAK4N,kBC3B7B,MAAOC,UAA4B/N,EAKrC,WAAAC,CAAYyB,GACRyF,QALGjH,KAAQ0B,SAAW,sBAOtB1B,KAAKyB,KAAO,iBACZzB,KAAKwB,KAAOA,EACZxB,KAAKwB,KAAKsM,cAAgB9N,KAAKwB,KAAKsM,eAAiB,EACrD9N,KAAK4F,MAAQ,GAGjB,IAAA9E,GACIyG,QAAQC,IAAI,cAAcxH,KAAKwB,KAAKsM,2BAEpC9N,KAAK4F,MAAQ,GAEb,MAAMrC,EAAQvD,KAAKK,IAAI4D,MAAMC,OAAOlE,KAAKwB,KAAK8C,QAE9C,IAAK,IAAInD,EAAI,EAAGA,EAAInB,KAAKwB,KAAKsM,gBAAkB3M,EAAG,CAC/C,MAAMe,EAAOqB,EAAMyE,SAAS+F,MAC5BxG,QAAQC,IAAI,OAAQtF,EAAKkE,MAEzB7C,EAAMqG,KAAKiB,KAAK3I,GAChBlC,KAAK4F,MAAMiF,KAAK3I,GAEhB,MAAMkF,EAAapF,EAAaqC,WAAW,IAAKrE,KAAKwB,KAAK8C,OAAQf,EAAMyE,SAAS5G,OAAS,GACpFgD,EAAOpC,EAAaqC,WAAW,IAAKrE,KAAKwB,KAAK8C,OAAQf,EAAMqG,KAAKxI,QAEvEpB,KAAKK,IAAIqH,QAAQC,SAAqC,CAClD1H,UAAWD,KAAKS,eAChB6D,OAAQtE,KAAKwB,KAAK8C,OAClB7C,KAAMG,EAAcG,QAAQiM,iBAC5B7G,GAAIjF,EAAKiF,GACTC,aACAhD,UAKZ,IAAApD,GACIuG,QAAQC,IAAI,cAAcxH,KAAKwB,KAAKsM,2BAEpC,MAAMG,EAAW,IAAIjO,KAAK4F,OAAOsI,UAC3B3K,EAAQvD,KAAKK,IAAI4D,MAAMC,OAAOlE,KAAKwB,KAAK8C,QAE9CiD,QAAQC,IAAI,kBACZD,QAAQC,IAAIyG,EAASpI,KAAIC,GAAKA,EAAEM,QAChCmB,QAAQC,IAAI,WAAYjE,EAAMyE,SAAS5G,QACvC,IAAK,MAAMc,KAAQ+L,EAAU,CACzB,MAAME,EAAkB5K,EAAMqG,KAAKsD,WAAUpH,GAAKA,IAAM5D,KAChC,IAApBiM,GACA5K,EAAMqG,KAAKwE,OAAOD,EAAiB,GAG3C5K,EAAMyE,SAAS6C,QAAQoD,GAEvB1G,QAAQC,IAAIjE,EAAMqG,KAAK/D,KAAIC,GAAKA,EAAEM,QAClCmB,QAAQC,IAAI,WAAYjE,EAAMyE,SAAS5G,SC9DzC,MAAOiN,UAAsBvO,EAI/B,WAAAC,CAAYyB,GACRyF,QAJGjH,KAAQ0B,SAAW,gBAKtB1B,KAAKyB,KAAO,SACZzB,KAAKwB,KAAOA,EAGP,IAAAV,GACLd,KAAKK,IAAIqH,QAAQC,SAA+B,CAC5ClG,KAAMG,EAAcG,QAAQuM,OAC5BhK,OAAQtE,KAAKwB,KAAK8C,OAClBrE,UAAWD,KAAKS,eAChB0G,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,cCb5B,MAAOmH,UAA4BzO,EAMrC,WAAAC,CAAYyB,GACRyF,QANGjH,KAAQ0B,SAAW,sBAQtB1B,KAAKyB,KAAO,aACZzB,KAAKwB,KAAOA,EAEhB,IAAArB,CAAKC,GACD6G,MAAM9G,KAAKC,GAEX,MAAM8B,EAAOlC,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4F,YAChEpH,KAAKoE,KAAOpE,KAAKwB,KAAK4C,MAAQpC,EAAaqC,WAAW,KAAMnC,EAAKsG,cAAe,GAEhFxI,KAAK4N,gBAAkB,IAAIjB,EAAgB,CACvCrI,OAAQtE,KAAKwB,KAAK8C,OAClB7C,KAAMzB,KAAKyB,KACX0F,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBsF,OAAQ1M,KAAKwB,KAAKkL,OAClB9J,SAAU,SACVwB,KAAMpE,KAAKoE,OAInB,IAAAtD,GACId,KAAKY,iBAAiBZ,KAAK4N,iBAG/B,IAAA5M,GACIhB,KAAKe,iBAAiBf,KAAK4N,kBCjC7B,MAAOY,UAA0B1O,EAKnC,WAAAC,CAAYyB,GACRyF,QALGjH,KAAQ0B,SAAW,oBAOtB1B,KAAKyB,KAAO,cACZzB,KAAKwB,KAAOA,EACZxB,KAAKwB,KAAKoB,SAA6B,aAAlBpB,EAAKoB,SAA0B,WAAa,SACjE5C,KAAKkB,SAAW,GAGpB,IAAAf,CAAKC,GACD6G,MAAM9G,KAAKC,GAEX,MAAMqO,EAAYzO,KAAKK,IAAImL,SAASxL,KAAKwB,KAAK8C,QAAQyF,UAElD0E,GACAzO,KAAKkB,SAASkN,OAAO,EAAG,EAAG,IAAIG,EAAoB,CAC/CjK,OAAQtE,KAAKwB,KAAK8C,OAClB6C,GAAIsH,EAAUtH,GACdC,WAAYpF,EAAaqC,WAAW,IAAKrE,KAAKwB,KAAK8C,WAI3DtE,KAAKkB,SAAS2J,KAAK,IAAI8B,EAAgB,CACnCrI,OAAQtE,KAAKwB,KAAK8C,OAClB7C,KAAMzB,KAAKyB,KACX0F,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBhD,KAAMpE,KAAKwB,KAAK4C,KAChBxB,SAAU5C,KAAKwB,KAAKoB,YAGpB5C,KAAKwB,KAAKkN,QACV1O,KAAKkB,SAAS2J,KAAK,IAAIwD,EAAc,CACjClH,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4C,KACtBE,OAAQtE,KAAKwB,KAAK8C,UAKrB,IAAAxD,GACLd,KAAKqB,yBAAyBrB,KAAKkB,UAG9B,IAAAF,GACLhB,KAAKiB,yBAAyBjB,KAAKkB,WCpDrC,MAAOyN,UAAoB7O,EAK7B,WAAAC,CAAYyB,GACRyF,QALGjH,KAAQ0B,SAAW,cAMtB1B,KAAKyB,KAAO,OACZzB,KAAKwB,KAAOA,EAGP,IAAAV,GACL,MAAMoB,EAAOlC,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4F,YAEhEpH,KAAKyH,aAAevF,EAAKU,SAErBZ,EAAaa,WAAWX,GACxBA,EAAKU,SAAW,gBAEhBV,EAAKU,SAAW,iBAGpB5C,KAAKK,IAAIqH,QAAQC,SAA6B,CAC1ClG,KAAMG,EAAcG,QAAQ6M,KAC5B3O,UAAWD,KAAKS,eAChB6D,OAAQtE,KAAKwB,KAAK8C,OAClB6C,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBS,iBAAkB7H,KAAKyH,aACvB7E,SAAUV,EAAKU,WAId,IAAA5B,GACL,MAAMkB,EAAOlC,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4F,YAE5DpH,KAAKyH,eACLvF,EAAKU,SAAW5C,KAAKyH,eClC3B,MAAOoH,UAA4B/O,EAOrC,WAAAC,CAAYyB,GACRyF,QAPGjH,KAAQ0B,SAAW,sBAIlB1B,KAAS6I,UAAqD,GAIlE7I,KAAKyB,KAAO,gBACZzB,KAAKwB,KAAOA,EACZxB,KAAKwB,KAAKoB,SAAW5C,KAAKwB,KAAKoB,UAAY,gBAC3C5C,KAAKkB,SAAW,GAChBlB,KAAK8O,kBAAoB,GAG7B,IAAA3O,CAAKC,GACD6G,MAAM9G,KAAKC,GAEX,MAAM2O,EAAwB/O,KAAKwB,KAAKqH,UAAUhD,KAAI2G,IAC3C,CACHA,WACA1F,SAAU9E,EAAayC,YAAY+H,EAASpI,UAIpD2K,EAAsBhE,MAAK,CAACiE,EAAIC,IAAOA,EAAGnI,SAAStC,UAAYwK,EAAGlI,SAAStC,YAE3ExE,KAAK6I,UAAYkG,EAAsBlJ,KAAI,EAAG2G,eAC1C,MAAM0C,EAAelP,KAAKK,IAAI4D,MAAMiD,YAAYsF,EAASrF,GAAIqF,EAASpI,MAStE,OAPApE,KAAK8O,kBAAkBjE,KAAK,IAAI0D,EAAoB,CAChDjK,OAAQtE,KAAKwB,KAAK8C,OAClB6C,GAAIqF,EAASrF,GACbC,WAAYoF,EAASpI,KACrBsI,OAAQ,mBAGL,CACHvF,GAAIqF,EAASrF,GACb/C,KAAMoI,EAASpI,KACfmE,MAAO2G,EAAa1G,cACvB,IAGLxI,KAAKkB,SAAS2J,KAAK,IAAI8B,EAAgB,CACnCrI,OAAQtE,KAAKwB,KAAK8C,OAClB7C,KAAMzB,KAAKyB,KACX0F,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBhD,KAAMpE,KAAKwB,KAAK4C,KAChBxB,SAAU5C,KAAKwB,KAAKoB,SACpB4E,KAAK,KAIJ,IAAA1G,GACLd,KAAKqB,yBAAyBrB,KAAK8O,mBACnC9O,KAAKqB,yBAAyBrB,KAAKkB,UAEnClB,KAAKK,IAAIqH,QAAQC,SAAqC,CAClDrD,OAAQtE,KAAKwB,KAAK8C,OAClBrE,UAAWD,KAAKS,eAChBgB,KAAMG,EAAcG,QAAQoN,aAC5BhI,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBxE,SAAU5C,KAAKwB,KAAKoB,SACpBwB,KAAMpE,KAAKwB,KAAK4C,KAChByE,UAAW7I,KAAK6I,YAIf,IAAA7H,GAEL,IAAK,IAAIG,EAAInB,KAAK8O,kBAAkB1N,OAAS,EAAGD,GAAK,IAAKA,EACtDnB,KAAKe,iBAAiBf,KAAK8O,kBAAkB3N,IAGjDnB,KAAKiB,yBAAyBjB,KAAKkB,WC9ErC,MAAOkO,UAA0BtP,EAOnC,WAAAC,CAAYyB,GACRyF,QAPGjH,KAAQ0B,SAAW,oBAIlB1B,KAAS6I,UAAqD,GAIlE7I,KAAKyB,KAAO,cACZzB,KAAKwB,KAAOA,EACZxB,KAAK4C,SAAW,gBAChB5C,KAAKkB,SAAW,GAEpB,IAAAf,CAAKC,GACD6G,MAAM9G,KAAKC,GAEXJ,KAAK6I,UAAY7I,KAAKwB,KAAKqH,UAAUhD,KAAI2G,IACrC,MAAM0C,EAAelP,KAAKK,IAAI4D,MAAMiD,YAAYsF,EAASrF,GAAIqF,EAASpI,MAStE,OAPApE,KAAKkB,SAAS2J,KAAK,IAAI0D,EAAoB,CACvCjK,OAAQtE,KAAKwB,KAAK8C,OAClB6C,GAAIqF,EAASrF,GACbC,WAAYoF,EAASpI,KACrBsI,OAAQ,iBAGL,CACHvF,GAAIqF,EAASrF,GACb/C,KAAMoI,EAASpI,KACfmE,MAAO2G,EAAa1G,cACvB,IAGL,MAAMtG,EAAOlC,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4F,YAC1DN,EAAW9E,EAAayC,YAAYzE,KAAKwB,KAAK4C,MAE9B,QAAlB0C,EAAS1C,OACTpE,KAAKwB,KAAK4C,KAAOpC,EAAaqC,WAAWyC,EAAS1C,KAAMlC,EAAKsG,cAAe1B,EAAStC,YAGzFxE,KAAKkB,SAAS2J,KAAK,IAAI8B,EAAgB,CACnCrI,OAAQtE,KAAKwB,KAAK8C,OAClB7C,KAAMzB,KAAKyB,KACX0F,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBhD,KAAMpE,KAAKwB,KAAK4C,KAChBxB,SAAU5C,KAAK4C,SACf4E,KAAK,KAIJ,IAAA1G,GACLd,KAAKqB,yBAAyBrB,KAAKkB,UAEnClB,KAAKK,IAAIqH,QAAQC,SAAmC,CAChDrD,OAAQtE,KAAKwB,KAAK8C,OAClBrE,UAAWD,KAAKS,eAChBgB,KAAMG,EAAcG,QAAQsN,WAC5BlI,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBhD,KAAMpE,KAAKwB,KAAK4C,KAChByE,UAAW7I,KAAK6I,YAIf,IAAA7H,GACLhB,KAAKiB,yBAAyBjB,KAAKkB,WCtErC,MAAOoO,UAA4BxP,EAKrC,WAAAC,CAAYyB,GACRyF,QALGjH,KAAQ0B,SAAW,sBAOtB1B,KAAKyB,KAAO,iBACZ,MAAMqM,cAAEA,EAAgB,GAAMtM,EAC9BxB,KAAKwB,KAAOA,EACZxB,KAAKwB,KAAKsM,cAAgBrH,KAAK8I,IAAI,EAAGzB,GACtC9N,KAAKkB,SAAW,GAGX,IAAAf,CAAKC,GACV6G,MAAM9G,KAAKC,GAEX,MAAMmD,EAAQvD,KAAKK,IAAImL,SAASxL,KAAKwB,KAAK8C,QACpCwJ,EAAgBrH,KAAK+I,IAAIxP,KAAKwB,KAAKsM,cAAgBvK,EAAMyE,SAAS5G,QAExE,IAAK,IAAID,EAAI,EAAGA,EAAI2M,IAAkB3M,EAAG,CACrC,MAAMuI,EAAYnG,EAAMyE,SAAS5G,OAAS,EAAID,EACxCe,EAAOqB,EAAMyE,SAAS0B,GAI5B1J,KAAKkB,SAAS2J,KAAK,IAAI0D,EAAoB,CACvCpH,GAAIjF,EAAKiF,GACTC,WAAYpF,EAAaqC,WAAW,IAAKrE,KAAKwB,KAAK8C,OAAQoF,EAAY,GACvEpF,OAAQtE,KAAKwB,KAAK8C,WAK9B,IAAAxD,GACId,KAAKqB,yBAAyBrB,KAAKkB,UAGvC,IAAAF,GACIhB,KAAKiB,yBAAyBjB,KAAKkB,WC1CrC,MAAOuO,UAA4B3P,EAKrC,WAAAC,CAAYyB,GACRyF,QALGjH,KAAQ0B,SAAW,sBAMtB1B,KAAKyB,KAAO,gBACZzB,KAAKwB,KAAOA,EACZxB,KAAKwB,KAAKoB,SAAW,gBAErB5C,KAAK4N,gBAAkB,IAAIjB,EAAgB,CACvCrI,OAAQtE,KAAKwB,KAAK8C,OAClB7C,KAAMzB,KAAKyB,KACX0F,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBhD,KAAMpE,KAAKwB,KAAK4C,KAChBxB,SAAU5C,KAAKwB,KAAKoB,WAInB,IAAA9B,GACLd,KAAKY,iBAAiBZ,KAAK4N,iBAGtB,IAAA5M,GACLhB,KAAKe,iBAAiBf,KAAK4N,kBCrB7B,MAAO8B,UAAuB5P,EAOhC,WAAAC,CAAYyB,GACRyF,QAPGjH,KAAQ0B,SAAW,iBAQtB1B,KAAKyB,KAAO,SACZzB,KAAKqC,WAAY,EACjBrC,KAAKwB,KAAOA,EACZxB,KAAKkB,SAAW,GAGpB,IAAAf,CAAKC,GACD6G,MAAM9G,KAAKC,GAEX,MAAM8B,EAAOlC,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4F,YAChEpH,KAAKqC,UAAYL,EAAaK,UAAUH,GACxClC,KAAKyB,KAAOzB,KAAKqC,UAAY,cAAgB,SAE7CrC,KAAKkB,SAAW,GAEZlB,KAAKwB,KAAK4C,OACVpE,KAAKkB,SAAS2J,KAAK,IAAI8B,EAAgB,CACnCrI,OAAQtE,KAAKwB,KAAK8C,OAClB7C,KAAMzB,KAAKyB,KACX0F,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBhD,KAAMpE,KAAKwB,KAAK4C,KAChBxB,SAAU,cAGV5C,KAAKwB,KAAKkN,QACV1O,KAAKkB,SAAS2J,KAAK,IAAIwD,EAAc,CACjC/J,OAAQtE,KAAKwB,KAAK8C,OAClB6C,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4C,SAMtC,IAAAtD,GACI,GAAId,KAAKkB,SAASE,OAAS,EACvBpB,KAAKqB,yBAAyBrB,KAAKkB,cAChC,CACH,MAAMgB,EAAOlC,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4F,YAChEpH,KAAKyH,aAAevF,EAAKU,SACzBV,EAAKU,SAAW,WAEE,gBAAd5C,KAAKyB,KACLzB,KAAKK,IAAIqH,QAAQC,SAAmC,CAChDlG,KAAMG,EAAcG,QAAQ4N,WAC5B1P,UAAWD,KAAKS,eAChB6D,OAAQtE,KAAKwB,KAAK8C,OAClB6C,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,aAG1BpH,KAAKK,IAAIqH,QAAQC,SAAmC,CAChDlG,KAAMG,EAAcG,QAAQ6N,MAC5B3P,UAAWD,KAAKS,eAChB6D,OAAQtE,KAAKwB,KAAK8C,OAClB6C,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,cAMtC,IAAApG,GAKI,GAJIhB,KAAKkB,SAASE,OAAS,GACvBpB,KAAKiB,yBAAyBjB,KAAKkB,UAGnClB,KAAKyH,aAAc,CACNzH,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4F,YAC3DxE,SAAW5C,KAAKyH,eCpF3B,MAAOoI,UAA0B/P,EAKnC,WAAAC,CAAYyB,GACRyF,QALGjH,KAAQ0B,SAAW,oBAMtB1B,KAAKyB,KAAO,cACZzB,KAAKwB,KAAOA,EACZxB,KAAK4N,gBAAkB,IAAIjB,EAAgB,CACvCrI,OAAQtE,KAAKwB,KAAK8C,OAClB7C,KAAMzB,KAAKyB,KACX0F,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBhD,KAAMpE,KAAKwB,KAAK4C,KAChBxB,SAAU,aAIlB,IAAA9B,GACId,KAAKY,iBAAiBZ,KAAK4N,iBAG/B,IAAA5M,GACIhB,KAAKe,iBAAiBf,KAAK4N,kBCvB7B,MAAOkC,UAA2BhQ,EAKpC,WAAAC,CAAYyB,GACRyF,QALGjH,KAAQ0B,SAAW,qBAMtB1B,KAAKwB,KAAOA,EACZxB,KAAKyB,KAAO,eAGhB,IAAAX,GACIyG,QAAQC,IAAI,qEACZ,MAAMQ,EAAWhI,KAAKK,IAAI4D,MAAMC,OAAOlE,KAAKwB,KAAK8C,QAAQ0D,SAEzD,GAAIhI,KAAK+P,cACL,IAAK,IAAI5O,EAAI,EAAGA,EAAInB,KAAK+P,cAAc3O,SAAUD,EAAG,CAChD,MAAMqF,EAAQxG,KAAK+P,cAAc5O,GAC3ByF,EAAOoB,EAASxB,GACtBwB,EAASxB,GAASwB,EAAS7G,GAC3B6G,EAAS7G,GAAKyF,OAGlB5G,KAAK+P,cAAgB/N,EAAaqE,aAAa2B,IAG7B,IAAlBhI,KAAKwB,KAAKgG,KACVxH,KAAKK,IAAIqH,QAAQC,SAAgC,CAC7CrD,OAAQtE,KAAKwB,KAAK8C,OAClBrE,UAAWD,KAAKS,eAChBgB,KAAMG,EAAcG,QAAQiO,UAKxC,IAAAhP,GACI,MAAMgH,EAAWhI,KAAKK,IAAI4D,MAAMC,OAAOlE,KAAKwB,KAAK8C,QAAQ0D,SACzD,IAAK,IAAI7G,EAAI,EAAGA,EAAInB,KAAK+P,cAAc3O,SAAUD,EAAG,CAChD,MAAMqF,EAAQxG,KAAK+P,cAAc5O,GAC3ByF,EAAOoB,EAASxB,GACtBwB,EAASxB,GAASwB,EAAS7G,GAC3B6G,EAAS7G,GAAKyF,IC1CpB,MAAOqJ,UAA6BnQ,EAKtC,WAAAC,CAAYyB,GACRyF,QALGjH,KAAQ0B,SAAW,uBAMtB1B,KAAKyB,KAAO,iBACZzB,KAAKwB,KAAOA,EACZxB,KAAKwB,KAAKoB,SAAW5C,KAAKwB,KAAKoB,UAAY,gBAEhB,kBAAvB5C,KAAKwB,KAAKoB,UACgB,mBAAvB5C,KAAKwB,KAAKoB,WACb5C,KAAKwB,KAAKoB,SAAW,iBAGzB5C,KAAK4N,gBAAkB,IAAIjB,EAAgB,CACvCrI,OAAQtE,KAAKwB,KAAK8C,OAClB7C,KAAM,iBACN0F,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBhD,KAAMpE,KAAKwB,KAAK4C,KAChBxB,SAAU5C,KAAKwB,KAAKoB,WAI5B,IAAA9B,GACId,KAAKY,iBAAiBZ,KAAK4N,iBAG/B,IAAA5M,GACIhB,KAAKe,iBAAiBf,KAAK4N,kBC7B7B,MAAOsC,UAAyBpQ,EAKlC,WAAAC,CAAYyB,GACRyF,QALGjH,KAAQ0B,SAAW,mBAMtB1B,KAAKyB,KAAO,aACZzB,KAAKwB,KAAOA,EACZxB,KAAK4F,MAAQ,GACZ5F,KAAamQ,MAAO,EAGzB,IAAArP,GACI,MAAMyC,EAAQvD,KAAKK,IAAImL,SAASxL,KAAKwB,KAAK8C,QAE1C,GAAItE,KAAK4F,MAAMxE,OAAS,EACpB,IAAK,IAAID,EAAI,EAAGA,EAAInB,KAAK4F,MAAMxE,SAAUD,EAAG,CACxC,MAAMe,EAAOqB,EAAMyE,SAASoI,QACxBlO,GACAqB,EAAMqG,KAAKiB,KAAK3I,QAGrB,GAAIqB,EAAMqG,KAAKxI,OAAS,EAC3BpB,KAAK4F,MAAQ,IAAIrC,EAAMqG,UACpB,CACH5J,KAAK4F,MAAQ,GACb,MAAMyK,EAAiB5J,KAAK+I,IAAIxP,KAAKwB,KAAKsM,cAAevK,EAAMyE,SAAS5G,QAExE,IAAK,IAAID,EAAI,EAAGA,EAAIkP,IAAkBlP,EAAG,CACrC,MAAMe,EAAOqB,EAAMyE,SAASoI,QACxBlO,IACAqB,EAAMqG,KAAKiB,KAAK3I,GAChBlC,KAAK4F,MAAMiF,KAAK3I,KAK5B,MAAM0D,EAA2C5F,KAAK4F,MAAMC,KAAI,CAAC3D,EAAMoO,KAC5D,CACHnJ,GAAIjF,EAAKiF,GACT/C,KAAMpC,EAAaqC,WAAW,IAAKrE,KAAKwB,KAAK8C,OAAQgM,EAAY,OAIzEtQ,KAAKK,IAAIqH,QAAQC,SAAkC,CAC/C1H,UAAWD,KAAKS,eAChB6D,OAAQtE,KAAKwB,KAAK8C,OAClB7C,KAAMG,EAAcG,QAAQwO,UAC5B3K,QACAuK,MAAM,IAId,IAAAnP,GACI,MAAMuC,EAAQvD,KAAKK,IAAI4D,MAAMC,OAAOlE,KAAKwB,KAAK8C,QAC9Cf,EAAMqG,KAAO,GACbrG,EAAMyE,SAASwI,WAAWxQ,KAAK4F,QCzDjC,MAAO6K,UAA6B3Q,EAKtC,WAAAC,CAAYyB,GACRyF,QALGjH,KAAQ0B,SAAW,uBAMtB1B,KAAKyB,KAAO,iBACZzB,KAAKwB,KAAOA,EACZxB,KAAKwB,KAAKoB,SAAW5C,KAAKwB,KAAKoB,UAAY,gBAC3C5C,KAAKkB,SAAW,GAEhBlB,KAAKwB,KAAKqH,UAAU/E,SAAQ0I,IACxBxM,KAAKkB,SAAS2J,KAAK,IAAI0D,EAAoB,CACvCjK,OAAQtE,KAAKwB,KAAK8C,OAClB6C,GAAIqF,EAASrF,GACbC,WAAYoF,EAASpI,KACrBsI,OAAQ,mBACT,IAGP1M,KAAKkB,SAAS2J,KAAK,IAAI8B,EAAgB,CACnCrI,OAAQtE,KAAKwB,KAAK8C,OAClB7C,KAAMzB,KAAKyB,KACX0F,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBhD,KAAMpE,KAAKwB,KAAK4C,KAChBxB,SAAU5C,KAAKwB,KAAKoB,SACpB4E,KAAK,KAIJ,IAAA1G,GACLd,KAAKqB,yBAAyBrB,KAAKkB,UAEnClB,KAAKK,IAAIqH,QAAQC,SAAsC,CACnDrD,OAAQtE,KAAKwB,KAAK8C,OAClBrE,UAAWD,KAAKS,eAChBgB,KAAMG,EAAcG,QAAQ2O,cAC5BvJ,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBxE,SAAU5C,KAAKwB,KAAKoB,SACpBwB,KAAMpE,KAAKwB,KAAK4C,KAChByE,UAAW7I,KAAKwB,KAAKqH,YAIpB,IAAA7H,GACLhB,KAAKiB,yBAAyBjB,KAAKkB,WClDrC,MAAOyP,UAAsB7Q,EAI/B,WAAAC,CAAYyB,GACRyF,QAJGjH,KAAQ0B,SAAW,gBAKtB1B,KAAKyB,KAAO,SACZzB,KAAKwB,KAAOA,EAGP,IAAAV,GACLd,KAAKK,IAAIqH,QAAQC,SAA+B,CAC5ClG,KAAMG,EAAcG,QAAQ6O,OAC5BtM,OAAQtE,KAAKwB,KAAK8C,OAClBrE,UAAWD,KAAKS,eAChB0G,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,cCZ5B,MAAOyJ,UAAsB/Q,EAM/B,WAAAC,CAAYyB,GACRyF,QANGjH,KAAQ0B,SAAW,gBAOtB1B,KAAKwB,KAAOA,EACZxB,KAAKyB,KAAOzB,KAAK8Q,iBAGb,SAAAC,GACJ,MAA8B,QAAvB/Q,KAAKwB,KAAKoB,SAGb,cAAAkO,GACJ,OAAO9Q,KAAK+Q,YAAc,cAAgB,iBAGtC,YAAAC,GACJ,MAAMhJ,EAAWhI,KAAKK,IAAI4D,MAAMC,OAAOlE,KAAKwB,KAAK8C,QAAQ0D,SAEzD,OAAIhI,KAAK+Q,YACE/I,EAAS5G,OAAS,EAGtB,EAGF,IAAAjB,CAAKC,GAGV,GAFA6G,MAAM9G,KAAKC,IAENJ,KAAKkB,SAAU,CAChB,MAAMoD,OAAEA,EAAM2M,QAAEA,GAAU,GAAUjR,KAAKwB,KAEnC0P,EAAYlR,KAAKgR,eACvBhR,KAAKoE,KAAOpC,EAAaqC,WAAW,IAAKC,EAAQ4M,GACjDlR,KAAKkB,SAAW,GAChBlB,KAAKkB,SAAS2J,KAAK,IAAI8B,EAAgB,CACnCrI,OAAQtE,KAAKwB,KAAK8C,OAClB7C,KAAMzB,KAAKyB,KACX0F,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBhD,KAAMpE,KAAKoE,QAGX6M,GACAjR,KAAKkB,SAAS2J,KAAK,IAAIiF,EAAmB,CAAExL,OAAQtE,KAAKwB,KAAK8C,WAK1E,IAAAxD,GACId,KAAKqB,yBAAyBrB,KAAKkB,UAGvC,IAAAF,GACIhB,KAAKiB,yBAAyBjB,KAAKkB,WC5DrC,MAAOiQ,UAA2BrR,EAKpC,WAAAC,CAAYyB,GACRyF,QALGjH,KAAQ0B,SAAW,qBAMtB1B,KAAKyB,KAAO,gBACZzB,KAAKwB,KAAOA,EAGhB,IAAArB,CAAKC,GACD6G,MAAM9G,KAAKC,GACX,MAAM8B,EAAO9B,EAAI6D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4F,YAE3DpH,KAAK4N,gBAAkB,IAAIjB,EAAgB,CACvCrI,OAAQtE,KAAKwB,KAAK8C,OAClB7C,KAAMzB,KAAKyB,KACX0F,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBhD,KAAMpC,EAAaqC,WAAW,KAAMnC,EAAKsG,iBAIxC,IAAA1H,GACLd,KAAKY,iBAAiBZ,KAAK4N,iBAGtB,IAAA5M,GACLhB,KAAKe,iBAAiBf,KAAK4N,kBC7B7B,MAAOwD,UAAsBtR,EAK/B,WAAAC,CAAYyB,GACRyF,QALGjH,KAAQ0B,SAAW,gBAMtB1B,KAAKyB,KAAO,UACZzB,KAAKwB,KAAOA,EAGP,IAAArB,CAAKC,GACV6G,MAAM9G,KAAKC,GAEX,MAAMkQ,EAAYtQ,KAAKK,IAAImL,SAASxL,KAAKwB,KAAK8C,QAAQsF,KAAKxI,OAAS,EAEpEpB,KAAKa,QAAU,IAAI8L,EAAgB,CAC/BrI,OAAQtE,KAAKwB,KAAK8C,OAClB7C,KAAMzB,KAAKyB,KACX0F,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBhD,KAAMpC,EAAaqC,WAAW,IAAKrE,KAAKwB,KAAK8C,OAAQgM,GACrD1N,SAAU,aAIT,IAAA9B,GACLd,KAAKY,iBAAiBZ,KAAKa,SAGtB,IAAAG,GACLhB,KAAKe,iBAAiBf,KAAKa,UCjC7B,MAAOwQ,UAAoBvR,EAK7B,WAAAC,CAAYyB,GACRyF,QALGjH,KAAQ0B,SAAW,cAMtB1B,KAAKyB,KAAO,QACZzB,KAAKwB,KAAOA,EAEZxB,KAAK4N,gBAAkB,IAAIjB,EAAgB,CACvCrI,OAAQtE,KAAKwB,KAAK8C,OAClB7C,KAAMzB,KAAKyB,KACX0F,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBhD,KAAMpE,KAAKwB,KAAK4C,KAChBxB,SAAU,WAIlB,IAAA9B,GACId,KAAKY,iBAAiBZ,KAAK4N,iBAG/B,IAAA5M,GACIhB,KAAKe,iBAAiBf,KAAK4N,kBCrB7B,MAAO0D,UAA6BxR,EAMtC,WAAAC,CAAYyB,GACRyF,QANGjH,KAAQ0B,SAAW,uBAElB1B,KAAQuR,SAAqD,GAKjEvR,KAAKwB,KAAOA,EACZxB,KAAKwB,KAAKoB,SAAW5C,KAAKwB,KAAKoB,UAAY,gBAC3C5C,KAAKyB,KAA8B,kBAAvBzB,KAAKwB,KAAKoB,SAA+B,iBAAmB,cACxE5C,KAAKkB,SAAW,GAKpB,IAAAf,CAAKC,GACD6G,MAAM9G,KAAKC,GAEXJ,KAAKuR,SAAWvR,KAAKwB,KAAK+P,SAAS1L,KAAI2L,IACnC,MAAMtP,EAAOlC,KAAKK,IAAI4D,MAAMiD,YAAYsK,EAAQrK,GAAIqK,EAAQpN,MAS5D,OAPApE,KAAKkB,SAAS2J,KAAK,IAAI0D,EAAoB,CACvCpH,GAAIqK,EAAQrK,GACZC,WAAYoK,EAAQpN,KACpBE,OAAQtE,KAAKwB,KAAK8C,OAClBoI,OAAQ,oBAGL,CACHvF,GAAIjF,EAAKiF,GACT/C,KAAMoN,EAAQpN,KACdmE,MAAOrG,EAAKsG,cACf,IAGLxI,KAAKkB,SAAS2J,KAAK,IAAI8B,EAAgB,CACnCrI,OAAQtE,KAAKwB,KAAK8C,OAClB7C,KAAMzB,KAAKyB,KACX0F,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBhD,KAAMpE,KAAKwB,KAAK4C,KAChBxB,SAAU5C,KAAKwB,KAAKoB,SACpB4E,KAAK,KAKb,IAAA1G,GACId,KAAKqB,yBAAyBrB,KAAKkB,UAEnClB,KAAKK,IAAIqH,QAAQC,SAAsC,CACnDrD,OAAQtE,KAAKwB,KAAK8C,OAClBrE,UAAWD,KAAKS,eAChBgB,KAAoB,mBAAdzB,KAAKyB,KAA4BG,EAAcG,QAAQ0P,cAAgB7P,EAAcG,QAAQ2P,WACnGvK,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBhD,KAAMpE,KAAKwB,KAAK4C,KAChBmN,SAAUvR,KAAKuR,SACf3O,SAAU5C,KAAKwB,KAAKoB,WAI5B,IAAA5B,GACIhB,KAAKiB,yBAAyBjB,KAAKkB,WCjErC,MAAOyQ,UAAiC7R,EAM1C,WAAAC,CAAYyB,GACRyF,QANGjH,KAAQ0B,SAAW,2BAOtB1B,KAAKyB,KAAO,sBACZzB,KAAKwB,KAAOA,EAGP,IAAAV,GACL,MAAMoB,EAAOlC,KAAKK,IAAI4D,MAAM2N,gBAAgB5R,KAAKwB,KAAK4C,MACtDpE,KAAK6R,sBAAwB7R,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4F,YAE5EpH,KAAK6R,sBAAsBhJ,UAAUzH,OAAS,IAC9CpB,KAAK8R,wBAA0B9R,KAAKY,iBAAiB,IAAIwL,EAAwB,CAC7EjF,GAAInH,KAAK6R,sBAAsB1K,GAC/BC,WAAYpH,KAAKwB,KAAK4F,WACtB9C,OAAQtE,KAAKwB,KAAK8C,OAClBF,KAAM,SAIdpE,KAAKK,IAAI4D,MAAMqD,QAAQ,KAAMtH,KAAKwB,KAAK4F,YACvClF,EAAK2G,UAAUgC,KAAK7K,KAAK6R,uBAEzBtK,QAAQC,IAAI,uBAAwBxH,KAAK6R,sBAAsBzL,KAAMpG,KAAKwB,KAAK4F,YAE/E,MAAMmF,EAAczE,EAASuB,eAAerJ,KAAKwB,KAAK4C,MAEtDpE,KAAKK,IAAIqH,QAAQC,SAAkC,CAC/CrD,OAAQtE,KAAKwB,KAAK8C,OAClBrE,UAAWD,KAAKS,eAChBgB,KAAMG,EAAcG,QAAQgQ,kBAC5B5K,GAAInH,KAAKwB,KAAK2F,GACd6K,WAAYhS,KAAK6R,sBAAsB1K,GACvCC,WAAYpH,KAAKwB,KAAK4F,WACtBmF,YAAaA,IAIZ,IAAAvL,GACL,MAAMkB,EAAOlC,KAAKK,IAAI4D,MAAM2N,gBAAgB5R,KAAKwB,KAAK4C,MACtDpE,KAAKK,IAAI4D,MAAMqD,QAAQtH,KAAK6R,sBAAuB7R,KAAKwB,KAAK4F,YAE7D,MAAM6K,EAAgB/P,EAAK2G,UAAUqJ,QAAQlS,KAAK6R,wBAC5B,IAAlBI,GACA/P,EAAK2G,UAAUuF,OAAO6D,EAAe,GAGrCjS,KAAK8R,yBAAyB9R,KAAKe,iBAAiBf,KAAK8R,0BCpD/D,MAAOK,UAAiCrS,EAK1C,WAAAC,CAAYyB,GACRyF,QALGjH,KAAQ0B,SAAW,2BAMtB1B,KAAKyB,KAAO,sBACZzB,KAAKwB,KAAOA,EAGP,IAAAV,GACL,MAAMoB,EAAOlC,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4F,YAChEpH,KAAK6R,sBAAwB3P,EAAK2G,UAAU7I,KAAKwB,KAAKyQ,eACtD/P,EAAK2G,UAAUuF,OAAOpO,KAAKwB,KAAKyQ,cAAe,GAE/CjS,KAAKK,IAAI4D,MAAMqD,QAAQtH,KAAK6R,sBAAuB7P,EAAaqC,WAAW,KAAMrE,KAAK6R,sBAAsBrJ,gBAE5G,MAAM+D,EAAczE,EAASuB,eAAerJ,KAAKwB,KAAK4F,YAEtDG,QAAQC,IAAI,WAAY+E,EAAa,MAAOvK,EAAaqC,WAAW,KAAMrE,KAAK6R,sBAAsBrJ,gBAErGxI,KAAKK,IAAIqH,QAAQC,SAAkC,CAC/CrD,OAAQtE,KAAKwB,KAAK8C,OAClBrE,UAAWD,KAAKS,eAChBgB,KAAMG,EAAcG,QAAQqQ,kBAC5BjL,GAAIjF,EAAKiF,GACT8K,cAAejS,KAAKwB,KAAKyQ,cACzBD,WAAYhS,KAAK6R,sBAAsB1K,GACvCoB,MAAOvI,KAAK6R,sBAAsBrJ,cAClC+D,YAAaA,IAIZ,IAAAvL,GACQhB,KAAKK,IAAI4D,MAAM2N,gBAAgB5R,KAAKwB,KAAK4F,YACjDyB,UAAUuF,OAAOpO,KAAKwB,KAAKyQ,cAAe,EAAGjS,KAAK6R,uBACvDtK,QAAQC,IAAI,iBAAkBxF,EAAaqC,WAAW,KAAMrE,KAAK6R,sBAAsBrJ,gBACvFxI,KAAKK,IAAI4D,MAAMqD,QAAQ,KAAMtF,EAAaqC,WAAW,KAAMrE,KAAK6R,sBAAsBrJ,iBCrCxF,MAAO6J,UAAgCvS,EAQzC,WAAAC,CAAYyB,GACRyF,QARGjH,KAAQ0B,SAAW,0BAIlB1B,KAAqBsS,sBAAwC,GAC7DtS,KAAauS,cAAW,GAI5BvS,KAAKyB,KAAO,qBACZzB,KAAKwB,KAAOA,EACZxB,KAAKwB,KAAKoB,SAAW5C,KAAKwB,KAAKoB,UAAY,gBAC3C5C,KAAKkB,SAAW,GAChBlB,KAAKuM,YAAczE,EAASuB,eAAerJ,KAAKwB,KAAK4C,MACrDmD,QAAQC,IAAI,kBAGhB,IAAArH,CAAKC,GACD6G,MAAM9G,KAAKC,GAEXJ,KAAKuS,cAAgB,GACrBvS,KAAKsS,sBAAwB,GAE7BtS,KAAKwB,KAAKqH,UAAU/E,SAAQ0I,IACxB,MAAMtK,EAAOlC,KAAKK,IAAI4D,MAAMiD,YAAYsF,EAASrF,GAAIqF,EAASpI,MACxDmO,EAAgB,IAAIrQ,EAAK2G,WAE/B3G,EAAK2G,UAAY,GACjB7I,KAAKuS,cAAc1H,KAAK3I,GACxBqQ,EAAczO,SAAQ0O,GAAaxS,KAAKuS,cAAc1H,KAAK2H,KAC3DxS,KAAKsS,sBAAsBzH,KAAK,CAAE3I,OAAM2G,UAAW0J,IAEnDvS,KAAKkB,SAAS2J,KAAK,IAAI4H,EAAiB,CACpCnO,OAAQtE,KAAKwB,KAAK8C,OAClBiI,YAAavM,KAAKuM,YAClBpF,GAAIqF,EAASrF,GACb/C,KAAMoI,EAASpI,OAChB,IAGPpE,KAAKkB,SAAS2J,KAAK,IAAI8B,EAAgB,CACnCrI,OAAQtE,KAAKwB,KAAK8C,OAClB7C,KAAMzB,KAAKyB,KACX0F,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBhD,KAAMpE,KAAKwB,KAAK4C,KAChBxB,SAAU5C,KAAKwB,KAAKoB,SACpB4E,KAAK,KAIJ,IAAA1G,GACL,MAAMoB,EAAOlC,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4F,YAEhEG,QAAQC,IAAI,iBAAkBxH,KAAKuS,eACnCrQ,EAAK2G,UAAY7I,KAAKuS,cAEtBvS,KAAKqB,yBAAyBrB,KAAKkB,UAEnClB,KAAKK,IAAIqH,QAAQC,SAAyC,CACtDrD,OAAQtE,KAAKwB,KAAK8C,OAClBrE,UAAWD,KAAKS,eAChBgB,KAAMG,EAAcG,QAAQ2Q,iBAC5BvL,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBhD,KAAMpE,KAAKwB,KAAK4C,KAChBxB,SAAU5C,KAAKwB,KAAKoB,SACpBiG,UAAW7I,KAAKwB,KAAKqH,YAIpB,IAAA7H,GACQhB,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4C,MAC3DyE,UAAY,GACjB7I,KAAKiB,yBAAyBjB,KAAKkB,UAEnClB,KAAKsS,sBAAsBxO,SAAQtC,IAC/BA,EAAKU,KAAK2G,UAAYrH,EAAKqH,SAAS,WAYhD,cAA+B/I,EAI3B,WAAAC,CAAYyB,GACRyF,QACAjH,KAAKwB,KAAOA,EAGhB,IAAAV,GACId,KAAKkC,KAAOlC,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4C,MAC/DpE,KAAKK,IAAI4D,MAAMqD,QAAQ,KAAMtH,KAAKwB,KAAK4C,MAEvCpE,KAAKK,IAAIqH,QAAQC,SAAmC,CAChDrD,OAAQtE,KAAKwB,KAAK8C,OAClBrE,UAAWD,KAAKS,eAChBgB,KAAMG,EAAcG,QAAQ4Q,WAC5BxL,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4C,KACtBmI,YAAavM,KAAKwB,KAAK+K,cAI/B,IAAAvL,GACIhB,KAAKK,IAAI4D,MAAMqD,QAAQtH,KAAKkC,KAAMlC,KAAKwB,KAAK4C,QCjH9C,MAAOwO,UAAyB9S,EAMlC,WAAAC,CAAYyB,GACRyF,QANGjH,KAAQ0B,SAAW,mBAOtB1B,KAAKyB,KAAO,aACZzB,KAAKwB,KAAOA,EACZxB,KAAKwB,KAAKoB,SAAW5C,KAAKwB,KAAKoB,UAAY,gBAC3C5C,KAAKkB,SAAW,GAChBlB,KAAKuM,YAAczE,EAASuB,eAAerJ,KAAKwB,KAAK4C,MACrDmD,QAAQC,IAAI,kBAGhB,IAAArH,CAAKC,GACD6G,MAAM9G,KAAKC,GAEXJ,KAAKwB,KAAKqH,UAAU/E,SAAQ0I,IACxBxM,KAAKkB,SAAS2J,KAAK,IAAIuB,EAAwB,CAC3C9H,OAAQtE,KAAKwB,KAAK8C,OAClB6C,GAAIqF,EAASrF,GACbC,WAAYoF,EAASpI,KACrBA,KAAM,OACP,IAGPpE,KAAKwB,KAAKqH,UAAU/E,SAAQ0I,IACxBxM,KAAKkB,SAAS2J,KAAK,IAAI4H,EAAiB,CACpCnO,OAAQtE,KAAKwB,KAAK8C,OAClBiI,YAAavM,KAAKuM,YAClBpF,GAAIqF,EAASrF,GACb/C,KAAMoI,EAASpI,OAChB,IAGPpE,KAAKkB,SAAS2J,KAAK,IAAI8B,EAAgB,CACnCrI,OAAQtE,KAAKwB,KAAK8C,OAClB7C,KAAMzB,KAAKyB,KACX0F,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBhD,KAAMpE,KAAKwB,KAAK4C,KAChBxB,SAAU5C,KAAKwB,KAAKoB,SACpB4E,KAAK,KAIJ,IAAA1G,GACQd,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4F,YAE3DyB,UAAY7I,KAAKwB,KAAKqH,UAAUhD,KAAI2G,GAChBxM,KAAKK,IAAI4D,MAAMiD,YAAYsF,EAASrF,GAAIqF,EAASpI,QAI1EpE,KAAKqB,yBAAyBrB,KAAKkB,UAEnClB,KAAKK,IAAIqH,QAAQC,SAAkC,CAC/CrD,OAAQtE,KAAKwB,KAAK8C,OAClBrE,UAAWD,KAAKS,eAChBgB,KAAMG,EAAcG,QAAQ8Q,UAC5B1L,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4F,WACtBhD,KAAMpE,KAAKwB,KAAK4C,KAChBxB,SAAU5C,KAAKwB,KAAKoB,SACpBiG,UAAW7I,KAAKwB,KAAKqH,YAIpB,IAAA7H,GACQhB,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4C,MAC3DyE,UAAY,GACjB7I,KAAKiB,yBAAyBjB,KAAKkB,WAW3C,MAAMuR,UAAyB3S,EAI3B,WAAAC,CAAYyB,GACRyF,QACAjH,KAAKwB,KAAOA,EAGhB,IAAAV,GACId,KAAKkC,KAAOlC,KAAKK,IAAI4D,MAAMiD,YAAYlH,KAAKwB,KAAK2F,GAAInH,KAAKwB,KAAK4C,MAC/DpE,KAAKK,IAAI4D,MAAMqD,QAAQ,KAAMtH,KAAKwB,KAAK4C,MAEvCpE,KAAKK,IAAIqH,QAAQC,SAAmC,CAChDrD,OAAQtE,KAAKwB,KAAK8C,OAClBrE,UAAWD,KAAKS,eAChBgB,KAAMG,EAAcG,QAAQ4Q,WAC5BxL,GAAInH,KAAKwB,KAAK2F,GACdC,WAAYpH,KAAKwB,KAAK4C,KACtBmI,YAAavM,KAAKwB,KAAK+K,cAI/B,IAAAvL,GACIhB,KAAKK,IAAI4D,MAAMqD,QAAQtH,KAAKkC,KAAMlC,KAAKwB,KAAK4C,OCnD7C,MAAM0O,EAA4B,CACrCrD,sBACAI,oBACAH,iBACAnB,sBACApB,gBACAU,sBACAyB,sBACAtI,sBACAiJ,uBACAqB,uBACAlC,oBACAP,sBACA4B,uBACAmC,mBACAP,0BACAV,2BACAQ,2BACAtB,gBACAf,qBACAnC,qBACAU,gBACA8C,qBACAC,gBACA5C,oBACAf,4BACAJ,0BACAsB,cACA0C,cACA1E,kBACAgE,iBAGSoC,EAAwB,CACjCtD,oBAAuBA,EACvBI,kBAAqBA,EACrBH,eAAkBA,EAClBnB,oBAAuBA,EACvBpB,cAAiBA,EACjBU,oBAAuBA,EACvByB,oBAAuBA,EACvBtI,oBAAuBA,EACvBiJ,qBAAwBA,EACxBqB,qBAAwBA,EACxBlC,kBAAqBA,EACrBP,oBAAuBA,EACvB4B,qBAAwBA,EACxBmC,iBAAoBA,EACpBP,wBAA2BA,EAC3BV,yBAA4BA,EAC5BQ,yBAA4BA,EAC5BtB,cAAiBA,EACjBf,mBAAsBA,EACtBnC,mBAAsBA,EACtBU,cAAiBA,EACjB8C,mBAAsBA,EACtBC,cAAiBA,EACjB5C,kBAAqBA,EACrBf,0BAA6BA,EAC7BJ,wBAA2BA,EAC3BsB,YAAeA,EACf0C,YAAeA,EACf1E,gBAAmBA,EACnBuD,iBAAoBA,EACpB8C,kBAAqBrC,GC/HnB,MAAOsC,UAAoBnT,EAC7B,WAAAC,CAAY+L,GACR7E,QAEA,MAAMiM,GD8HqCC,EC9HArH,EAAIrK,KD+H5CsR,EAAiBI,IADtB,IAA6CA,EC5H3C,IAAKD,EAAc,MAAM,IAAI5K,MAAM,YAAYwD,EAAIrK,sBAInD,OAFgB,IAAKyR,EAAqBpH,EAAItK,aCXzC4R,EAGT,WAAArT,GACIC,KAAKqT,OAAS,IAAItK,IAGtB,EAAAuK,CAAsBC,EAAUC,GACvBxT,KAAKqT,OAAOrK,IAAIuK,IACjBvT,KAAKqT,OAAOpK,IAAIsK,EAAO,IAE3BvT,KAAKqT,OAAOI,IAAIF,GAAQ1I,KAAK2I,GAGjC,QAAA7L,CAA4B4L,KAAa7O,GACrC,MAAMgP,EAAY1T,KAAKqT,OAAOI,IAAIF,GAC9BG,GACAA,EAAU5P,SAAQ0P,IACdA,KAAY9O,EAAK,IAK7B,GAAAiP,CAAuBJ,EAAUC,GAC7B,MAAME,EAAY1T,KAAKqT,OAAOI,IAAIF,GAC9BG,GACA1T,KAAKqT,OAAOpK,IACRsK,EACAG,EAAUvI,QAAOyI,GAAKA,IAAMJ,KAKxC,KAAAK,CAAyBN,GACjBvT,KAAKqT,OAAOrK,IAAIuK,IAChBvT,KAAKqT,OAAOS,OAAOP,GAI3B,QAAAQ,GACI/T,KAAKqT,OAAOQ,eC/BPG,EAKT,WAAAjU,GAFOC,KAAOiU,SAAY,EAGtBjU,KAAKkU,KAAO,GACZlU,KAAKqT,OAAS,IAAID,EAGtB,QAAAzL,CAA0CH,GACtCxH,KAAKkU,KAAKrJ,KAAKrD,GAEXxH,KAAKiU,UAETjU,KAAKqT,OAAO1L,SAAS,UAAWH,GAChCxH,KAAKmU,iBAGT,IAAAC,GACI,OAAwB,GAApBpU,KAAKkU,KAAK9S,OAAoB,KAC3BpB,KAAKkU,KAAKlU,KAAKkU,KAAK9S,OAAS,GAGxC,WAAAiT,GACI,OAAwB,GAApBrU,KAAKkU,KAAK9S,QAAsB,EAC7BpB,KAAKkU,KAAKlU,KAAKkU,KAAK9S,OAAS,GAAGnB,UAG3C,GAAA8N,GACI,OAAyB,IAArB/N,KAAKkU,KAAK9S,OAAqB,KAC5BpB,KAAKkU,KAAKnG,MAGrB,aAAAuG,CAAczT,EAAkB6D,GAC5B,MAAMwH,EAAelM,KAAKkU,KAAKhH,WAAUpB,GAAOA,EAAI7L,YAAcY,EAAQZ,aAErD,IAAjBiM,GACAlM,KAAKkU,KAAK9F,OAAOlC,EAAclM,KAAKkU,KAAK9S,OAAS8K,IAGpC,KAAdxH,aAAI/D,EAAJ+D,EAAM8C,MACNxH,KAAKqT,OAAO1L,SAAS,cAAe3H,KAAKkU,MAIjD,aAAAC,GACInU,KAAKqT,OAAO1L,SAAS,cAAe3H,KAAKkU,aCpDpCK,EAIT,WAAAxU,CAAYwJ,GACRvJ,KAAKkE,OAAS4D,EAASwB,wBAAwBC,GAC/CvJ,KAAKwU,YAAc1M,EAASgB,eAAe9I,KAAKkE,QAGpD,WAAAgD,CAAYC,EAAY/C,GACpB,MAAMQ,EAAcR,EAAKhC,SAAS,MAAQ,EAAI,EAE9C,GAAa,OAATgC,GAA0B,QAATA,EAAgB,CACjC,MAAMlC,EAAOlC,KAAKkE,OAAOU,GAAauE,UAAUqB,MAAK1E,GAAKA,EAAEqB,KAAOA,IAEnE,IAAKjF,EACD,MAAM,IAAIoG,MAAM,SAASnB,oBAAqB/C,MAGlD,OAAOlC,EAGX,MAAMA,EAAOlC,KAAK4R,gBAAgBxN,GAElC,GAAIlC,GAAQA,EAAKiF,KAAOA,EAAI,OAAOjF,EAEnC,MAAM,IAAIoG,MAAM,SAASnB,oBAAqB/C,MAGlD,eAAAwN,CAAgBxN,GACZ,MACMQ,EADW5C,EAAayC,YAAYL,GACbE,OAE7B,GAAIF,EAAKnB,WAAW,OAASmB,EAAKnB,WAAW,OAAQ,CACjD,MAAMuB,EAAYM,OAAOV,EAAKO,MAAM,KAAKoJ,OAAS,EAElD,OADa/N,KAAKkE,OAAOU,GAAagF,KAAKpF,GAExC,GAAIJ,EAAKnB,WAAW,OAASmB,EAAKnB,WAAW,OAAQ,CACxD,MAAMuB,EAAYM,OAAOV,EAAKO,MAAM,KAAKoJ,OAAS,EAElD,OADa/N,KAAKkE,OAAOU,GAAapB,YAAYgB,GAE/C,GAAIJ,EAAKnB,WAAW,OAASmB,EAAKnB,WAAW,OAAQ,CACxD,MAAMuB,EAAYM,OAAOV,EAAKO,MAAM,KAAKoJ,OAAS,EAElD,OADa/N,KAAKkE,OAAOU,GAAasE,cAAc1E,GAEjD,GAAIJ,EAAKnB,WAAW,QAAUmB,EAAKnB,WAAW,QAAS,CAC1D,MAAMuB,EAAYM,OAAOV,EAAKO,MAAM,KAAKoJ,OAAS,EAElD,OADa/N,KAAKkE,OAAOU,GAAauE,UAAU3E,GAE7C,GAAIJ,EAAKnB,WAAW,OAASmB,EAAKnB,WAAW,OAAQ,CACxD,MAAMuB,EAAYM,OAAOV,EAAKO,MAAM,KAAKoJ,OAAS,EAElD,OADa/N,KAAKkE,OAAOU,GAAawE,aAAa5E,GAEhD,GAAIJ,EAAKnB,WAAW,OAASmB,EAAKnB,WAAW,OAAQ,CACxD,MAAMuB,EAAYM,OAAOV,EAAKO,MAAM,KAAKoJ,OAAS,EAElD,OADa/N,KAAKkE,OAAOU,GAAaoD,SAASxD,GAE5C,GAAIJ,EAAKnB,WAAW,QAAUmB,EAAKnB,WAAW,QAAS,CAC1D,MAAMuB,EAAYM,OAAOV,EAAKO,MAAM,KAAKoJ,OAAS,EAElD,OADa/N,KAAKkE,OAAOU,GAAawD,UAAU5D,GAE7C,GAAIJ,EAAKnB,WAAW,SAAWmB,EAAKnB,WAAW,SAAU,CAC5D,MAAMuB,EAAYM,OAAOV,EAAKO,MAAM,KAAKoJ,OAAS,EAElD,OADa/N,KAAKkE,OAAOU,GAAalB,iBAAiBc,GAEpD,GAAIJ,EAAKnB,WAAW,MAAQmB,EAAKnB,WAAW,MAAO,CAEtD,OADajD,KAAKkE,OAAOU,GAAamF,UAI1C,OAAO,KAGX,YAAA0K,CAAaC,EAAgBtN,EAAuBhD,GAChD,MAAMlC,EAAOlC,KAAKkH,YAAYwN,EAAQtN,GACtCpH,KAAKgN,SAAS9K,EAAMkF,EAAYhD,GAGpC,QAAA4I,CAAS9K,EAAYkF,EAAuBhD,GACxCpE,KAAKqH,WAAWD,GAChBpH,KAAKsH,QAAQpF,EAAMkC,GAGvB,OAAAkD,CAAQpF,EAAmBkC,GACvB,MACMQ,EADW5C,EAAayC,YAAYL,GACbE,OAE7B,GAAIF,EAAKnB,WAAW,OAASmB,EAAKnB,WAAW,QAAmB,MAATmB,GAAyB,OAATA,EAAe,CAClF,MAAMkM,EAAYlM,EAAKhC,SAAS,KAAO0C,OAAOV,EAAKO,MAAM,KAAKoJ,OAAS,GAAM,EACvEnE,EAAO5J,KAAKkE,OAAOU,GAAagF,MAEnB,GAAf0G,GAAmBpO,EACnB0H,EAAKiB,KAAK3I,GACHA,EACHoO,GAAa1G,EAAKxI,OAClBwI,EAAKiB,KAAK3I,GAEV0H,EAAKwE,OAAOkC,EAAW,EAAGpO,GAG9B0H,EAAKwE,OAAOkC,EAAW,QAExB,GAAIlM,EAAKnB,WAAW,OAASmB,EAAKnB,WAAW,OAAQ,CACxD,MAAMuB,EAAYM,OAAOV,EAAKO,MAAM,KAAKoJ,OAAS,EAClD/N,KAAKkE,OAAOU,GAAapB,YAAYgB,GAAatC,OAE/C,GAAIkC,EAAKnB,WAAW,OAASmB,EAAKnB,WAAW,OAAQ,CACxD,MAAMuB,EAAYM,OAAOV,EAAKO,MAAM,KAAKoJ,OAAS,EAClD/N,KAAKkE,OAAOU,GAAasE,cAAc1E,GAAatC,OACjD,GAAIkC,EAAKnB,WAAW,SAAWmB,EAAKnB,WAAW,SAAU,CAC5D,MAAMuB,EAAYM,OAAOV,EAAKO,MAAM,KAAKoJ,OAAS,EAClD/N,KAAKkE,OAAOU,GAAalB,iBAAiBc,GAAatC,OAEtD,GAAIkC,EAAKnB,WAAW,OAASmB,EAAKnB,WAAW,OAC9C,IAA0B,IAAtBmB,EAAK8N,QAAQ,KAAa,CAC1B,MAAM1N,EAAYM,OAAOV,EAAKO,MAAM,KAAKoJ,OAAS,EAC7C7L,EAGDlC,KAAKkE,OAAOU,GAAawD,UAAUgG,OAAO5J,EAAW,EAAGtC,GAFxDlC,KAAKkE,OAAOU,GAAawD,UAAUgG,OAAO5J,EAAW,OAItD,KAAItC,EAWP,MAAM,IAAIoG,MAAM,gCAXH,CACb,MAAMqM,EAAazS,EAAKgG,gBAAkBlG,EAAaS,eAAeP,GAChEkG,EAAYpI,KAAKkE,OAAOU,GAAawD,UAEvCuM,EACAvM,EAAUoI,QAAQtO,IAElBkG,EAAUyC,KAAK3I,GACfF,EAAagE,UAAUoC,UAK5B,GAAIhE,EAAKnB,WAAW,OAASmB,EAAKnB,WAAW,OAAQ,CACxD,MAAMuB,EAAYM,OAAOV,EAAKO,MAAM,KAAKoJ,OAAS,EAElDxG,QAAQC,IAAI,qBAAsBpD,GAE7BlC,EAGDlC,KAAKkE,OAAOU,GAAaoD,SAASoG,OAAO5J,EAAW,EAAGtC,GAFvDlC,KAAKkE,OAAOU,GAAaoD,SAASoG,OAAO5J,EAAW,QAIrD,GAAa,OAATJ,GAA0B,QAATA,GAAkBA,EAAKnB,WAAW,QAAUmB,EAAKnB,WAAW,QAAS,CAC7F,MAAM2R,EAAUxQ,EAAKhC,SAAS,KAAO0C,OAAOV,EAAKO,MAAM,KAAKoJ,OAAS,GAAM,EACrE8G,EAAK7U,KAAKkE,OAAOU,GAAauE,UAChCjH,GACgB,IAAZ0S,EACAC,EAAGrE,QAAQtO,GAEX2S,EAAGzG,OAAOwG,EAAS,EAAG1S,IAGX,GAAX0S,EACIC,EAAGzT,OAAS,GACZyT,EAAGzG,OAAO,EAAG,GAGjByG,EAAGzG,OAAOwG,EAAS,QAGxB,GAAa,MAATxQ,GAAyB,OAATA,GAAiBA,EAAKnB,WAAW,OAASmB,EAAKnB,WAAW,OAAQ,CACzF,MAAM2R,EAAUxQ,EAAKhC,SAAS,KAAO0C,OAAOV,EAAKO,MAAM,KAAKoJ,OAAS,GAAM,EACrE+G,EAAa9U,KAAKkE,OAAOU,GAAawE,aAExClH,GACgB,IAAZ0S,EACAE,EAAWtE,QAAQtO,GAEnB4S,EAAW1G,OAAOwG,EAAS,EAAG1S,IAGnB,GAAX0S,EACAE,EAAW/G,MAEX+G,EAAW1G,OAAOwG,EAAS,QAG5BxQ,EAAKnB,WAAW,MAAQmB,EAAKnB,WAAW,SAC/CjD,KAAKkE,OAAOU,GAAamF,UAAY7H,GAI7C,UAAAmF,CAAWjD,GACP,MAAMlC,EAAOlC,KAAK4R,gBAAgBxN,GAGlC,OAFApE,KAAKsH,QAAQ,KAAMlD,GAEZlC,EAGX,WAAA2J,CAAY6I,GACR,OAAO1U,KAAKwU,YAAYf,IAAIiB,IAAW,KAG3C,WAAAK,CAAYzQ,GACR,MAAM0Q,EAAOhV,KAAKkE,OAAOI,GAAQ0D,SACjC,GAAoB,IAAhBgN,EAAK5T,OAET,IAAK,IAAID,EAAI6T,EAAK5T,OAAS,EAAGD,EAAI,EAAGA,IAAK,CACtC,MAAMuI,EAAYjD,KAAKC,MAAMD,KAAKE,UAAYxF,EAAI,KACjD6T,EAAK7T,GAAI6T,EAAKtL,IAAc,CAACsL,EAAKtL,GAAYsL,EAAK7T,KAI5D,sBAAAgD,CAAuBC,GACnB,OAAO0D,EAAS3D,uBAAuBC,GAG3C,iBAAA6Q,CAAkBC,GACd,MAAMC,EAAsB,GAI5B,IAAK,MAAMpL,KAAamL,EAAY,CAChC,MAAM5Q,EAAStE,KAAKmE,uBAAuB4F,GACrCxG,EAAQvD,KAAKkE,OAAOI,GAC1B,GAAkB,MAAdyF,EACAxG,EAAMC,YAAYM,SAAQ,CAACtC,EAAMgF,KAC7B,MAAMpC,EAAO,IAAe,IAAXE,EAAe,GAAK,OAAOkC,EAAQ,IAC/ChF,GAAM2T,EAAOtK,KAAKzG,EAAkB,SAE1C,GAAkB,MAAd2F,EACPxG,EAAM2F,cAAcpF,SAAQ,CAACtC,EAAMgF,KAC/B,MAAMpC,EAAO,IAAe,IAAXE,EAAe,GAAK,OAAOkC,EAAQ,IAC/ChF,GAAM2T,EAAOtK,KAAKzG,EAAkB,SAE1C,GAAkB,QAAd2F,EACP,IAAK,IAAI5I,EAAI,EAAGA,EAAI,IAAKA,EAAG,CACxB,MACMiD,EAAO,OAAOjD,EAAI,IADXoC,EAAM6E,UAAUjH,IAAMoC,EAAM6E,UAAUjH,IAExCgU,EAAOtK,KAAKzG,OAEN,MAAd2F,GACHxG,EAAMwG,WAAWoL,EAAOtK,KAAK,KAIzC,OAAOsK,SC9OFC,EACT,uBAAOC,CAAiBjV,WACpB,MAAM4J,EAAU5J,EAAImJ,MAAMS,QAAQnE,KAAI,CAACyP,EAAY1Q,KAC/C,MAAMrB,EAAQnD,EAAIoL,SAAS5G,GAC3B,MAAO,CACHwB,KAAMkP,EAAWlP,KACjB4B,SAAUzE,EAAM/B,KAAKqI,gBACrBzB,UAAW7E,EAAM/B,KAAKsI,iBACzB,IAGC5I,EAAWd,EAAIc,SAAS2E,KAAIiG,GAAOA,EAAIvK,WACvCgU,EAAgC,GAChCC,EAAoC,IAErB,QAAjB9U,EAAAN,EAAImJ,MAAME,eAAO9I,IAAAD,OAAAC,EAAAD,EAAEwJ,aACnB9J,EAAImJ,MAAME,QAAQS,WAAWpG,SAAQ2R,GAAKD,EAAa3K,KAAK4K,KAGhE,IAAK,IAAI7Q,EAAc,EAAGA,EAAcxE,EAAI6D,MAAMC,OAAO9C,SAAUwD,EAAa,CAC5E,MAAMrB,EAAQnD,EAAIoL,SAAS5G,GAE3B2C,QAAQC,IAAI,WAAYjE,GAExB,IAAK,IAAIpC,EAAI,EAAGA,EAAIoC,EAAMqG,KAAKxI,SAAUD,EAAG,CACxC,MAAMe,EAAOqB,EAAMqG,KAAKzI,GAClBiD,EAAOpC,EAAaqC,WAAW,IAAKO,EAAazD,EAAI,GAC3DoU,EAAS1K,KAAK7K,KAAK0V,mBAAmBxT,EAAMkC,IAGhD,IAAK,IAAIjD,EAAI,EAAGA,EAAIoC,EAAMC,YAAYpC,SAAUD,EAC5C,GAAIoC,EAAMC,YAAYrC,GAAI,CACtB,MAAMe,EAAOqB,EAAMC,YAAYrC,GACzBiD,EAAOpC,EAAaqC,WAAW,IAAKO,EAAazD,EAAI,GAC3DoU,EAAS1K,KAAK7K,KAAK0V,mBAAmBxT,EAAMkC,IAIpD,IAAK,IAAIjD,EAAI,EAAGA,EAAIoC,EAAM2F,cAAc9H,SAAUD,EAC9C,GAAIoC,EAAM2F,cAAc/H,GAAI,CACxB,MAAMe,EAAOqB,EAAM2F,cAAc/H,GAC3BiD,EAAOpC,EAAaqC,WAAW,IAAKO,EAAazD,EAAI,GAC3DoU,EAAS1K,KAAK,CAAE1D,GAAIjF,EAAKiF,GAAI/C,SAIrC,IAAK,IAAIjD,EAAI,EAAGA,EAAIoC,EAAMG,iBAAiBtC,SAAUD,EACjD,GAAIoC,EAAMG,iBAAiBvC,KAA+B,QAAzBwK,EAAApI,EAAMG,iBAAiBvC,UAAER,IAAAgL,OAAAhL,EAAAgL,EAAEpD,SAAU3D,EAAa,CAC/E,MAAM1C,EAAOqB,EAAMG,iBAAiBvC,GAC9BiD,EAAOpC,EAAaqC,WAAW,MAAOO,EAAazD,EAAI,GAC7DoU,EAAS1K,KAAK7K,KAAK0V,mBAAmBxT,EAAMkC,IAIpD,IAAK,IAAIjD,EAAI,EAAGA,EAAIoC,EAAM4F,UAAU/H,SAAUD,EAAG,CAC7C,MAAMe,EAAOqB,EAAM4F,UAAUhI,GACvBiD,EAAOpC,EAAaqC,WAAW,KAAMO,GAC3C2Q,EAAS1K,KAAK,CAAE1D,GAAIjF,EAAKiF,GAAI/C,SAGjC,IAAK,IAAIjD,EAAI,EAAGA,EAAIoC,EAAM6F,aAAahI,SAAUD,EAAG,CAChD,MAAMe,EAAOqB,EAAM6F,aAAajI,GAC1BiD,EAAOpC,EAAaqC,WAAW,IAAKO,GACpCuQ,EAAc,CAAEhO,GAAIjF,EAAKiF,GAAI/C,QAE/BpC,EAAaa,WAAWX,KACxBiT,EAAOvS,SAAW,YAGtB2S,EAAS1K,KAAKsK,IAKtB,MAAO,CACHnL,UACA9I,WACAsU,eACAD,YAIA,yBAAOG,CAAmBxT,EAAYkC,GAC1C,MAAM+Q,EAAc,CAChBhO,GAAIjF,EAAKiF,GACT/C,QAmBJ,OAhBIlC,EAAKwG,MAAQxG,EAAKuG,aAClB0M,EAAOzM,IAAMxG,EAAKuG,YAGlBvG,EAAK0G,MAAQ1G,EAAKyG,aAClBwM,EAAOvM,IAAM1G,EAAKyG,YAGA,kBAAlBzG,EAAKU,WACLuS,EAAOvS,SAAWV,EAAKU,UAGvBV,EAAK2G,UAAUzH,OAAS,IACxB+T,EAAOtM,UAAY3G,EAAK2G,UAAUhD,KAAIqJ,IAAiB,CAAE/H,GAAI+H,EAAa/H,QAGvEgO,SClGFQ,EAcT,WAAA5V,CAAYwJ,SACRvJ,KAAKuJ,MAAQA,EACbvJ,KAAKiE,MAAQ,IAAIsQ,EAAahL,GAC9BvJ,KAAK0H,QAAU,IAAIsM,EACnBhU,KAAKqT,OAAS,IAAID,EAClBpT,KAAKkM,cAAiB,EACtBlM,KAAKkB,SAAWlB,KAAK4V,kBAAkBrM,EAAMrI,UAC7ClB,KAAK6V,cAAgBC,KAAKC,MAC1B/V,KAAKgW,gBAAgC,QAAftV,EAAA6I,EAAME,eAAS9I,IAAAD,OAAAC,EAAAD,EAAAuV,kBAAmB,EAExDjW,KAAKkW,cAAgB,EACrBlW,KAAKmW,MAAQrU,EAASsU,UAEtBpW,KAAK0H,QAAQ2L,OAAOC,GAAG,WAAW9R,GAAQxB,KAAKqT,OAAO1L,SAAS,UAAWnG,KAC1ExB,KAAK0H,QAAQ2L,OAAOC,GAAG,eAAe9R,GAAQxB,KAAKqT,OAAO1L,SAAS,cAAenG,KAGtF,KAAA6U,GACI,MAAQC,KAAMC,EAAqB,GAAMvW,KAAKuJ,MAAME,SAAW,CAAE,EAEpC,IAAzBzJ,KAAKkB,SAASE,QACdpB,KAAKuJ,MAAMS,QAAQlG,SAAQ,CAAC0S,EAAGlS,KAC3BtE,KAAKc,KAAK,IAAIoP,EAAiB,CAC3B5L,SACAwJ,cAAeyI,IAChB,IAKf,gBAAAE,CAAiBnS,GACb,GAAIA,EAAS,GAAKA,EAAS,EAAG,MAAM,IAAIgE,MAAM,kBAAkBhE,KAEhEtE,KAAKkW,cAAgB5R,EACrBtE,KAAKqT,OAAO1L,SAAS,aAAc,CAAErD,WAGzC,IAAAxD,CAAKD,GAUD,OATIb,KAAK0W,kBACL1W,KAAKkB,SAASkN,OAAOpO,KAAKkM,aAAe,EAAGlM,KAAKkB,SAASE,OAASpB,KAAKkM,cAE5ElM,KAAKkM,aAAelM,KAAKkB,SAASE,OAClCpB,KAAKkB,SAAS2J,KAAKhK,GACnBA,EAAQV,KAAKH,MACbA,KAAKqT,OAAO1L,SAAS,kBAAmB,CAAE9G,YAC1CA,EAAQC,OACRd,KAAKqT,OAAO1L,SAAS,mBAAoB,CAAE9G,YACpCA,EAGX,IAAAuT,GACI,OAAOpU,KAAKkB,SAASE,OAAS,EAAIpB,KAAKkB,SAASlB,KAAKkB,SAASE,OAAS,GAAK,KAGhF,IAAAuV,GACI,IAAK3W,KAAK0W,iBAAkB,OAAO,KACnC1W,KAAKkM,eACL,MAAM0K,EAAY5W,KAAKkB,SAASlB,KAAKkM,cAKrC,OAJA0K,EAAU9V,OACVd,KAAK0H,QAAQyM,gBACbnU,KAAKqT,OAAO1L,SAAS,eAAgB,CAAE9G,QAAS+V,IAEzCA,EAGX,IAAA5V,GACI,IAAKhB,KAAK6W,iBAAkB,OAAO,KAEnC,MAAMC,EAAY9W,KAAKkB,SAASlB,KAAKkM,cAOrC,OANAlM,KAAK0H,QAAQ4M,cAAcwC,GAC3BA,EAAU9V,OACVhB,KAAKkM,eACLlM,KAAK0H,QAAQyM,gBACbnU,KAAKqT,OAAO1L,SAAS,eAAgB,CAAE9G,QAASiW,IAEzCA,EAGX,WAAAC,CAAYlW,GAER,MAAMqL,EAAelM,KAAKkB,SAASgM,WAAUpH,GAAKA,IAAMjF,IAExD,IAAuB,IAAnBqL,EAAqB,OAAO,EAEhC,GAAIA,IAAiBlM,KAAKkM,aAAc,OAAO,EAE/C,GAAIA,EAAelM,KAAKkM,aAAc,CAClC,KAAOlM,KAAKkM,eAAiBA,GAAgBlM,KAAK0W,kBAC9C1W,KAAK2W,OAET,OAAO,EAEP,KAAO3W,KAAKkM,eAAiBA,GAAgBlM,KAAK6W,kBAC9C7W,KAAKgB,OAET,OAAO,EAIf,cAAA0V,GACI,OAAO1W,KAAKkB,SAASE,OAAS,EAAIpB,KAAKkM,aAG3C,cAAA2K,GACI,OAAO7W,KAAKkM,cAAgB,EAGhC,gBAAA5L,GACI,OAAON,KAAKkM,cAAgB,EAAIlM,KAAKkM,aAAe,EAGxD,cAAA1L,GACI,OAAOsV,KAAKC,MAAQ/V,KAAK6V,cAAgB7V,KAAKgW,eAGlD,aAAAgB,GAEI,KAAOhX,KAAK0W,kBACR1W,KAAK2W,OAGT,OAAOvB,EAAeC,iBAAiBrV,MAG3C,QAAAwL,CAASlH,GACL,OAAOtE,KAAKiE,MAAMC,OAAOI,GAGrB,iBAAAsR,CAAkB1U,SAGtB,GAFAlB,KAAK0H,QAAQuM,SAAU,EAEnB1N,MAAM4D,QAAQjJ,GAAW,CACzB,MAAM+V,EAAiB/V,EAAS2E,KAAIiG,IAChC,MAAMjL,EAAU,IAAIoS,EAAYnH,GAIhC,OAHAjL,EAAQV,KAAKH,MACba,EAAQZ,YAAcD,KAAKkM,aAC3BrL,EAAQC,OACDD,CAAO,IAKlB,IAAyC,KAAnB,QAAlBH,EAAAV,KAAKuJ,MAAME,eAAO9I,IAAAD,OAAAC,EAAAD,EAAEyL,cACpB,IAAK,IAAIhL,EAAI8V,EAAe7V,OAAS,EAAGD,GAAK,IAAKA,EAC9C8V,EAAe9V,GAAGH,OAM1B,OAHAhB,KAAKkM,aAAe+K,EAAe7V,OACnCpB,KAAKkB,SAAW+V,EAChBjX,KAAK0H,QAAQuM,SAAU,EAChBgD,EAKX,OAFAjX,KAAK0H,QAAQuM,SAAU,EAEhB,GAGX,oBAAAiD,GACI,OAAOpP,EAAS8D,qBAAqB5L,OC/KtC,MAAMmX,EAAcrE,EAEdsE,EAAgB"}